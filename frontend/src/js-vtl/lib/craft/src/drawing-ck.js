/**@
* #Color
* @category Graphics
* Draw a solid color for the entity
*/Crafty.c("Color",{_color:"",ready:!0,init:function(){this.bind("Draw",function(e){if(e.type==="DOM"){e.style.background=this._color;e.style.lineHeight=0}else if(e.type==="canvas"){this._color&&(e.ctx.fillStyle=this._color);e.ctx.fillRect(e.pos._x,e.pos._y,e.pos._w,e.pos._h)}})},color:function(e){if(!e)return this._color;this._color=e;this.trigger("Change");return this}});Crafty.c("Tint",{_color:null,_strength:1,init:function(){var e=function(t){var n=t.ctx||Crafty.canvas.context;n.fillStyle=this._color||"rgb(0,0,0)";n.fillRect(t.pos._x,t.pos._y,t.pos._w,t.pos._h)};this.bind("Draw",e).bind("RemoveComponent",function(t){t==="Tint"&&this.unbind("Draw",e)})},tint:function(e,t){this._strength=t;this._color=Crafty.toRGB(e,this._strength);this.trigger("Change");return this}});Crafty.c("Image",{_repeat:"repeat",ready:!1,init:function(){var e=function(e){if(e.type==="canvas"){if(!this.ready||!this._pattern)return;var t=e.ctx;t.fillStyle=this._pattern;t.save();t.translate(e.pos._x,e.pos._y);t.fillRect(0,0,this._w,this._h);t.restore()}else e.type==="DOM"&&this.__image&&(e.style.background="url("+this.__image+") "+this._repeat)};this.bind("Draw",e).bind("RemoveComponent",function(t){t==="Image"&&this.unbind("Draw",e)})},image:function(e,t){this.__image=e;this._repeat=t||"no-repeat";this.img=Crafty.asset(e);if(!this.img){this.img=new Image;Crafty.asset(e,this.img);this.img.src=e;var n=this;this.img.onload=function(){n.has("Canvas")&&(n._pattern=Crafty.canvas.context.createPattern(n.img,n._repeat));n.ready=!0;if(n._repeat==="no-repeat"){n.w=n.img.width;n.h=n.img.height}n.trigger("Change")};return this}this.ready=!0;this.has("Canvas")&&(this._pattern=Crafty.canvas.context.createPattern(this.img,this._repeat));if(this._repeat==="no-repeat"){this.w=this.img.width;this.h=this.img.height}this.trigger("Change");return this}});Crafty.extend({_scenes:[],_current:null,scene:function(e,t,n){if(arguments.length===1){Crafty.viewport.reset();Crafty("2D").each(function(){this.has("Persist")||this.destroy()});this._current!==null&&"uninitialize"in this._scenes[this._current]&&this._scenes[this._current].uninitialize.call(this);this._scenes[e].initialize.call(this);var r=this._current;this._current=e;Crafty.trigger("SceneChange",{oldScene:r,newScene:e});return}this._scenes[e]={};this._scenes[e].initialize=t;typeof n!="undefined"&&(this._scenes[e].uninitialize=n);return},toRGB:function(e,t){var e=e.charAt(0)==="#"?e.substr(1):e,n=[],r;n[0]=parseInt(e.substr(0,2),16);n[1]=parseInt(e.substr(2,2),16);n[2]=parseInt(e.substr(4,2),16);r=t===undefined?"rgb("+n.join(",")+")":"rgba("+n.join(",")+","+t+")";return r}});var DirtyRectangles=function(){function e(e){return e._x}function t(e){return e._x+e._w}function n(e){return e._y}function r(e){return e._y+e._h}function i(i,s){return e(i)<t(s)&&t(i)>e(s)&&n(i)<r(s)&&r(i)>n(s)}function o(){s.x1y1=!1;s.x1y2=!1;s.x2y1=!1;s.x2y2=!1;s.count=0}function u(i,u){o();if(e(u)>=e(i)&&e(u)<=t(i)){if(n(u)>=n(i)&&n(u)<=r(i)){s.x1y1=!0;s.count++}if(r(u)>=n(i)&&r(u)<=r(i)){s.x1y2=!0;s.count++}}if(t(u)>=e(i)&&t(u)<=t(i)){if(n(u)>=n(i)&&n(u)<=r(i)){s.x2y1=!0;s.count++}if(r(u)>=n(i)&&r(u)<=r(i)){s.x2y2=!0;s.count++}}return s.count}function a(i,o){if(s.x1y1&&s.x2y1){o._h-=r(i)-n(o);o._y=r(i);return}if(s.x1y1&&s.x1y2){o._w-=t(i)-e(o);o._x=t(i);return}if(s.x1y2&&s.x2y2){o._h=n(i)-n(o);return}if(s.x2y1&&s.x2y2){o._w=e(i)-e(o);return}}function f(e,n){var i=Math.max(t(e),t(n)),s=Math.max(r(e),r(n));e._x=Math.min(e._x,n._x);e._y=Math.min(e._y,n._y);e._w=i-e._x;e._h=s-e._y}function l(){this.rectangles=[]}var s={};l.prototype.add_rectangle=function(e){function r(){var e,r;for(e=0;e<n.length;e++){r=n[e];t.rectangles.splice(r,1)}}var t=this,n=[],s,o,l,n;for(s=0;s<this.rectangles.length;s++){o=this.rectangles[s];if(i(e,o)){l=u(o,e);switch(l){case 4:n.length>0&&console.error("Dirty rectangle bug");return;case 3:console.error("Impossible corner count");return;case 2:a(o,e);break;case 1:l=u(e,o);switch(l){case 1:f(o,e);n.unshift(s);r();t.add_rectangle(o);return;case 2:a(e,o);break;case 4:n.unshift(s);break;default:console.error("Dirty rectangle bug")}break;case 0:l=u(e,o);switch(l){case 4:n.unshift(s);break;case 3:console.error("Impossible corner count");return;case 2:a(e,o);break;case 1:console.error("Impossible corner count");return}}}}r();this.rectangles.push(e)};return l}();Crafty.DrawManager=function(){var e=[],t=[];return{total2D:Crafty("2D").length,onScreen:function(e){return Crafty.viewport._x+e._x+e._w>0&&Crafty.viewport._y+e._y+e._h>0&&Crafty.viewport._x+e._x<Crafty.viewport.width&&Crafty.viewport._y+e._y<Crafty.viewport.height},merge:function(e){var t=new DirtyRectangles;for(var n=0,r;r=e[n];n++)t.add_rectangle(r);return t.rectangles},add:function(r,i){if(!i){t.push(r);return}var s,o=r._mbr||r,u=i._mbr||i;if(r===i)s=r.mbr()||r.pos();else{s={_x:~~Math.min(o._x,u._x),_y:~~Math.min(o._y,u._y),_w:Math.max(o._w,u._w)+Math.max(o._x,u._x),_h:Math.max(o._h,u._h)+Math.max(o._y,u._y)};s._w=s._w-s._x;s._h=s._h-s._y}if(s._w===0||s._h===0||!this.onScreen(s))return!1;s._x=~~s._x;s._y=~~s._y;s._w=s._w===~~s._w?s._w:s._w+1|0;s._h=s._h===~~s._h?s._h:s._h+1|0;e.push(s);return!0},debug:function(){console.log(e,t)},drawAll:function(e){var e=e||Crafty.viewport.rect(),t=Crafty.map.search(e),n=0,r=t.length,i=Crafty.canvas.context,s;i.clearRect(e._x,e._y,e._w,e._h);t.sort(function(e,t){return e._globalZ-t._globalZ});for(;n<r;n++){s=t[n];if(s._visible&&s.__c.Canvas){s.draw();s._changed=!1}}},boundingRect:function(e){if(!e||!e.length)return;var t=[],n=1,r=e.length,i,s=e[0],o;s=[s._x,s._y,s._x+s._w,s._y+s._h];while(n<r){i=e[n];o=[i._x,i._y,i._x+i._w,i._y+i._h];o[0]<s[0]&&(s[0]=o[0]);o[1]<s[1]&&(s[1]=o[1]);o[2]>s[2]&&(s[2]=o[2]);o[3]>s[3]&&(s[3]=o[3]);n++}o=s;s={_x:o[0],_y:o[1],_w:o[2]-o[0],_h:o[3]-o[1]};return s},draw:function(){if(!e.length&&!t.length)return;var r=0,i=e.length,s=t.length,o,u,a,f,l,c,h,p=[],d=Crafty.canvas.context;for(;r<s;++r)t[r].draw()._changed=!1;t.length=0;if(!i)return;if(i/this.total2D>.6){this.drawAll();e.length=0;return}e=this.merge(e);for(r=0;r<i;++r){o=e[r];if(!o)continue;u=Crafty.map.search(o,!1);l={};for(a=0,f=u.length;a<f;++a){c=u[a];if(l[c[0]]||!c._visible||!c.__c.Canvas)continue;l[c[0]]=!0;p.push({obj:c,rect:o})}d.clearRect(o._x,o._y,o._w,o._h)}p.sort(function(e,t){return e.obj._globalZ-t.obj._globalZ});if(!p.length)return;for(r=0,i=p.length;r<i;++r){c=p[r];o=c.rect;h=c.obj;var v=h._mbr||h,m=o._x-v._x<=0?0:~~(o._x-v._x),g=o._y-v._y<0?0:~~(o._y-v._y),y=~~Math.min(v._w-m,o._w-(v._x-o._x),o._w,v._w),b=~~Math.min(v._h-g,o._h-(v._y-o._y),o._h,v._h);if(b===0||y===0)continue;d.save();d.beginPath();d.moveTo(o._x,o._y);d.lineTo(o._x+o._w,o._y);d.lineTo(o._x+o._w,o._h+o._y);d.lineTo(o._x,o._h+o._y);d.lineTo(o._x,o._y);d.clip();h.draw();d.closePath();d.restore();h._changed=!1}e.length=0;merged={}}}}();