/**@
* #Collision
* @category 2D
* Component to detect collision between any two convex polygons.
*/Crafty.c("Collision",{init:function(){this.requires("2D");var e=this._mbr||this;poly=new Crafty.polygon([0,0],[e._w,0],[e._w,e._h],[0,e._h]);this.map=poly;this.attach(this.map);this.map.shift(e._x,e._y)},collision:function(e){var t=this._mbr||this;e||(e=new Crafty.polygon([0,0],[t._w,0],[t._w,t._h],[0,t._h]));if(arguments.length>1){var n=Array.prototype.slice.call(arguments,0);e=new Crafty.polygon(n)}this.map=e;this.attach(this.map);this.map.shift(t._x,t._y);return this},hit:function(e){var t=this._mbr||this,n=Crafty.map.search(t,!1),r=0,i=n.length,s={},o,u,a,f,l="map"in this&&"containsPoint"in this.map,c=[];if(!i)return!1;for(;r<i;++r){u=n[r];a=u._mbr||u;if(!u)continue;o=u[0];!s[o]&&this[0]!==o&&u.__c[e]&&a._x<t._x+t._w&&a._x+a._w>t._x&&a._y<t._y+t._h&&a._h+a._y>t._y&&(s[o]=u)}for(f in s){u=s[f];if(l&&"map"in u){var h=this._SAT(this.map,u.map);h.obj=u;h.type="SAT";h&&c.push(h)}else c.push({obj:u,type:"MBR"})}return c.length?c:!1},onHit:function(e,t,n){var r=!1;this.bind("EnterFrame",function(){var i=this.hit(e);if(i){r=!0;t.call(this,i)}else if(r){typeof n=="function"&&n.call(this);r=!1}});return this},_SAT:function(e,t){var n=e.points,r=t.points,i=0,s=n.length,o,u=r.length,a={x:0,y:0},f,l,c,h,p,d,v=null,m=null,g=null,y,b,w;for(;i<s;i++){b=n[i==s-1?0:i+1];w=n[i];a.x=-(b[1]-w[1]);a.y=b[0]-w[0];f=Math.sqrt(a.x*a.x+a.y*a.y);a.x/=f;a.y/=f;l=c=-1;h=p=-1;for(o=0;o<s;++o){y=n[o][0]*a.x+n[o][1]*a.y;if(y>h||h===-1)h=y;if(y<l||l===-1)l=y}for(o=0;o<u;++o){y=r[o][0]*a.x+r[o][1]*a.y;if(y>p||p===-1)p=y;if(y<c||c===-1)c=y}if(l<c){d=c-h;a.x=-a.x;a.y=-a.y}else d=l-p;if(d>=0)return!1;if(v===null||d>v){v=d;g={x:a.x,y:a.y}}}for(i=0;i<u;i++){b=r[i==u-1?0:i+1];w=r[i];a.x=-(b[1]-w[1]);a.y=b[0]-w[0];f=Math.sqrt(a.x*a.x+a.y*a.y);a.x/=f;a.y/=f;l=c=-1;h=p=-1;for(o=0;o<s;++o){y=n[o][0]*a.x+n[o][1]*a.y;if(y>h||h===-1)h=y;if(y<l||l===-1)l=y}for(o=0;o<u;++o){y=r[o][0]*a.x+r[o][1]*a.y;if(y>p||p===-1)p=y;if(y<c||c===-1)c=y}if(l<c){d=c-h;a.x=-a.x;a.y=-a.y}else d=l-p;if(d>=0)return!1;if(v===null||d>v)v=d;if(d>m||m===null){m=d;g={x:a.x,y:a.y}}}return{overlap:m,normal:g}}});