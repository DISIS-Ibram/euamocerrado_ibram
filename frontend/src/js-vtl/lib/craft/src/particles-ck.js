/**@
* #Particles
* @category Graphics
* Based on Parcycle by Mr. Speaker, licensed under the MIT, Ported by Leo Koppelkamm
* **This is canvas only & won't do anything if the browser doesn't support it!**
* To see how this works take a look in https://github.com/craftyjs/Crafty/blob/master/src/particles.js
*/Crafty.c("Particles",{init:function(){this._Particles=Crafty.clone(this._Particles)},particles:function(e){if(!Crafty.support.canvas||Crafty.deactivateParticles)return this;var t,n,r,i,s;t=document.createElement("canvas");t.width=Crafty.viewport.width;t.height=Crafty.viewport.height;t.style.position="absolute";Crafty.stage.elem.appendChild(t);n=t.getContext("2d");this._Particles.init(e);this.bind("Remove",function(){Crafty.stage.elem.removeChild(t)}).bind("RemoveComponent",function(e){e==="particles"&&Crafty.stage.elem.removeChild(t)});r=this.x+Crafty.viewport.x;i=this.y+Crafty.viewport.y;this._Particles.position=this._Particles.vectorHelpers.create(r,i);var o={x:Crafty.viewport.x,y:Crafty.viewport.y};this.bind("EnterFrame",function(){r=this.x+Crafty.viewport.x;i=this.y+Crafty.viewport.y;this._Particles.viewportDelta={x:Crafty.viewport.x-o.x,y:Crafty.viewport.y-o.y};o={x:Crafty.viewport.x,y:Crafty.viewport.y};this._Particles.position=this._Particles.vectorHelpers.create(r,i);if(typeof Crafty.DrawManager.boundingRect=="function"){s=Crafty.DrawManager.boundingRect(this._Particles.register);s&&n.clearRect(s._x,s._y,s._w,s._h)}else n.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height);this._Particles.update();this._Particles.render(n)});return this},_Particles:{presets:{maxParticles:150,size:18,sizeRandom:4,speed:1,speedRandom:1.2,lifeSpan:29,lifeSpanRandom:7,angle:65,angleRandom:34,startColour:[255,131,0,1],startColourRandom:[48,50,45,0],endColour:[245,35,0,0],endColourRandom:[60,60,60,0],sharpness:20,sharpnessRandom:10,spread:10,duration:-1,fastMode:!1,gravity:{x:0,y:.1},jitter:0,particles:[],active:!0,particleCount:0,elapsedFrames:0,emissionRate:0,emitCounter:0,particleIndex:0},init:function(e){this.position=this.vectorHelpers.create(0,0);if(typeof e=="undefined")var e={};for(key in this.presets)typeof e[key]!="undefined"?this[key]=e[key]:this[key]=this.presets[key];this.emissionRate=this.maxParticles/this.lifeSpan;this.positionRandom=this.vectorHelpers.create(this.spread,this.spread)},addParticle:function(){if(this.particleCount==this.maxParticles)return!1;var e=new this.particle(this.vectorHelpers);this.initParticle(e);this.particles[this.particleCount]=e;this.particleCount++;return!0},RANDM1TO1:function(){return Math.random()*2-1},initParticle:function(e){e.position.x=this.position.x+this.positionRandom.x*this.RANDM1TO1();e.position.y=this.position.y+this.positionRandom.y*this.RANDM1TO1();var t=(this.angle+this.angleRandom*this.RANDM1TO1())*(Math.PI/180),n=this.vectorHelpers.create(Math.sin(t),-Math.cos(t)),r=this.speed+this.speedRandom*this.RANDM1TO1();e.direction=this.vectorHelpers.multiply(n,r);e.size=this.size+this.sizeRandom*this.RANDM1TO1();e.size=e.size<0?0:~~e.size;e.timeToLive=this.lifeSpan+this.lifeSpanRandom*this.RANDM1TO1();e.sharpness=this.sharpness+this.sharpnessRandom*this.RANDM1TO1();e.sharpness=e.sharpness>100?100:e.sharpness<0?0:e.sharpness;e.sizeSmall=~~(e.size/200*e.sharpness);var i=[this.startColour[0]+this.startColourRandom[0]*this.RANDM1TO1(),this.startColour[1]+this.startColourRandom[1]*this.RANDM1TO1(),this.startColour[2]+this.startColourRandom[2]*this.RANDM1TO1(),this.startColour[3]+this.startColourRandom[3]*this.RANDM1TO1()],s=[this.endColour[0]+this.endColourRandom[0]*this.RANDM1TO1(),this.endColour[1]+this.endColourRandom[1]*this.RANDM1TO1(),this.endColour[2]+this.endColourRandom[2]*this.RANDM1TO1(),this.endColour[3]+this.endColourRandom[3]*this.RANDM1TO1()];e.colour=i;e.deltaColour[0]=(s[0]-i[0])/e.timeToLive;e.deltaColour[1]=(s[1]-i[1])/e.timeToLive;e.deltaColour[2]=(s[2]-i[2])/e.timeToLive;e.deltaColour[3]=(s[3]-i[3])/e.timeToLive},update:function(){if(this.active&&this.emissionRate>0){var e=1/this.emissionRate;this.emitCounter++;while(this.particleCount<this.maxParticles&&this.emitCounter>e){this.addParticle();this.emitCounter-=e}this.elapsedFrames++;this.duration!=-1&&this.duration<this.elapsedFrames&&this.stop()}this.particleIndex=0;this.register=[];var t;while(this.particleIndex<this.particleCount){var n=this.particles[this.particleIndex];if(n.timeToLive>0){n.direction=this.vectorHelpers.add(n.direction,this.gravity);n.position=this.vectorHelpers.add(n.position,n.direction);n.position=this.vectorHelpers.add(n.position,this.viewportDelta);if(this.jitter){n.position.x+=this.jitter*this.RANDM1TO1();n.position.y+=this.jitter*this.RANDM1TO1()}n.timeToLive--;var r=n.colour[0]+=n.deltaColour[0],i=n.colour[1]+=n.deltaColour[1],s=n.colour[2]+=n.deltaColour[2],o=n.colour[3]+=n.deltaColour[3];t=[];t.push("rgba("+(r>255?255:r<0?0:~~r));t.push(i>255?255:i<0?0:~~i);t.push(s>255?255:s<0?0:~~s);t.push((o>1?1:o<0?0:o.toFixed(2))+")");n.drawColour=t.join(",");if(!this.fastMode){t[3]="0)";n.drawColourEnd=t.join(",")}this.particleIndex++}else{this.particleIndex!=this.particleCount-1&&(this.particles[this.particleIndex]=this.particles[this.particleCount-1]);this.particleCount--}var u={};u._x=~~n.position.x;u._y=~~n.position.y;u._w=n.size;u._h=n.size;this.register.push(u)}},stop:function(){this.active=!1;this.elapsedFrames=0;this.emitCounter=0},render:function(e){for(var t=0,n=this.particleCount;t<n;t++){var r=this.particles[t],i=r.size,s=i>>1;if(r.position.x+i<0||r.position.y+i<0||r.position.x-i>Crafty.viewport.width||r.position.y-i>Crafty.viewport.height)continue;var o=~~r.position.x,u=~~r.position.y;if(this.fastMode)e.fillStyle=r.drawColour;else{var a=e.createRadialGradient(o+s,u+s,r.sizeSmall,o+s,u+s,s);a.addColorStop(0,r.drawColour);a.addColorStop(.9,r.drawColourEnd);e.fillStyle=a}e.fillRect(o,u,i,i)}},particle:function(e){this.position=e.create(0,0);this.direction=e.create(0,0);this.size=0;this.sizeSmall=0;this.timeToLive=0;this.colour=[];this.drawColour="";this.deltaColour=[];this.sharpness=0},vectorHelpers:{create:function(e,t){return{x:e,y:t}},multiply:function(e,t){e.x*=t;e.y*=t;return e},add:function(e,t){e.x+=t.x;e.y+=t.y;return e}}}});