Crafty.extend({over:null,mouseObjs:0,mousePos:{},lastEvent:null,keydown:{},selected:!1,detectBlur:function(e){var t=e.clientX>Crafty.stage.x&&e.clientX<Crafty.stage.x+Crafty.viewport.width&&e.clientY>Crafty.stage.y&&e.clientY<Crafty.stage.y+Crafty.viewport.height;!Crafty.selected&&t&&Crafty.trigger("CraftyFocus");Crafty.selected&&!t&&Crafty.trigger("CraftyBlur");Crafty.selected=t},mouseDispatch:function(e){if(!Crafty.mouseObjs)return;Crafty.lastEvent=e;var t=-1,n,r,i=0,s,o=Crafty.DOM.translate(e.clientX,e.clientY),u,a,f={},l=e.target?e.target:e.srcElement,c=e.type;e.which==null?e.mouseButton=e.button<2?Crafty.mouseButtons.LEFT:e.button==4?Crafty.mouseButtons.MIDDLE:Crafty.mouseButtons.RIGHT:e.mouseButton=e.which<2?Crafty.mouseButtons.LEFT:e.which==2?Crafty.mouseButtons.MIDDLE:Crafty.mouseButtons.RIGHT;e.realX=u=Crafty.mousePos.x=o.x;e.realY=a=Crafty.mousePos.y=o.y;if(l.nodeName!="CANVAS"){while(typeof l.id!="string"&&l.id.indexOf("ent")==-1)l=l.parentNode;ent=Crafty(parseInt(l.id.replace("ent","")));ent.has("Mouse")&&ent.isAt(u,a)&&(n=ent)}if(!n){r=Crafty.map.search({_x:u,_y:a,_w:1,_h:1},!1);for(s=r.length;i<s;++i){if(!r[i].__c.Mouse||!r[i]._visible)continue;var h=r[i],p=!1;if(f[h[0]])continue;f[h[0]]=!0;h.mapArea?h.mapArea.containsPoint(u,a)&&(p=!0):h.isAt(u,a)&&(p=!0);if(p&&(h._z>=t||t===-1)){if(h._z===t&&h[0]<n[0])continue;t=h._z;n=h}}}if(n)if(c==="mousedown")n.trigger("MouseDown",e);else if(c==="mouseup")n.trigger("MouseUp",e);else if(c=="dblclick")n.trigger("DoubleClick",e);else if(c=="click")n.trigger("Click",e);else if(c==="mousemove"){n.trigger("MouseMove",e);if(this.over!==n){if(this.over){this.over.trigger("MouseOut",e);this.over=null}this.over=n;n.trigger("MouseOver",e)}}else n.trigger(c,e);else{if(c==="mousemove"&&this.over){this.over.trigger("MouseOut",e);this.over=null}c==="mousedown"?Crafty.viewport.mouselook("start",e):c==="mousemove"?Crafty.viewport.mouselook("drag",e):c=="mouseup"&&Crafty.viewport.mouselook("stop")}c==="mousemove"&&(this.lastEvent=e)},touchDispatch:function(e){var t,n=Crafty.lastEvent;e.type==="touchstart"?t="mousedown":e.type==="touchmove"?t="mousemove":e.type==="touchend"?t="mouseup":e.type==="touchcancel"?t="mouseup":e.type==="touchleave"&&(t="mouseup");e.touches&&e.touches.length?first=e.touches[0]:e.changedTouches&&e.changedTouches.length&&(first=e.changedTouches[0]);var r=document.createEvent("MouseEvent");r.initMouseEvent(t,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,e.relatedTarget);first.target.dispatchEvent(r);if(n!=null&&n.type=="mousedown"&&t=="mouseup"){t="click";var r=document.createEvent("MouseEvent");r.initMouseEvent(t,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,e.relatedTarget);first.target.dispatchEvent(r)}e.preventDefault?e.preventDefault():e.returnValue=!1},keyboardDispatch:function(e){var t=e,n={},r="char charCode keyCode type shiftKey ctrlKey metaKey timestamp".split(" ");for(var i=r.length;i;){var s=r[--i];n[s]=t[s]}n.which=t.charCode!=null?t.charCode:t.keyCode;n.key=t.keyCode||t.which;n.originalEvent=t;e=n;if(e.type==="keydown"){if(Crafty.keydown[e.key]!==!0){Crafty.keydown[e.key]=!0;Crafty.trigger("KeyDown",e)}}else if(e.type==="keyup"){delete Crafty.keydown[e.key];Crafty.trigger("KeyUp",e)}if(Crafty.selected&&!(e.key==8||e.key>=112&&e.key<=135)){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0;e.preventDefault?e.preventDefault():e.returnValue=!1;return!1}}});Crafty.bind("Load",function(){Crafty.addEvent(this,"keydown",Crafty.keyboardDispatch);Crafty.addEvent(this,"keyup",Crafty.keyboardDispatch);Crafty.addEvent(this,Crafty.stage.elem,"mousedown",Crafty.mouseDispatch);Crafty.addEvent(this,Crafty.stage.elem,"mouseup",Crafty.mouseDispatch);Crafty.addEvent(this,document.body,"mouseup",Crafty.detectBlur);Crafty.addEvent(this,Crafty.stage.elem,"mousemove",Crafty.mouseDispatch);Crafty.addEvent(this,Crafty.stage.elem,"click",Crafty.mouseDispatch);Crafty.addEvent(this,Crafty.stage.elem,"dblclick",Crafty.mouseDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchstart",Crafty.touchDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchmove",Crafty.touchDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchend",Crafty.touchDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchcancel",Crafty.touchDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchleave",Crafty.touchDispatch)});Crafty.bind("CraftyStop",function(){Crafty.removeEvent(this,"keydown",Crafty.keyboardDispatch);Crafty.removeEvent(this,"keyup",Crafty.keyboardDispatch);if(Crafty.stage){Crafty.removeEvent(this,Crafty.stage.elem,"mousedown",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"click",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"dblclick",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchstart",Crafty.touchDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchmove",Crafty.touchDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchend",Crafty.touchDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchcancel",Crafty.touchDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchleave",Crafty.touchDispatch)}Crafty.removeEvent(this,document.body,"mouseup",Crafty.detectBlur)});Crafty.c("Mouse",{init:function(){Crafty.mouseObjs++;this.bind("Remove",function(){Crafty.mouseObjs--})},areaMap:function(e){if(arguments.length>1){var t=Array.prototype.slice.call(arguments,0);e=new Crafty.polygon(t)}e.shift(this._x,this._y);this.mapArea=e;this.attach(this.mapArea);return this}});Crafty.c("Draggable",{_origMouseDOMPos:null,_oldX:null,_oldY:null,_dragging:!1,_dir:null,_ondrag:null,_ondown:null,_onup:null,init:function(){this.requires("Mouse");this._ondrag=function(e){var t=Crafty.DOM.translate(e.clientX,e.clientY);if(t.x==0||t.y==0)return!1;if(this._dir){var n=(t.x-this._origMouseDOMPos.x)*this._dir.x+(t.y-this._origMouseDOMPos.y)*this._dir.y;this.x=this._oldX+n*this._dir.x;this.y=this._oldY+n*this._dir.y}else{this.x=this._oldX+(t.x-this._origMouseDOMPos.x);this.y=this._oldY+(t.y-this._origMouseDOMPos.y)}this.trigger("Dragging",e)};this._ondown=function(e){if(e.mouseButton!==Crafty.mouseButtons.LEFT)return;this._startDrag(e)};this._onup=function(t){if(this._dragging==1){Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",this._ondrag);Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",this._onup);this._dragging=!1;this.trigger("StopDrag",t)}};this.enableDrag()},dragDirection:function(e){if(typeof e=="undefined")this._dir=null;else if(""+parseInt(e)==e)this._dir={x:Math.cos(e/180*Math.PI),y:Math.sin(e/180*Math.PI)};else{var t=Math.sqrt(e.x*e.x+e.y*e.y);this._dir={x:e.x/t,y:e.y/t}}},_startDrag:function(e){this._origMouseDOMPos=Crafty.DOM.translate(e.clientX,e.clientY);this._oldX=this._x;this._oldY=this._y;this._dragging=!0;Crafty.addEvent(this,Crafty.stage.elem,"mousemove",this._ondrag);Crafty.addEvent(this,Crafty.stage.elem,"mouseup",this._onup);this.trigger("StartDrag",e)},stopDrag:function(){Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",this._ondrag);Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",this._onup);this._dragging=!1;this.trigger("StopDrag");return this},startDrag:function(){this._dragging||this._startDrag(Crafty.lastEvent);return this},enableDrag:function(){this.bind("MouseDown",this._ondown);Crafty.addEvent(this,Crafty.stage.elem,"mouseup",this._onup);return this},disableDrag:function(){this.unbind("MouseDown",this._ondown);this.stopDrag();return this}});Crafty.c("Keyboard",{isDown:function(e){typeof e=="string"&&(e=Crafty.keys[e]);return!!Crafty.keydown[e]}});Crafty.c("Multiway",{_speed:3,_keydown:function(e){if(this._keys[e.key]){this._movement.x=Math.round((this._movement.x+this._keys[e.key].x)*1e3)/1e3;this._movement.y=Math.round((this._movement.y+this._keys[e.key].y)*1e3)/1e3;this.trigger("NewDirection",this._movement)}},_keyup:function(e){if(this._keys[e.key]){this._movement.x=Math.round((this._movement.x-this._keys[e.key].x)*1e3)/1e3;this._movement.y=Math.round((this._movement.y-this._keys[e.key].y)*1e3)/1e3;this.trigger("NewDirection",this._movement)}},_enterframe:function(){if(this.disableControls)return;if(this._movement.x!==0){this.x+=this._movement.x;this.trigger("Moved",{x:this.x-this._movement.x,y:this.y})}if(this._movement.y!==0){this.y+=this._movement.y;this.trigger("Moved",{x:this.x,y:this.y-this._movement.y})}},multiway:function(e,t){this._keyDirection={};this._keys={};this._movement={x:0,y:0};this._speed={x:3,y:3};if(t)if(e.x&&e.y){this._speed.x=e.x;this._speed.y=e.y}else{this._speed.x=e;this._speed.y=e}else t=e;this._keyDirection=t;this.speed(this._speed);this.disableControl();this.enableControl();for(var n in t)Crafty.keydown[Crafty.keys[n]]&&this.trigger("KeyDown",{key:Crafty.keys[n]});return this},enableControl:function(){this.bind("KeyDown",this._keydown).bind("KeyUp",this._keyup).bind("EnterFrame",this._enterframe);return this},disableControl:function(){this.unbind("KeyDown",this._keydown).unbind("KeyUp",this._keyup).unbind("EnterFrame",this._enterframe);return this},speed:function(e){for(var t in this._keyDirection){var n=Crafty.keys[t]||t;this._keys[n]={x:Math.round(Math.cos(this._keyDirection[t]*(Math.PI/180))*1e3*e.x)/1e3,y:Math.round(Math.sin(this._keyDirection[t]*(Math.PI/180))*1e3*e.y)/1e3}}return this}});Crafty.c("Fourway",{init:function(){this.requires("Multiway")},fourway:function(e){this.multiway(e,{UP_ARROW:-90,DOWN_ARROW:90,RIGHT_ARROW:0,LEFT_ARROW:180,W:-90,S:90,D:0,A:180,Z:-90,Q:180});return this}});Crafty.c("Twoway",{_speed:3,_up:!1,init:function(){this.requires("Fourway, Keyboard")},twoway:function(e,t){this.multiway(e,{RIGHT_ARROW:0,LEFT_ARROW:180,D:0,A:180,Q:180});e&&(this._speed=e);t=t||this._speed*2;this.bind("EnterFrame",function(){if(this.disableControls)return;if(this._up){this.y-=t;this._falling=!0}}).bind("KeyDown",function(){if(this.isDown("UP_ARROW")||this.isDown("W")||this.isDown("Z"))this._up=!0});return this}});