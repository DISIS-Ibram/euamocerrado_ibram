/**@
* #Crafty.map
* @category 2D
* Functions related with querying entities.
* @see Crafty.HashMap
*/Crafty.map=new Crafty.HashMap;var M=Math,Mc=M.cos,Ms=M.sin,PI=M.PI,DEG_TO_RAD=PI/180;Crafty.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_rotation:0,_alpha:1,_visible:!0,_globalZ:null,_origin:null,_mbr:null,_entry:null,_children:null,_parent:null,_changed:!1,_defineGetterSetter_setter:function(){this.__defineSetter__("x",function(e){this._attr("_x",e)});this.__defineSetter__("y",function(e){this._attr("_y",e)});this.__defineSetter__("w",function(e){this._attr("_w",e)});this.__defineSetter__("h",function(e){this._attr("_h",e)});this.__defineSetter__("z",function(e){this._attr("_z",e)});this.__defineSetter__("rotation",function(e){this._attr("_rotation",e)});this.__defineSetter__("alpha",function(e){this._attr("_alpha",e)});this.__defineSetter__("visible",function(e){this._attr("_visible",e)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y});this.__defineGetter__("w",function(){return this._w});this.__defineGetter__("h",function(){return this._h});this.__defineGetter__("z",function(){return this._z});this.__defineGetter__("rotation",function(){return this._rotation});this.__defineGetter__("alpha",function(){return this._alpha});this.__defineGetter__("visible",function(){return this._visible});this.__defineGetter__("parent",function(){return this._parent});this.__defineGetter__("numChildren",function(){return this._children.length})},_defineGetterSetter_defineProperty:function(){Object.defineProperty(this,"x",{set:function(e){this._attr("_x",e)},get:function(){return this._x},configurable:!0});Object.defineProperty(this,"y",{set:function(e){this._attr("_y",e)},get:function(){return this._y},configurable:!0});Object.defineProperty(this,"w",{set:function(e){this._attr("_w",e)},get:function(){return this._w},configurable:!0});Object.defineProperty(this,"h",{set:function(e){this._attr("_h",e)},get:function(){return this._h},configurable:!0});Object.defineProperty(this,"z",{set:function(e){this._attr("_z",e)},get:function(){return this._z},configurable:!0});Object.defineProperty(this,"rotation",{set:function(e){this._attr("_rotation",e)},get:function(){return this._rotation},configurable:!0});Object.defineProperty(this,"alpha",{set:function(e){this._attr("_alpha",e)},get:function(){return this._alpha},configurable:!0});Object.defineProperty(this,"visible",{set:function(e){this._attr("_visible",e)},get:function(){return this._visible},configurable:!0})},_defineGetterSetter_fallback:function(){this.x=this._x;this.y=this._y;this.w=this._w;this.h=this._h;this.z=this._z;this.rotation=this._rotation;this.alpha=this._alpha;this.visible=this._visible;this.bind("EnterFrame",function(){if(this.x!==this._x||this.y!==this._y||this.w!==this._w||this.h!==this._h||this.z!==this._z||this.rotation!==this._rotation||this.alpha!==this._alpha||this.visible!==this._visible){var e=this.mbr()||this.pos();if(this.rotation!==this._rotation)this._rotate(this.rotation);else{var t=this._mbr,n=!1;if(t)if(this.x!==this._x){t._x-=this.x-this._x;n=!0}else if(this.y!==this._y){t._y-=this.y-this._y;n=!0}else if(this.w!==this._w){t._w-=this.w-this._w;n=!0}else if(this.h!==this._h){t._h-=this.h-this._h;n=!0}else if(this.z!==this._z){t._z-=this.z-this._z;n=!0}n&&this.trigger("Move",e)}this._x=this.x;this._y=this.y;this._w=this.w;this._h=this.h;this._z=this.z;this._rotation=this.rotation;this._alpha=this.alpha;this._visible=this.visible;this.trigger("Change",e);this.trigger("Move",e)}})},init:function(){this._globalZ=this[0];this._origin={x:0,y:0};this._children=[];Crafty.support.setter?this._defineGetterSetter_setter():Crafty.support.defineProperty?this._defineGetterSetter_defineProperty():this._defineGetterSetter_fallback();this._entry=Crafty.map.insert(this);this.bind("Move",function(e){var t=this._mbr||this;this._entry.update(t);this._cascade(e)});this.bind("Rotate",function(e){var t=this._mbr||this;this._entry.update(t);this._cascade(e)});this.bind("Remove",function(){if(this._children){for(var e=0;e<this._children.length;e++)this._children[e].destroy&&this._children[e].destroy();this._children=[]}this._parent&&this._parent.detach(this);Crafty.map.remove(this);this.detach()})},_rotate:function(e){var t=-1*(e%360),n=t*DEG_TO_RAD,r=Math.cos(n),i=Math.sin(n),s={x:this._origin.x+this._x,y:this._origin.y+this._y};if(!t){this._mbr=null;if(!this._rotation%360)return}var o=s.x+(this._x-s.x)*r+(this._y-s.y)*i,u=s.y-(this._x-s.x)*i+(this._y-s.y)*r,a=s.x+(this._x+this._w-s.x)*r+(this._y-s.y)*i,f=s.y-(this._x+this._w-s.x)*i+(this._y-s.y)*r,l=s.x+(this._x+this._w-s.x)*r+(this._y+this._h-s.y)*i,c=s.y-(this._x+this._w-s.x)*i+(this._y+this._h-s.y)*r,h=s.x+(this._x-s.x)*r+(this._y+this._h-s.y)*i,p=s.y-(this._x-s.x)*i+(this._y+this._h-s.y)*r,d=Math.round(Math.min(o,a,l,h)),v=Math.round(Math.min(u,f,c,p)),m=Math.round(Math.max(o,a,l,h)),g=Math.round(Math.max(u,f,c,p));this._mbr={_x:d,_y:v,_w:m-d,_h:g-v};var y=this._rotation-e,b=y*DEG_TO_RAD;this.trigger("Rotate",{cos:Math.cos(b),sin:Math.sin(b),deg:y,rad:b,o:{x:s.x,y:s.y},matrix:{M11:r,M12:i,M21:-i,M22:r}})},area:function(){return this._w*this._h},intersect:function(e,t,n,r){var i,s=this._mbr||this;typeof e=="object"?i=e:i={x:e,y:t,w:n,h:r};return s._x<i.x+i.w&&s._x+s._w>i.x&&s._y<i.y+i.h&&s._h+s._y>i.y},within:function(e,t,n,r){var i;typeof e=="object"?i=e:i={x:e,y:t,w:n,h:r};return i.x<=this.x&&i.x+i.w>=this.x+this.w&&i.y<=this.y&&i.y+i.h>=this.y+this.h},contains:function(e,t,n,r){var i;typeof e=="object"?i=e:i={x:e,y:t,w:n,h:r};return i.x>=this.x&&i.x+i.w<=this.x+this.w&&i.y>=this.y&&i.y+i.h<=this.y+this.h},pos:function(){return{_x:this._x,_y:this._y,_w:this._w,_h:this._h}},mbr:function(){return this._mbr?{_x:this._mbr._x,_y:this._mbr._y,_w:this._mbr._w,_h:this._mbr._h}:this.pos()},isAt:function(e,t){return this.mapArea?this.mapArea.containsPoint(e,t):this.map?this.map.containsPoint(e,t):this.x<=e&&this.x+this.w>=e&&this.y<=t&&this.y+this.h>=t},move:function(e,t){e.charAt(0)==="n"&&(this.y-=t);e.charAt(0)==="s"&&(this.y+=t);if(e==="e"||e.charAt(1)==="e")this.x+=t;if(e==="w"||e.charAt(1)==="w")this.x-=t;return this},shift:function(e,t,n,r){e&&(this.x+=e);t&&(this.y+=t);n&&(this.w+=n);r&&(this.h+=r);return this},_cascade:function(e){if(!e)return;var t=0,n=this._children,r=n.length,i;if(e.cos)for(;t<r;++t){i=n[t];"rotate"in i&&i.rotate(e)}else{var s=this._mbr||this,o=s._x-e._x,u=s._y-e._y,a=s._w-e._w,f=s._h-e._h;for(;t<r;++t){i=n[t];i.shift(o,u,a,f)}}},attach:function(){var e=0,t=arguments,n=arguments.length,r;for(;e<n;++e){r=t[e];r._parent&&r._parent.detach(r);r._parent=this;this._children.push(r)}return this},detach:function(e){if(!e){for(var t=0;t<this._children.length;t++)this._children[t]._parent=null;this._children=[];return this}for(var t=0;t<this._children.length;t++)this._children[t]==e&&this._children.splice(t,1);e._parent=null;return this},origin:function(e,t){if(typeof e=="string")if(e==="centre"||e==="center"||e.indexOf(" ")===-1){e=this._w/2;t=this._h/2}else{var n=e.split(" ");if(n[0]==="top")t=0;else if(n[0]==="bottom")t=this._h;else if(n[0]==="middle"||n[1]==="center"||n[1]==="centre")t=this._h/2;n[1]==="center"||n[1]==="centre"||n[1]==="middle"?e=this._w/2:n[1]==="left"?e=0:n[1]==="right"&&(e=this._w)}this._origin.x=e;this._origin.y=t;return this},flip:function(e){e=e||"X";if(!this["_flip"+e]){this["_flip"+e]=!0;this.trigger("Change")}},unflip:function(e){e=e||"X";if(this["_flip"+e]){this["_flip"+e]=!1;this.trigger("Change")}},rotate:function(e){this._origin.x=e.o.x-this._x;this._origin.y=e.o.y-this._y;this._attr("_rotation",e.theta)},_attr:function(e,t){var n=this.pos(),r=this.mbr()||n;if(e==="_rotation"){this._rotate(t);this.trigger("Rotate")}else if(e==="_z"){this._globalZ=parseInt(t+Crafty.zeroFill(this[0],5),10);this.trigger("reorder")}else if(e=="_x"||e==="_y"||e==="_w"||e==="_h"){var i=this._mbr;i&&(i[e]-=this[e]-t);this[e]=t;this.trigger("Move",r)}this[e]=t;this.trigger("Change",r)}});Crafty.c("Physics",{_gravity:.4,_friction:.2,_bounce:.5,gravity:function(e){this._gravity=e}});Crafty.c("Gravity",{_gravityConst:.2,_gy:0,_falling:!0,_anti:null,init:function(){this.requires("2D")},gravity:function(e){e&&(this._anti=e);this.bind("EnterFrame",this._enterFrame);return this},gravityConst:function(e){this._gravityConst=e;return this},_enterFrame:function(){if(this._falling){this._gy+=this._gravityConst;this.y+=this._gy}else this._gy=0;var e,t=!1,n=this.pos(),r,i=0,s;n._y++;n.x=n._x;n.y=n._y;n.w=n._w;n.h=n._h;r=Crafty.map.search(n);s=r.length;for(;i<s;++i){e=r[i];if(e!==this&&e.has(this._anti)&&e.intersect(n)){t=e;break}}t?this._falling&&this.stopFalling(t):this._falling=!0},stopFalling:function(e){e&&(this.y=e._y-this._h);this._falling=!1;this._up&&(this._up=!1);this.trigger("hit")},antigravity:function(){this.unbind("EnterFrame",this._enterFrame)}});Crafty.polygon=function(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments,0));this.points=e};Crafty.polygon.prototype={containsPoint:function(e,t){var n=this.points,r,i,s=!1;for(r=0,i=n.length-1;r<n.length;i=r++)n[r][1]>t!=n[i][1]>t&&e<(n[i][0]-n[r][0])*(t-n[r][1])/(n[i][1]-n[r][1])+n[r][0]&&(s=!s);return s},shift:function(e,t){var n=0,r=this.points.length,i;for(;n<r;n++){i=this.points[n];i[0]+=e;i[1]+=t}},rotate:function(e){var t=0,n=this.points.length,r,i,s;for(;t<n;t++){r=this.points[t];i=e.o.x+(r[0]-e.o.x)*e.cos+(r[1]-e.o.y)*e.sin;s=e.o.y-(r[0]-e.o.x)*e.sin+(r[1]-e.o.y)*e.cos;r[0]=i;r[1]=s}}};Crafty.circle=function(e,t,n){this.x=e;this.y=t;this.radius=n;this.points=[];var r;for(var i=0;i<8;i++){r=i*Math.PI/4;this.points[i]=[this.x+Math.sin(r)*n,this.y+Math.cos(r)*n]}};Crafty.circle.prototype={containsPoint:function(e,t){var n=this.radius,r=Math.sqrt,i=this.x-e,s=this.y-t;return i*i+s*s<n*n},shift:function(e,t){this.x+=e;this.y+=t;var n=0,r=this.points.length,i;for(;n<r;n++){i=this.points[n];i[0]+=e;i[1]+=t}},rotate:function(){}};Crafty.matrix=function(e){this.mtx=e;this.width=e[0].length;this.height=e.length};Crafty.matrix.prototype={x:function(e){if(this.width!=e.height)return;var t=[];for(var n=0;n<this.height;n++){t[n]=[];for(var r=0;r<e.width;r++){var i=0;for(var s=0;s<this.width;s++)i+=this.mtx[n][s]*e.mtx[s][r];t[n][r]=i}}return new Crafty.matrix(t)},e:function(e,t){return e<1||e>this.mtx.length||t<1||t>this.mtx[0].length?null:this.mtx[e-1][t-1]}};