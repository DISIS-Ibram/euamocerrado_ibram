/**
* Spatial HashMap for broad phase collision
*
* @author Louis Stowasser
*/(function(e){function i(e,t,n){this.keys=e;this.map=n;this.obj=t}var t,n=function(e){t=e||64;this.map={}},r=" ";n.prototype={insert:function(e){var t=n.key(e),s=new i(t,e,this),o=0,u,a;for(o=t.x1;o<=t.x2;o++)for(u=t.y1;u<=t.y2;u++){a=o+r+u;this.map[a]||(this.map[a]=[]);this.map[a].push(e)}return s},search:function(e,t){var i=n.key(e),s,o,u,a=[];t===undefined&&(t=!0);for(s=i.x1;s<=i.x2;s++)for(o=i.y1;o<=i.y2;o++){u=s+r+o;this.map[u]&&(a=a.concat(this.map[u]))}if(t){var f,c,h=[],p={};for(s=0,l=a.length;s<l;s++){f=a[s];if(!f)continue;c=f[0];!p[c]&&f.x<e._x+e._w&&f._x+f._w>e._x&&f.y<e._y+e._h&&f._h+f._y>e._y&&(p[c]=a[s])}for(f in p)h.push(p[f]);return h}return a},remove:function(e,t){var i=0,s,o;if(arguments.length==1){t=e;e=n.key(t)}for(i=e.x1;i<=e.x2;i++)for(s=e.y1;s<=e.y2;s++){o=i+r+s;if(this.map[o]){var u=this.map[o],a,f=u.length;for(a=0;a<f;a++)u[a]&&u[a][0]===t[0]&&u.splice(a,1)}}},boundaries:function(){var e,t,n={max:{x:-Infinity,y:-Infinity},min:{x:Infinity,y:Infinity}},i={max:{x:-Infinity,y:-Infinity},min:{x:Infinity,y:Infinity}};for(var s in this.map){if(!this.map[s].length)continue;var o=s.split(r),u=o[0],a=o[0];if(u>=n.max.x){n.max.x=u;for(e in this.map[s]){t=this.map[s][e];typeof t=="object"&&"requires"in t&&(i.max.x=Math.max(i.max.x,t.x+t.w))}}if(u<=n.min.x){n.min.x=u;for(e in this.map[s]){t=this.map[s][e];typeof t=="object"&&"requires"in t&&(i.min.x=Math.min(i.min.x,t.x))}}if(a>=n.max.y){n.max.y=a;for(e in this.map[s]){t=this.map[s][e];typeof t=="object"&&"requires"in t&&(i.max.y=Math.max(i.max.y,t.y+t.h))}}if(a<=n.min.y){n.min.y=a;for(e in this.map[s]){t=this.map[s][e];typeof t=="object"&&"requires"in t&&(i.min.y=Math.min(i.min.y,t.y))}}}return i}};n.key=function(e){e.hasOwnProperty("mbr")&&(e=e.mbr());var n=Math.floor(e._x/t),r=Math.floor(e._y/t),i=Math.floor((e._w+e._x)/t),s=Math.floor((e._h+e._y)/t);return{x1:n,y1:r,x2:i,y2:s}};n.hash=function(e){return e.x1+r+e.y1+r+e.x2+r+e.y2};i.prototype={update:function(e){if(n.hash(n.key(e))!=n.hash(this.keys)){this.map.remove(this.keys,this.obj);var t=this.map.insert(this.obj);this.keys=t.keys}}};e.HashMap=n})(Crafty);