(function(e,t,n){function E(){var e=i++;return e in a?E():e}function S(e){if(e===null||typeof e!="object")return e;var t=e.constructor();for(var n in e)t[n]=S(e[n]);return t}var r=function(e){return new r.fn.init(e)},i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w=function(){i=1;s=50;o=1;u={};a={};entityFactories={};f={};l=[];c;h;p;d=0;v=1e3/s;m=(new Date).getTime();g=Array.prototype.slice;y=/\s*,\s*/;b=/\s+/};w();r.fn=r.prototype={init:function(e){if(typeof e!="string"){if(!e){e=0;e in a||(a[e]=this)}if(e in a){this[0]=e;this.length=1;this.__c||(this.__c={});a[e]||(a[e]=this);return a[e]}this.length=0;return this}var t=0,n,r,i=!1,s=!1,o,f,l,c,h;if(e==="*"){for(n in a){this[+n]=a[n];t++}this.length=t;return this}if(e.indexOf(",")!==-1){s=!0;o=y}else if(e.indexOf(" ")!==-1){i=!0;o=b}for(n in a){if(!a.hasOwnProperty(n))continue;r=a[n];if(i||s){f=e.split(o);c=0;h=f.length;l=0;for(;c<h;c++)r.__c[f[c]]&&l++;if(i&&l===h||s&&l>0)this[t++]=+n}else r.__c[e]&&(this[t++]=+n)}t>0&&!i&&!s&&this.extend(u[e]);if(f&&i)for(c=0;c<h;c++)this.extend(u[f[c]]);this.length=t;return t===1?a[this[t-1]]:this},setName:function(e){var t=String(e);this._entityName=t;this.trigger("NewEntityName",t);return this},addComponent:function(e){var t=[],n=0,r,i=0,s,o;if(arguments.length>1){s=arguments.length;for(;i<s;i++){this.__c[arguments[i]]=!0;t.push(arguments[i])}}else if(e.indexOf(",")!==-1){o=e.split(y);s=o.length;for(;i<s;i++){this.__c[o[i]]=!0;t.push(o[i])}}else{this.__c[e]=!0;t.push(e)}r=t.length;for(;n<r;n++){comp=u[t[n]];this.extend(comp);comp&&"init"in comp&&comp.init.call(this)}this.trigger("NewComponent",r);return this},toggleComponent:function(e){var t=0,n,r;if(arguments.length>1){n=arguments.length;for(;t<n;t++)this.has(arguments[t])?this.removeComponent(arguments[t]):this.addComponent(arguments[t])}else if(e.indexOf(",")!==-1){r=e.split(y);n=r.length;for(;t<n;t++)this.has(r[t])?this.removeComponent(r[t]):this.addComponent(r[t])}else this.has(e)?this.removeComponent(e):this.addComponent(e);return this},requires:function(e){var t=e.split(y),n=0,r=t.length,i;for(;n<r;++n){i=t[n];this.has(i)||this.addComponent(i)}return this},removeComponent:function(e,t){if(t===!1){var n=u[e],r;for(r in n)delete this[r]}delete this.__c[e];this.trigger("RemoveComponent",e);return this},has:function(e){return!!this.__c[e]},attr:function(e,t){if(arguments.length===1){if(typeof e=="string")return this[e];this.extend(e);this.trigger("Change",e);return this}this[e]=t;var n={};n[e]=t;this.trigger("Change",n);return this},toArray:function(){return g.call(this,0)},timeout:function(e,t){this.each(function(){var n=this;setTimeout(function(){e.call(n)},t)});return this},bind:function(e,t){if(this.length===1){f[e]||(f[e]={});var n=f[e];n[this[0]]||(n[this[0]]=[]);n[this[0]].push(t);return this}this.each(function(){f[e]||(f[e]={});var n=f[e];n[this[0]]||(n[this[0]]=[]);n[this[0]].push(t)});return this},unbind:function(e,t){this.each(function(){var n=f[e],r=0,i,s;if(!n||!n[this[0]])return this;i=n[this[0]].length;if(!t){delete n[this[0]];return this}for(;r<i;r++){s=n[this[0]];if(s[r]==t){s.splice(r,1);r--}}});return this},trigger:function(e,t){if(this.length===1){if(f[e]&&f[e][this[0]]){var n=f[e][this[0]],r=0,i=n.length;for(;r<i;r++)n[r].call(this,t)}return this}this.each(function(){if(f[e]&&f[e][this[0]]){var n=f[e][this[0]],r=0,i=n.length;for(;r<i;r++)n[r].call(this,t)}});return this},each:function(e){var t=0,n=this.length;for(;t<n;t++){if(!a[this[t]])continue;e.call(a[this[t]],t)}return this},clone:function(){var e=this.__c,t,n,i=r.e();for(t in e)i.addComponent(t);for(n in this)n!="0"&&n!="_global"&&n!="_changed"&&typeof this[n]!="function"&&typeof this[n]!="object"&&(i[n]=this[n]);return i},setter:function(e,t){r.support.setter?this.__defineSetter__(e,t):r.support.defineProperty?Object.defineProperty(this,e,{set:t,configurable:!0}):p.push({prop:e,obj:this,fn:t});return this},destroy:function(){this.each(function(){this.trigger("Remove");for(var e in f)this.unbind(e);delete a[this[0]]})}};r.fn.init.prototype=r.fn;r.extend=r.fn.extend=function(e){var t=this,n;if(!e)return t;for(n in e){if(t===e[n])continue;t[n]=e[n]}return t};r.extend({init:function(e,t){r.viewport.init(e,t);this.trigger("Load");this.timer.init();return this},getVersion:function(){return"0.5.3"},stop:function(n){this.timer.stop();if(n){if(r.stage&&r.stage.elem.parentNode){var i=document.createElement("div");i.id="cr-stage";r.stage.elem.parentNode.replaceChild(i,r.stage.elem)}w();t(r,e,e.document)}r.trigger("CraftyStop");return this},pause:function(e){if(arguments.length==1?e:!this._paused){this.trigger("Pause");this._paused=!0;setTimeout(function(){r.timer.stop()},0);r.keydown={}}else{this.trigger("Unpause");this._paused=!1;setTimeout(function(){r.timer.init()},0)}return this},isPaused:function(){return this._paused},timer:{prev:+(new Date),current:+(new Date),currentTime:+(new Date),frames:0,frameTime:0,init:function(){var t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||null;if(t){c=function(){r.timer.step();h=t(c)};c()}else c=setInterval(function(){r.timer.step()},1e3/s)},stop:function(){r.trigger("CraftyStopTimer");typeof c=="number"&&clearInterval(c);var t=e.cancelRequestAnimationFrame||e.webkitCancelRequestAnimationFrame||e.mozCancelRequestAnimationFrame||e.oCancelRequestAnimationFrame||e.msCancelRequestAnimationFrame||null;t&&t(h);c=null},step:function(){d=0;this.currentTime=+(new Date);this.currentTime-m>60*v&&(m=this.currentTime-v);while(this.currentTime>m){r.trigger("EnterFrame",{frame:o++});m+=v;d++}d&&r.DrawManager.draw();if(this.currentTime>this.frameTime){r.trigger("MessureFPS",{value:this.frame});this.frame=0;this.frameTime=this.currentTime+1e3}else this.frame++},getFPS:function(){return s},simulateFrames:function(e){while(e-->0)r.trigger("EnterFrame",{frame:o++});r.DrawManager.draw()}},addEntityFactory:function(e,t){this.entityFactories[e]=t},newFactoryEntity:function(e){return this.entityTemplates[e]()},e:function(){var e=E(),t;a[e]=null;a[e]=t=r(e);arguments.length>0&&t.addComponent.apply(t,arguments);t.setName("Entity #"+e);t.addComponent("obj");r.trigger("NewEntity",{id:e});return t},c:function(e,t){u[e]=t},trigger:function(e,t){var n=f[e],i,s,o;for(i in n){if(!n.hasOwnProperty(i))continue;for(s=0,o=n[i].length;s<o;s++)n[i]&&n[i][s]&&(a[i]?n[i][s].call(r(+i),t):n[i][s].call(r,t))}},bind:function(e,t){f[e]||(f[e]={});var n=f[e];n.global||(n.global=[]);return n.global.push(t)-1},unbind:function(e,t){var n=f[e],r,i,s;for(r in n){if(!n.hasOwnProperty(r))continue;if(typeof t=="number"){delete n[r][t];return!0}for(i=0,s=n[r].length;i<s;i++)if(n[r][i]===t){delete n[r][i];return!0}}return!1},frame:function(){return o},components:function(){return u},isComp:function(e){return e in u},debug:function(){return a},settings:function(){var e={},t={};return{register:function(e,n){t[e]=n},modify:function(n,r){if(!t[n])return;t[n].call(e[n],r);e[n]=r},get:function(t){return e[t]}}}(),clone:S});r.bind("Load",function(){if(!r.support.setter&&r.support.defineProperty){p=[];r.bind("EnterFrame",function(){var e=0,t=p.length,n;for(;e<t;++e){n=p[e];n.obj[n.prop]!==n.obj["_"+n.prop]&&n.fn.call(n.obj,n.obj[n.prop])}})}});t(r,e,e.document);e.Crafty=r;typeof define=="function"&&define("crafty",[],function(){return r})})(window,function(Crafty,window,document){function tweenEnterFrame(e){if(this._numProps<=0)return;var t,n;for(n in this._step){t=this._step[n];this[n]+=t.val;if(--t.rem==0){this[n]=t.prop;this.trigger("TweenEnd",n);this._step[n].rem<=0&&delete this._step[n];this._numProps--}}if(this.has("Mouse")){var r=Crafty.over,i=Crafty.mousePos;if(r&&r[0]==this[0]&&!this.isAt(i.x,i.y)){this.trigger("MouseOut",Crafty.lastEvent);Crafty.over=null}else if((!r||r[0]!=this[0])&&this.isAt(i.x,i.y)){Crafty.over=this;this.trigger("MouseOver",Crafty.lastEvent)}}}(function(e){function i(e,t,n){this.keys=e;this.map=n;this.obj=t}var t,n=function(e){t=e||64;this.map={}},r=" ";n.prototype={insert:function(e){var t=n.key(e),s=new i(t,e,this),o=0,u,a;for(o=t.x1;o<=t.x2;o++)for(u=t.y1;u<=t.y2;u++){a=o+r+u;this.map[a]||(this.map[a]=[]);this.map[a].push(e)}return s},search:function(e,t){var i=n.key(e),s,o,u,a=[];t===undefined&&(t=!0);for(s=i.x1;s<=i.x2;s++)for(o=i.y1;o<=i.y2;o++){u=s+r+o;this.map[u]&&(a=a.concat(this.map[u]))}if(t){var f,c,h=[],p={};for(s=0,l=a.length;s<l;s++){f=a[s];if(!f)continue;c=f[0];!p[c]&&f.x<e._x+e._w&&f._x+f._w>e._x&&f.y<e._y+e._h&&f._h+f._y>e._y&&(p[c]=a[s])}for(f in p)h.push(p[f]);return h}return a},remove:function(e,t){var i=0,s,o;if(arguments.length==1){t=e;e=n.key(t)}for(i=e.x1;i<=e.x2;i++)for(s=e.y1;s<=e.y2;s++){o=i+r+s;if(this.map[o]){var u=this.map[o],a,f=u.length;for(a=0;a<f;a++)u[a]&&u[a][0]===t[0]&&u.splice(a,1)}}},boundaries:function(){var e,t,n={max:{x:-Infinity,y:-Infinity},min:{x:Infinity,y:Infinity}},i={max:{x:-Infinity,y:-Infinity},min:{x:Infinity,y:Infinity}};for(var s in this.map){if(!this.map[s].length)continue;var o=s.split(r),u=o[0],a=o[0];if(u>=n.max.x){n.max.x=u;for(e in this.map[s]){t=this.map[s][e];typeof t=="object"&&"requires"in t&&(i.max.x=Math.max(i.max.x,t.x+t.w))}}if(u<=n.min.x){n.min.x=u;for(e in this.map[s]){t=this.map[s][e];typeof t=="object"&&"requires"in t&&(i.min.x=Math.min(i.min.x,t.x))}}if(a>=n.max.y){n.max.y=a;for(e in this.map[s]){t=this.map[s][e];typeof t=="object"&&"requires"in t&&(i.max.y=Math.max(i.max.y,t.y+t.h))}}if(a<=n.min.y){n.min.y=a;for(e in this.map[s]){t=this.map[s][e];typeof t=="object"&&"requires"in t&&(i.min.y=Math.min(i.min.y,t.y))}}}return i}};n.key=function(e){e.hasOwnProperty("mbr")&&(e=e.mbr());var n=Math.floor(e._x/t),r=Math.floor(e._y/t),i=Math.floor((e._w+e._x)/t),s=Math.floor((e._h+e._y)/t);return{x1:n,y1:r,x2:i,y2:s}};n.hash=function(e){return e.x1+r+e.y1+r+e.x2+r+e.y2};i.prototype={update:function(e){if(n.hash(n.key(e))!=n.hash(this.keys)){this.map.remove(this.keys,this.obj);var t=this.map.insert(this.obj);this.keys=t.keys}}};e.HashMap=n})(Crafty);Crafty.map=new Crafty.HashMap;var M=Math,Mc=M.cos,Ms=M.sin,PI=M.PI,DEG_TO_RAD=PI/180;Crafty.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_rotation:0,_alpha:1,_visible:!0,_globalZ:null,_origin:null,_mbr:null,_entry:null,_children:null,_parent:null,_changed:!1,_defineGetterSetter_setter:function(){this.__defineSetter__("x",function(e){this._attr("_x",e)});this.__defineSetter__("y",function(e){this._attr("_y",e)});this.__defineSetter__("w",function(e){this._attr("_w",e)});this.__defineSetter__("h",function(e){this._attr("_h",e)});this.__defineSetter__("z",function(e){this._attr("_z",e)});this.__defineSetter__("rotation",function(e){this._attr("_rotation",e)});this.__defineSetter__("alpha",function(e){this._attr("_alpha",e)});this.__defineSetter__("visible",function(e){this._attr("_visible",e)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y});this.__defineGetter__("w",function(){return this._w});this.__defineGetter__("h",function(){return this._h});this.__defineGetter__("z",function(){return this._z});this.__defineGetter__("rotation",function(){return this._rotation});this.__defineGetter__("alpha",function(){return this._alpha});this.__defineGetter__("visible",function(){return this._visible});this.__defineGetter__("parent",function(){return this._parent});this.__defineGetter__("numChildren",function(){return this._children.length})},_defineGetterSetter_defineProperty:function(){Object.defineProperty(this,"x",{set:function(e){this._attr("_x",e)},get:function(){return this._x},configurable:!0});Object.defineProperty(this,"y",{set:function(e){this._attr("_y",e)},get:function(){return this._y},configurable:!0});Object.defineProperty(this,"w",{set:function(e){this._attr("_w",e)},get:function(){return this._w},configurable:!0});Object.defineProperty(this,"h",{set:function(e){this._attr("_h",e)},get:function(){return this._h},configurable:!0});Object.defineProperty(this,"z",{set:function(e){this._attr("_z",e)},get:function(){return this._z},configurable:!0});Object.defineProperty(this,"rotation",{set:function(e){this._attr("_rotation",e)},get:function(){return this._rotation},configurable:!0});Object.defineProperty(this,"alpha",{set:function(e){this._attr("_alpha",e)},get:function(){return this._alpha},configurable:!0});Object.defineProperty(this,"visible",{set:function(e){this._attr("_visible",e)},get:function(){return this._visible},configurable:!0})},_defineGetterSetter_fallback:function(){this.x=this._x;this.y=this._y;this.w=this._w;this.h=this._h;this.z=this._z;this.rotation=this._rotation;this.alpha=this._alpha;this.visible=this._visible;this.bind("EnterFrame",function(){if(this.x!==this._x||this.y!==this._y||this.w!==this._w||this.h!==this._h||this.z!==this._z||this.rotation!==this._rotation||this.alpha!==this._alpha||this.visible!==this._visible){var e=this.mbr()||this.pos();if(this.rotation!==this._rotation)this._rotate(this.rotation);else{var t=this._mbr,n=!1;if(t)if(this.x!==this._x){t._x-=this.x-this._x;n=!0}else if(this.y!==this._y){t._y-=this.y-this._y;n=!0}else if(this.w!==this._w){t._w-=this.w-this._w;n=!0}else if(this.h!==this._h){t._h-=this.h-this._h;n=!0}else if(this.z!==this._z){t._z-=this.z-this._z;n=!0}n&&this.trigger("Move",e)}this._x=this.x;this._y=this.y;this._w=this.w;this._h=this.h;this._z=this.z;this._rotation=this.rotation;this._alpha=this.alpha;this._visible=this.visible;this.trigger("Change",e);this.trigger("Move",e)}})},init:function(){this._globalZ=this[0];this._origin={x:0,y:0};this._children=[];Crafty.support.setter?this._defineGetterSetter_setter():Crafty.support.defineProperty?this._defineGetterSetter_defineProperty():this._defineGetterSetter_fallback();this._entry=Crafty.map.insert(this);this.bind("Move",function(e){var t=this._mbr||this;this._entry.update(t);this._cascade(e)});this.bind("Rotate",function(e){var t=this._mbr||this;this._entry.update(t);this._cascade(e)});this.bind("Remove",function(){if(this._children){for(var e=0;e<this._children.length;e++)this._children[e].destroy&&this._children[e].destroy();this._children=[]}this._parent&&this._parent.detach(this);Crafty.map.remove(this);this.detach()})},_rotate:function(e){var t=-1*(e%360),n=t*DEG_TO_RAD,r=Math.cos(n),i=Math.sin(n),s={x:this._origin.x+this._x,y:this._origin.y+this._y};if(!t){this._mbr=null;if(!this._rotation%360)return}var o=s.x+(this._x-s.x)*r+(this._y-s.y)*i,u=s.y-(this._x-s.x)*i+(this._y-s.y)*r,a=s.x+(this._x+this._w-s.x)*r+(this._y-s.y)*i,f=s.y-(this._x+this._w-s.x)*i+(this._y-s.y)*r,l=s.x+(this._x+this._w-s.x)*r+(this._y+this._h-s.y)*i,c=s.y-(this._x+this._w-s.x)*i+(this._y+this._h-s.y)*r,h=s.x+(this._x-s.x)*r+(this._y+this._h-s.y)*i,p=s.y-(this._x-s.x)*i+(this._y+this._h-s.y)*r,d=Math.round(Math.min(o,a,l,h)),v=Math.round(Math.min(u,f,c,p)),m=Math.round(Math.max(o,a,l,h)),g=Math.round(Math.max(u,f,c,p));this._mbr={_x:d,_y:v,_w:m-d,_h:g-v};var y=this._rotation-e,b=y*DEG_TO_RAD;this.trigger("Rotate",{cos:Math.cos(b),sin:Math.sin(b),deg:y,rad:b,o:{x:s.x,y:s.y},matrix:{M11:r,M12:i,M21:-i,M22:r}})},area:function(){return this._w*this._h},intersect:function(e,t,n,r){var i,s=this._mbr||this;typeof e=="object"?i=e:i={x:e,y:t,w:n,h:r};return s._x<i.x+i.w&&s._x+s._w>i.x&&s._y<i.y+i.h&&s._h+s._y>i.y},within:function(e,t,n,r){var i;typeof e=="object"?i=e:i={x:e,y:t,w:n,h:r};return i.x<=this.x&&i.x+i.w>=this.x+this.w&&i.y<=this.y&&i.y+i.h>=this.y+this.h},contains:function(e,t,n,r){var i;typeof e=="object"?i=e:i={x:e,y:t,w:n,h:r};return i.x>=this.x&&i.x+i.w<=this.x+this.w&&i.y>=this.y&&i.y+i.h<=this.y+this.h},pos:function(){return{_x:this._x,_y:this._y,_w:this._w,_h:this._h}},mbr:function(){return this._mbr?{_x:this._mbr._x,_y:this._mbr._y,_w:this._mbr._w,_h:this._mbr._h}:this.pos()},isAt:function(e,t){return this.mapArea?this.mapArea.containsPoint(e,t):this.map?this.map.containsPoint(e,t):this.x<=e&&this.x+this.w>=e&&this.y<=t&&this.y+this.h>=t},move:function(e,t){e.charAt(0)==="n"&&(this.y-=t);e.charAt(0)==="s"&&(this.y+=t);if(e==="e"||e.charAt(1)==="e")this.x+=t;if(e==="w"||e.charAt(1)==="w")this.x-=t;return this},shift:function(e,t,n,r){e&&(this.x+=e);t&&(this.y+=t);n&&(this.w+=n);r&&(this.h+=r);return this},_cascade:function(e){if(!e)return;var t=0,n=this._children,r=n.length,i;if(e.cos)for(;t<r;++t){i=n[t];"rotate"in i&&i.rotate(e)}else{var s=this._mbr||this,o=s._x-e._x,u=s._y-e._y,a=s._w-e._w,f=s._h-e._h;for(;t<r;++t){i=n[t];i.shift(o,u,a,f)}}},attach:function(){var e=0,t=arguments,n=arguments.length,r;for(;e<n;++e){r=t[e];r._parent&&r._parent.detach(r);r._parent=this;this._children.push(r)}return this},detach:function(e){if(!e){for(var t=0;t<this._children.length;t++)this._children[t]._parent=null;this._children=[];return this}for(var t=0;t<this._children.length;t++)this._children[t]==e&&this._children.splice(t,1);e._parent=null;return this},origin:function(e,t){if(typeof e=="string")if(e==="centre"||e==="center"||e.indexOf(" ")===-1){e=this._w/2;t=this._h/2}else{var n=e.split(" ");if(n[0]==="top")t=0;else if(n[0]==="bottom")t=this._h;else if(n[0]==="middle"||n[1]==="center"||n[1]==="centre")t=this._h/2;n[1]==="center"||n[1]==="centre"||n[1]==="middle"?e=this._w/2:n[1]==="left"?e=0:n[1]==="right"&&(e=this._w)}this._origin.x=e;this._origin.y=t;return this},flip:function(e){e=e||"X";if(!this["_flip"+e]){this["_flip"+e]=!0;this.trigger("Change")}},unflip:function(e){e=e||"X";if(this["_flip"+e]){this["_flip"+e]=!1;this.trigger("Change")}},rotate:function(e){this._origin.x=e.o.x-this._x;this._origin.y=e.o.y-this._y;this._attr("_rotation",e.theta)},_attr:function(e,t){var n=this.pos(),r=this.mbr()||n;if(e==="_rotation"){this._rotate(t);this.trigger("Rotate")}else if(e==="_z"){this._globalZ=parseInt(t+Crafty.zeroFill(this[0],5),10);this.trigger("reorder")}else if(e=="_x"||e==="_y"||e==="_w"||e==="_h"){var i=this._mbr;i&&(i[e]-=this[e]-t);this[e]=t;this.trigger("Move",r)}this[e]=t;this.trigger("Change",r)}});Crafty.c("Physics",{_gravity:.4,_friction:.2,_bounce:.5,gravity:function(e){this._gravity=e}});Crafty.c("Gravity",{_gravityConst:.2,_gy:0,_falling:!0,_anti:null,init:function(){this.requires("2D")},gravity:function(e){e&&(this._anti=e);this.bind("EnterFrame",this._enterFrame);return this},gravityConst:function(e){this._gravityConst=e;return this},_enterFrame:function(){if(this._falling){this._gy+=this._gravityConst;this.y+=this._gy}else this._gy=0;var e,t=!1,n=this.pos(),r,i=0,s;n._y++;n.x=n._x;n.y=n._y;n.w=n._w;n.h=n._h;r=Crafty.map.search(n);s=r.length;for(;i<s;++i){e=r[i];if(e!==this&&e.has(this._anti)&&e.intersect(n)){t=e;break}}t?this._falling&&this.stopFalling(t):this._falling=!0},stopFalling:function(e){e&&(this.y=e._y-this._h);this._falling=!1;this._up&&(this._up=!1);this.trigger("hit")},antigravity:function(){this.unbind("EnterFrame",this._enterFrame)}});Crafty.polygon=function(e){arguments.length>1&&(e=Array.prototype.slice.call(arguments,0));this.points=e};Crafty.polygon.prototype={containsPoint:function(e,t){var n=this.points,r,i,s=!1;for(r=0,i=n.length-1;r<n.length;i=r++)n[r][1]>t!=n[i][1]>t&&e<(n[i][0]-n[r][0])*(t-n[r][1])/(n[i][1]-n[r][1])+n[r][0]&&(s=!s);return s},shift:function(e,t){var n=0,r=this.points.length,i;for(;n<r;n++){i=this.points[n];i[0]+=e;i[1]+=t}},rotate:function(e){var t=0,n=this.points.length,r,i,s;for(;t<n;t++){r=this.points[t];i=e.o.x+(r[0]-e.o.x)*e.cos+(r[1]-e.o.y)*e.sin;s=e.o.y-(r[0]-e.o.x)*e.sin+(r[1]-e.o.y)*e.cos;r[0]=i;r[1]=s}}};Crafty.circle=function(e,t,n){this.x=e;this.y=t;this.radius=n;this.points=[];var r;for(var i=0;i<8;i++){r=i*Math.PI/4;this.points[i]=[this.x+Math.sin(r)*n,this.y+Math.cos(r)*n]}};Crafty.circle.prototype={containsPoint:function(e,t){var n=this.radius,r=Math.sqrt,i=this.x-e,s=this.y-t;return i*i+s*s<n*n},shift:function(e,t){this.x+=e;this.y+=t;var n=0,r=this.points.length,i;for(;n<r;n++){i=this.points[n];i[0]+=e;i[1]+=t}},rotate:function(){}};Crafty.matrix=function(e){this.mtx=e;this.width=e[0].length;this.height=e.length};Crafty.matrix.prototype={x:function(e){if(this.width!=e.height)return;var t=[];for(var n=0;n<this.height;n++){t[n]=[];for(var r=0;r<e.width;r++){var i=0;for(var s=0;s<this.width;s++)i+=this.mtx[n][s]*e.mtx[s][r];t[n][r]=i}}return new Crafty.matrix(t)},e:function(e,t){return e<1||e>this.mtx.length||t<1||t>this.mtx[0].length?null:this.mtx[e-1][t-1]}};Crafty.c("Collision",{init:function(){this.requires("2D");var e=this._mbr||this;poly=new Crafty.polygon([0,0],[e._w,0],[e._w,e._h],[0,e._h]);this.map=poly;this.attach(this.map);this.map.shift(e._x,e._y)},collision:function(e){var t=this._mbr||this;e||(e=new Crafty.polygon([0,0],[t._w,0],[t._w,t._h],[0,t._h]));if(arguments.length>1){var n=Array.prototype.slice.call(arguments,0);e=new Crafty.polygon(n)}this.map=e;this.attach(this.map);this.map.shift(t._x,t._y);return this},hit:function(e){var t=this._mbr||this,n=Crafty.map.search(t,!1),r=0,i=n.length,s={},o,u,a,f,l="map"in this&&"containsPoint"in this.map,c=[];if(!i)return!1;for(;r<i;++r){u=n[r];a=u._mbr||u;if(!u)continue;o=u[0];!s[o]&&this[0]!==o&&u.__c[e]&&a._x<t._x+t._w&&a._x+a._w>t._x&&a._y<t._y+t._h&&a._h+a._y>t._y&&(s[o]=u)}for(f in s){u=s[f];if(l&&"map"in u){var h=this._SAT(this.map,u.map);h.obj=u;h.type="SAT";h&&c.push(h)}else c.push({obj:u,type:"MBR"})}return c.length?c:!1},onHit:function(e,t,n){var r=!1;this.bind("EnterFrame",function(){var i=this.hit(e);if(i){r=!0;t.call(this,i)}else if(r){typeof n=="function"&&n.call(this);r=!1}});return this},_SAT:function(e,t){var n=e.points,r=t.points,i=0,s=n.length,o,u=r.length,a={x:0,y:0},f,l,c,h,p,d,v=null,m=null,g=null,y,b,w;for(;i<s;i++){b=n[i==s-1?0:i+1];w=n[i];a.x=-(b[1]-w[1]);a.y=b[0]-w[0];f=Math.sqrt(a.x*a.x+a.y*a.y);a.x/=f;a.y/=f;l=c=-1;h=p=-1;for(o=0;o<s;++o){y=n[o][0]*a.x+n[o][1]*a.y;if(y>h||h===-1)h=y;if(y<l||l===-1)l=y}for(o=0;o<u;++o){y=r[o][0]*a.x+r[o][1]*a.y;if(y>p||p===-1)p=y;if(y<c||c===-1)c=y}if(l<c){d=c-h;a.x=-a.x;a.y=-a.y}else d=l-p;if(d>=0)return!1;if(v===null||d>v){v=d;g={x:a.x,y:a.y}}}for(i=0;i<u;i++){b=r[i==u-1?0:i+1];w=r[i];a.x=-(b[1]-w[1]);a.y=b[0]-w[0];f=Math.sqrt(a.x*a.x+a.y*a.y);a.x/=f;a.y/=f;l=c=-1;h=p=-1;for(o=0;o<s;++o){y=n[o][0]*a.x+n[o][1]*a.y;if(y>h||h===-1)h=y;if(y<l||l===-1)l=y}for(o=0;o<u;++o){y=r[o][0]*a.x+r[o][1]*a.y;if(y>p||p===-1)p=y;if(y<c||c===-1)c=y}if(l<c){d=c-h;a.x=-a.x;a.y=-a.y}else d=l-p;if(d>=0)return!1;if(v===null||d>v)v=d;if(d>m||m===null){m=d;g={x:a.x,y:a.y}}}return{overlap:m,normal:g}}});Crafty.c("WiredHitBox",{init:function(){if(Crafty.support.canvas){var e=document.getElementById("HitBox");if(!e){e=document.createElement("canvas");e.id="HitBox";e.width=Crafty.viewport.width;e.height=Crafty.viewport.height;e.style.position="absolute";e.style.left="0px";e.style.top="0px";e.style.zIndex="1000";Crafty.stage.elem.appendChild(e)}var t=e.getContext("2d"),n=0,r=Crafty("WiredHitBox").length;this.requires("Collision").bind("EnterFrame",function(){if(n==r){t.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height);n=0}t.beginPath();for(var e in this.map.points)t.lineTo(Crafty.viewport.x+this.map.points[e][0],Crafty.viewport.y+this.map.points[e][1]);t.closePath();t.stroke();n++})}return this}});Crafty.c("SolidHitBox",{init:function(){if(Crafty.support.canvas){var e=document.getElementById("HitBox");if(!e){e=document.createElement("canvas");e.id="HitBox";e.width=Crafty.viewport.width;e.height=Crafty.viewport.height;e.style.position="absolute";e.style.left="0px";e.style.top="0px";e.style.zIndex="1000";Crafty.stage.elem.appendChild(e)}var t=e.getContext("2d"),n=0,r=Crafty("SolidHitBox").length;this.requires("Collision").bind("EnterFrame",function(){if(n==r){t.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height);n=0}t.beginPath();for(var e in this.map.points)t.lineTo(Crafty.viewport.x+this.map.points[e][0],Crafty.viewport.y+this.map.points[e][1]);t.closePath();t.fill();n++})}return this}});Crafty.c("DOM",{_element:null,_cssStyles:null,init:function(){function e(){var e=0,t=this.__c,n="";for(e in t)n+=" "+e;n=n.substr(1);this._element.className=n}this._cssStyles={visibility:"",left:"",top:"",width:"",height:"",zIndex:"",opacity:"",transformOrigin:"",transform:""};this._element=document.createElement("div");Crafty.stage.inner.appendChild(this._element);this._element.style.position="absolute";this._element.id="ent"+this[0];this.bind("Change",function(){if(!this._changed){this._changed=!0;Crafty.DrawManager.add(this)}});this.bind("NewComponent",e).bind("RemoveComponent",e);if(Crafty.support.prefix==="ms"&&Crafty.support.version<9){this._filters={};this.bind("Rotate",function(e){var t=e.matrix,n=this._element.style,r=t.M11.toFixed(8),i=t.M12.toFixed(8),s=t.M21.toFixed(8),o=t.M22.toFixed(8);this._filters.rotation="progid:DXImageTransform.Microsoft.Matrix(M11="+r+", M12="+i+", M21="+s+", M22="+o+",sizingMethod='auto expand')"})}this.bind("Remove",this.undraw);this.bind("RemoveComponent",function(e){e==="DOM"&&this.undraw()})},getDomId:function(){return this._element.id},DOM:function(e){if(e&&e.nodeType){this.undraw();this._element=e;this._element.style.position="absolute"}return this},draw:function(){var e=this._element.style,t=this.__coord||[0,0,0,0],n={x:t[0],y:t[1]},r=Crafty.support.prefix,i=[];if(this._cssStyles.visibility!=this._visible){this._cssStyles.visibility=this._visible;this._visible?e.visibility="visible":e.visibility="hidden"}if(Crafty.support.css3dtransform)i.push("translate("+~~this._x+"px,"+~~this._y+"px)");else{if(this._cssStyles.left!=this._x){this._cssStyles.left=this._x;e.left=~~this._x+"px"}if(this._cssStyles.top!=this._y){this._cssStyles.top=this._y;e.top=~~this._y+"px"}}if(this._cssStyles.width!=this._w){this._cssStyles.width=this._w;e.width=~~this._w+"px"}if(this._cssStyles.height!=this._h){this._cssStyles.height=this._h;e.height=~~this._h+"px"}if(this._cssStyles.zIndex!=this._z){this._cssStyles.zIndex=this._z;e.zIndex=this._z}if(this._cssStyles.opacity!=this._alpha){this._cssStyles.opacity=this._alpha;e.opacity=this._alpha;e[r+"Opacity"]=this._alpha}r==="ms"&&Crafty.support.version<9&&(Crafty.support.version===8?this._filters.alpha="progid:DXImageTransform.Microsoft.Alpha(Opacity="+this._alpha*100+")":this._filters.alpha="alpha(opacity="+this._alpha*100+")");if(this._mbr){var s=this._origin.x+"px "+this._origin.y+"px";e.transformOrigin=s;e[r+"TransformOrigin"]=s;Crafty.support.css3dtransform?i.push("rotateZ("+this._rotation+"deg)"):i.push("rotate("+this._rotation+"deg)")}if(this._flipX){i.push("scaleX(-1)");r==="ms"&&Crafty.support.version<9&&(this._filters.flipX="fliph")}if(this._flipY){i.push("scaleY(-1)");r==="ms"&&Crafty.support.version<9&&(this._filters.flipY="flipv")}r==="ms"&&Crafty.support.version<9&&this.applyFilters();if(this._cssStyles.transform!=i.join(" ")){this._cssStyles.transform=i.join(" ");e.transform=this._cssStyles.transform;e[r+"Transform"]=this._cssStyles.transform}this.trigger("Draw",{style:e,type:"DOM",co:n});return this},applyFilters:function(){this._element.style.filter="";var e="";for(var t in this._filters){if(!this._filters.hasOwnProperty(t))continue;e+=this._filters[t]+" "}this._element.style.filter=e},undraw:function(){this._element&&Crafty.stage.inner.removeChild(this._element);return this},css:function(e,t){var n,r=this._element,i,s=r.style;if(typeof e=="object")for(n in e){if(!e.hasOwnProperty(n))continue;i=e[n];typeof i=="number"&&(i+="px");s[Crafty.DOM.camelize(n)]=i}else{if(!t)return Crafty.DOM.getStyle(r,e);typeof t=="number"&&(t+="px");s[Crafty.DOM.camelize(e)]=t}this.trigger("Change");return this}});try{document.execCommand("BackgroundImageCache",!1,!0)}catch(e){}Crafty.extend({DOM:{window:{init:function(){this.width=window.innerWidth||window.document.documentElement.clientWidth||window.document.body.clientWidth;this.height=window.innerHeight||window.document.documentElement.clientHeight||window.document.body.clientHeight},width:0,height:0},inner:function(e){var t=e.getBoundingClientRect(),n=t.left+(window.pageXOffset?window.pageXOffset:document.body.scrollLeft),r=t.top+(window.pageYOffset?window.pageYOffset:document.body.scrollTop),i=parseInt(this.getStyle(e,"border-left-width")||0,10)||parseInt(this.getStyle(e,"borderLeftWidth")||0,10)||0,s=parseInt(this.getStyle(e,"border-top-width")||0,10)||parseInt(this.getStyle(e,"borderTopWidth")||0,10)||0;n+=i;r+=s;return{x:n,y:r}},getStyle:function(e,t){var n;e.currentStyle?n=e.currentStyle[this.camelize(t)]:window.getComputedStyle&&(n=document.defaultView.getComputedStyle(e,null).getPropertyValue(this.csselize(t)));return n},camelize:function(e){return e.replace(/-+(.)?/g,function(e,t){return t?t.toUpperCase():""})},csselize:function(e){return e.replace(/[A-Z]/g,function(e){return e?"-"+e.toLowerCase():""})},translate:function(e,t){return{x:(e-Crafty.stage.x+document.body.scrollLeft+document.documentElement.scrollLeft-Crafty.viewport._x)/Crafty.viewport._zoom,y:(t-Crafty.stage.y+document.body.scrollTop+document.documentElement.scrollTop-Crafty.viewport._y)/Crafty.viewport._zoom}}}});Crafty.c("FPS",{values:[],maxValues:60,init:function(){this.bind("MessureFPS",function(e){this.values.length>this.maxValues&&this.values.splice(0,1);this.values.push(e.value)})}});Crafty.c("HTML",{inner:"",init:function(){this.requires("2D, DOM")},replace:function(e){this.inner=e;this._element.innerHTML=e;return this},append:function(e){this.inner+=e;this._element.innerHTML+=e;return this},prepend:function(e){this.inner=e+this.inner;this._element.innerHTML=e+this.inner;return this}});Crafty.storage=function(){function process(e){if(e.c){var t=Crafty.e(e.c).attr(e.attr).trigger("LoadData",e,process);return t}if(typeof e=="object")for(var n in e)e[n]=process(e[n]);return e}function unserialize(str){if(typeof str!="string")return null;var data=JSON?JSON.parse(str):eval("("+str+")");return process(data)}function prep(e){if(e.__c){var t={c:[],attr:{}};e.trigger("SaveData",t,prep);for(var n in e.__c)t.c.push(n);t.c=t.c.join(", ");e=t}else if(typeof e=="object")for(var r in e)e[r]=prep(e[r]);return e}function serialize(e){if(JSON){var t=prep(e);return JSON.stringify(t)}alert("Crafty does not support saving on your browser. Please upgrade to a newer browser.");return!1}function external(e){url=e}function openExternal(){if(typeof url=="undefined")return;var xml=new XMLHttpRequest;xhr.open("POST",url);xhr.onreadystatechange=function(evt){if(xhr.readyState==4&&xhr.status==200){var data=eval("("+xhr.responseText+")");for(var i in data)Crafty.storage.check(data[i].key,data[i].timestamp)&&loadExternal(data[i].key)}};xhr.send("mode=timestamps&game="+gameName)}function saveExternal(e,t,n){if(typeof url=="undefined")return;var r=new XMLHttpRequest;r.open("POST",url);r.send("mode=save&key="+e+"&data="+encodeURIComponent(t)+"&ts="+n+"&game="+gameName)}function loadExternal(key){if(typeof url=="undefined")return;var xhr=new XMLHttpRequest;xhr.open("POST",url);xhr.onreadystatechange=function(evt){if(xhr.readyState==4&&xhr.status==200){var data=eval("("+xhr.responseText+")");Crafty.storage.save(key,"save",data)}};xhr.send("mode=load&key="+key+"&game="+gameName)}function ts(){var e=new Date;return e.getTime()}var db=null,url,gameName,timestamps={},transactionType={READ:"readonly",READ_WRITE:"readwrite"};if(typeof indexedDB!="object"){window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction;if(typeof IDBTransaction=="object"){transactionType.READ=IDBTransaction.READ||IDBTransaction.readonly||transactionType.READ;transactionType.READ_WRITE=IDBTransaction.READ_WRITE||IDBTransaction.readwrite||transactionType.READ_WRITE}}return typeof indexedDB=="object"?{open:function(e){function r(){try{var e=db.transaction(["save"],transactionType.READ),t=e.objectStore("save"),n=t.getAll();n.onsuccess=function(e){var t=0,n=event.target.result,r=n.length;for(;t<r;t++)timestamps[n[t].key]=n[t].timestamp}}catch(r){}}function i(){var e=db.setVersion("1.0");e.onsuccess=function(e){for(var n=0;n<t.length;n++){var r=t[n];if(db.objectStoreNames.contains(r))continue;db.createObjectStore(r,{keyPath:"key"})}}}gameName=e;var t=[];if(arguments.length==1){t.push("save");t.push("cache")}else{t=arguments;t.shift();t.push("save");t.push("cache")}if(db==null){var n=indexedDB.open(gameName);n.onsuccess=function(e){db=e.target.result;i();r();openExternal()}}else{i();r();openExternal()}},save:function(e,t,n){if(db==null){setTimeout(function(){Crafty.storage.save(e,t,n)},1);return}var r=serialize(n),i=ts();t=="save"&&saveExternal(e,r,i);try{var s=db.transaction([t],transactionType.READ_WRITE),o=s.objectStore(t),u=o.put({data:r,timestamp:i,key:e})}catch(a){console.error(a)}},load:function(e,t,n){if(db==null){setTimeout(function(){Crafty.storage.load(e,t,n)},1);return}try{var r=db.transaction([t],transactionType.READ),i=r.objectStore(t),s=i.get(e);s.onsuccess=function(e){n(unserialize(e.target
.result.data))}}catch(o){console.error(o)}},getAllKeys:function(e,t){db==null&&setTimeout(function(){Crafty.storage.getAllkeys(e,t)},1);try{var n=db.transaction([e],transactionType.READ),r=n.objectStore(e),i=r.getCursor(),s=[];i.onsuccess=function(e){var n=e.target.result;if(n){s.push(n.key);n["continue"]()}else t(s)}}catch(o){console.error(o)}},check:function(e,t){return timestamps[e]>t},external:external}:typeof openDatabase=="function"?{open:function(e){gameName=e;if(arguments.length==1)db={save:openDatabase(e+"_save","1.0","Saves games for "+e,5242880),cache:openDatabase(e+"_cache","1.0","Cache for "+e,5242880)};else{var t=arguments,n=0;t.shift();for(;n<t.length;n++)typeof db[t[n]]=="undefined"&&(db[t[n]]=openDatabase(gameName+"_"+t[n],"1.0",type,5242880))}db.save.transaction(function(e){e.executeSql("SELECT key, timestamp FROM data",[],function(e,t){var n=0,r=t.rows,i=r.length;for(;n<i;n++)timestamps[r.item(n).key]=r.item(n).timestamp})})},save:function(e,t,n){typeof db[t]=="undefined"&&gameName!=""&&this.open(gameName,t);var r=serialize(n),i=ts();t=="save"&&saveExternal(e,r,i);db[t].transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS data (key unique, text, timestamp)");t.executeSql("SELECT * FROM data WHERE key = ?",[e],function(t,n){n.rows.length?t.executeSql("UPDATE data SET text = ?, timestamp = ? WHERE key = ?",[r,i,e]):t.executeSql("INSERT INTO data VALUES (?, ?, ?)",[e,r,i])})})},load:function(e,t,n){if(db[t]==null){setTimeout(function(){Crafty.storage.load(e,t,n)},1);return}db[t].transaction(function(t){t.executeSql("SELECT text FROM data WHERE key = ?",[e],function(e,t){if(t.rows.length){res=unserialize(t.rows.item(0).text);n(res)}})})},getAllKeys:function(e,t){if(db[e]==null){setTimeout(function(){Crafty.storage.getAllKeys(e,t)},1);return}db[e].transaction(function(e){e.executeSql("SELECT key FROM data",[],function(e,n){t(n.rows)})})},check:function(e,t){return timestamps[e]>t},external:external}:typeof window.localStorage=="object"?{open:function(e){gameName=e},save:function(e,t,n){var r=gameName+"."+t+"."+e,i=serialize(n),s=ts();t=="save"&&saveExternal(e,i,s);window.localStorage[r]=i;t=="save"&&(window.localStorage[r+".ts"]=s)},load:function(e,t,n){var r=gameName+"."+t+"."+e,i=window.localStorage[r];n(unserialize(i))},getAllKeys:function(e,t){var n={},r=[],i=gameName+"."+e;for(var s in window.localStorage)if(s.indexOf(i)!=-1){var o=s.replace(i,"").replace(".ts","");n[o]=!0}for(s in n)r.push(s);t(r)},check:function(e,t){var n=window.localStorage[gameName+".save."+e+".ts"];return parseInt(t)>parseInt(n)},external:external}:{open:function(e){gameName=e},save:function(e,t,n){if(t!="save")return;var r=serialize(n),i=ts();t=="save"&&saveExternal(e,r,i);document.cookie=gameName+"_"+e+"="+r+"; "+gameName+"_"+e+"_ts="+i+"; expires=Thur, 31 Dec 2099 23:59:59 UTC; path=/"},load:function(e,t,n){if(t!="save")return;var r=new RegExp(gameName+"_"+e+"=[^;]*"),i=r.exec(document.cookie),s=unserialize(i[0].replace(gameName+"_"+e+"=",""));n(s)},getAllKeys:function(e,t){if(e!="save")return;var n=new RegExp(gameName+"_[^_=]","g"),r=n.exec(document.cookie),i=0,s=r.length,o={},u=[];for(;i<s;i++){var a=r[i].replace(gameName+"_","");o[a]=!0}for(i in o)u.push(i);t(u)},check:function(e,t){var n=gameName+"_"+e+"_ts",r=new RegExp(n+"=[^;]"),i=r.exec(document.cookie),s=i[0].replace(n+"=","");return parseInt(t)>parseInt(s)},external:external}}();(function(){var t=Crafty.support={},n=navigator.userAgent.toLowerCase(),r=/(webkit)[ \/]([\w.]+)/.exec(n)||/(o)pera(?:.*version)?[ \/]([\w.]+)/.exec(n)||/(ms)ie ([\w.]+)/.exec(n)||/(moz)illa(?:.*? rv:([\w.]+))?/.exec(n)||[],i=/iPad|iPod|iPhone|Android|webOS|IEMobile/i.exec(n);i&&(Crafty.mobile=i[0]);t.setter="__defineSetter__"in this&&"__defineGetter__"in this;t.defineProperty=function(){if(!1 in Object)return!1;try{Object.defineProperty({},"x",{})}catch(e){return!1}return!0}();t.audio="Audio"in window;t.prefix=r[1]||r[0];t.prefix==="moz"&&(t.prefix="Moz");t.prefix==="o"&&(t.prefix="O");if(r[2]){t.versionName=r[2];t.version=+r[2].split(".")[0]}t.canvas="getContext"in document.createElement("canvas");if(t.canvas){var s;try{s=document.createElement("canvas").getContext("experimental-webgl");s.viewportWidth=t.canvas.width;s.viewportHeight=t.canvas.height}catch(o){}t.webgl=!!s}else t.webgl=!1;t.css3dtransform=typeof document.createElement("div").style.Perspective!="undefined"||typeof document.createElement("div").style[t.prefix+"Perspective"]!="undefined";t.deviceorientation=typeof window.DeviceOrientationEvent!="undefined"||typeof window.OrientationEvent!="undefined";t.devicemotion=typeof window.DeviceMotionEvent!="undefined"})();Crafty.extend({zeroFill:function(e,t){t-=e.toString().length;return t>0?(new Array(t+(/\./.test(e)?2:1))).join("0")+e:e.toString()},sprite:function(e,t,n,r,i,s){var o,u,a,f,l,c,h;if(typeof e=="string"){s=i;i=r;r=t;n=e;e=1;t=1}if(typeof t=="string"){s=i;i=r;r=n;n=t;t=e}!s&&i&&(s=i);i=parseInt(i||0,10);s=parseInt(s||0,10);h=Crafty.asset(n);if(!h){h=new Image;h.src=n;Crafty.asset(n,h);h.onload=function(){for(o in r)Crafty(o).each(function(){this.ready=!0;this.trigger("Change")})}}for(o in r){if(!r.hasOwnProperty(o))continue;u=r[o];a=u[0]*(e+i);f=u[1]*(t+s);l=u[2]*e||e;c=u[3]*t||t;Crafty.c(o,{ready:!1,__coord:[a,f,l,c],init:function(){this.requires("Sprite");this.__trim=[0,0,0,0];this.__image=n;this.__coord=[this.__coord[0],this.__coord[1],this.__coord[2],this.__coord[3]];this.__tile=e;this.__tileh=t;this.__padding=[i,s];this.img=h;if(this.img.complete&&this.img.width>0){this.ready=!0;this.trigger("Change")}this.w=this.__coord[2];this.h=this.__coord[3]}})}return this},_events:{},addEvent:function(e,t,n,r){if(arguments.length===3){r=n;n=t;t=window.document}var i=function(t){var t=t||window.event;typeof r=="function"&&r.call(e,t)},s=e[0]||"";if(!!this._events[s+t+n+r])return;this._events[s+t+n+r]=i;t.attachEvent?t.attachEvent("on"+n,i):t.addEventListener(n,i,!1)},removeEvent:function(e,t,n,r){if(arguments.length===3){r=n;n=t;t=window.document}var i=e[0]||"",s=this._events[i+t+n+r];if(s){t.detachEvent?t.detachEvent("on"+n,s):t.removeEventListener(n,s,!1);delete this._events[i+t+n+r]}},background:function(e){Crafty.stage.elem.style.background=e},viewport:{clampToEntities:!0,width:0,height:0,_x:0,_y:0,bounds:null,scroll:function(e,t){t=Math.floor(t);var n=t-this[e],r=Crafty.canvas.context,i=Crafty.stage.inner.style,s;this[e]=t;if(r){e=="_x"?r.translate(n,0):r.translate(0,n);Crafty.DrawManager.drawAll()}i[e=="_x"?"left":"top"]=t+"px"},rect:function(){return{_x:-this._x,_y:-this._y,_w:this.width,_h:this.height}},pan:function(){function r(n){var r=0;for(t in e){var s=e[t];if(s.remTime>0){s.current+=s.diff;s.remTime--;Crafty.viewport[t]=Math.floor(s.current);r++}else delete e[t]}r&&Crafty.viewport._clamp()}var e={},t,n=!1;return function(s,o,u){Crafty.viewport.follow();if(s=="reset"){for(t in e)e[t].remTime=0;return}u==0&&(u=1);e[s]={diff:-o/u,current:Crafty.viewport[s],remTime:u};if(!n){Crafty.bind("EnterFrame",r);n=!0}}}(),follow:function(){function r(){Crafty.viewport.scroll("_x",-(this.x+this.w/2-Crafty.viewport.width/2-t));Crafty.viewport.scroll("_y",-(this.y+this.h/2-Crafty.viewport.height/2-n));Crafty.viewport._clamp()}var e,t,n;return function(i,s,o){e&&e.unbind("Change",r);if(!i||!i.has("2D"))return;Crafty.viewport.pan("reset");e=i;t=typeof s!="undefined"?s:0;n=typeof o!="undefined"?o:0;i.bind("Change",r);r.call(i)}}(),centerOn:function(e,t){var n=e.x,r=e.y,i=e.w/2,s=e.h/2,o=Crafty.viewport.width/2,u=Crafty.viewport.height/2,a=n+i-o,f=r+s-u;Crafty.viewport.pan("reset");Crafty.viewport.pan("x",a,t);Crafty.viewport.pan("y",f,t)},_zoom:1,zoom:function(){function u(){if(n>0){isFinite(Crafty.viewport._zoom)&&(e=Crafty.viewport._zoom);var i={width:s.width*e,height:s.height*e};e+=t;Crafty.viewport._zoom=e;var u={width:s.width*e,height:s.height*e},a={width:u.width-i.width,height:u.height-i.height};Crafty.stage.inner.style[r]="scale("+e+","+e+")";if(Crafty.canvas._canvas){var f=e/(e-t);Crafty.canvas.context.scale(f,f);Crafty.DrawManager.drawAll()}Crafty.viewport.x-=a.width*o.width;Crafty.viewport.y-=a.height*o.height;n--}}var e=1,t=0,n=0,r=Crafty.support.prefix+"Transform",i=!1,s={},o={};return function(r,a,f,l){var c=this.bounds||Crafty.map.boundaries(),h=r?e*r:1;if(!r){e=1;this._zoom=1}s.width=c.max.x-c.min.x;s.height=c.max.y-c.min.y;o.width=a/s.width;o.height=f/s.height;l==0&&(l=1);t=(h-e)/l;n=l;Crafty.viewport.pan("reset");if(!i){Crafty.bind("EnterFrame",u);i=!0}}}(),scale:function(){var e=Crafty.support.prefix+"Transform",t={};return function(n){var r=this.bounds||Crafty.map.boundaries(),i=n?this._zoom*n:1,s=i/this._zoom;this._zoom=i;t.width=r.max.x-r.min.x;t.height=r.max.y-r.min.y;var o={width:t.width*i,height:t.height*i};Crafty.viewport.pan("reset");Crafty.stage.inner.style.transform=Crafty.stage.inner.style[e]="scale("+this._zoom+","+this._zoom+")";if(Crafty.canvas._canvas){Crafty.canvas.context.scale(s,s);Crafty.DrawManager.drawAll()}}}(),mouselook:function(){var e=!1,t=!1,n={};old={};return function(r,i){if(typeof r=="boolean"){e=r;e?Crafty.mouseObjs++:Crafty.mouseObjs=Math.max(0,Crafty.mouseObjs-1);return}if(!e)return;switch(r){case"move":case"drag":if(!t)return;diff={x:i.clientX-n.x,y:i.clientY-n.y};Crafty.viewport.x+=diff.x;Crafty.viewport.y+=diff.y;Crafty.viewport._clamp();case"start":n.x=i.clientX;n.y=i.clientY;t=!0;break;case"stop":t=!1}}}(),_clamp:function(){if(!this.clampToEntities)return;var e=this.bounds||Crafty.map.boundaries();e.max.x*=this._zoom;e.min.x*=this._zoom;e.max.y*=this._zoom;e.min.y*=this._zoom;if(e.max.x-e.min.x>Crafty.viewport.width){e.max.x-=Crafty.viewport.width;Crafty.viewport.x<-e.max.x?Crafty.viewport.x=-e.max.x:Crafty.viewport.x>-e.min.x&&(Crafty.viewport.x=-e.min.x)}else Crafty.viewport.x=-1*(e.min.x+(e.max.x-e.min.x)/2-Crafty.viewport.width/2);if(e.max.y-e.min.y>Crafty.viewport.height){e.max.y-=Crafty.viewport.height;Crafty.viewport.y<-e.max.y?Crafty.viewport.y=-e.max.y:Crafty.viewport.y>-e.min.y&&(Crafty.viewport.y=-e.min.y)}else Crafty.viewport.y=-1*(e.min.y+(e.max.y-e.min.y)/2-Crafty.viewport.height/2)},init:function(e,t){Crafty.DOM.window.init();this.width=!e||Crafty.mobile?Crafty.DOM.window.width:e;this.height=!t||Crafty.mobile?Crafty.DOM.window.height:t;var n=document.getElementById("cr-stage");Crafty.stage={x:0,y:0,fullscreen:!1,elem:n?n:document.createElement("div"),inner:document.createElement("div")};if(!e&&!t||Crafty.mobile){document.body.style.overflow="hidden";Crafty.stage.fullscreen=!0}Crafty.addEvent(this,window,"resize",Crafty.viewport.reload);Crafty.addEvent(this,window,"blur",function(){Crafty.settings.get("autoPause")&&(Crafty._paused||Crafty.pause())});Crafty.addEvent(this,window,"focus",function(){Crafty._paused&&Crafty.settings.get("autoPause")&&Crafty.pause()});Crafty.settings.register("stageSelectable",function(e){Crafty.stage.elem.onselectstart=e?function(){return!0}:function(){return!1}});Crafty.settings.modify("stageSelectable",!1);Crafty.settings.register("stageContextMenu",function(e){Crafty.stage.elem.oncontextmenu=e?function(){return!0}:function(){return!1}});Crafty.settings.modify("stageContextMenu",!1);Crafty.settings.register("autoPause",function(){});Crafty.settings.modify("autoPause",!1);if(!n){document.body.appendChild(Crafty.stage.elem);Crafty.stage.elem.id="cr-stage"}var r=Crafty.stage.elem.style,i;Crafty.stage.elem.appendChild(Crafty.stage.inner);Crafty.stage.inner.style.position="absolute";Crafty.stage.inner.style.zIndex="1";r.width=this.width+"px";r.height=this.height+"px";r.overflow="hidden";if(Crafty.mobile){r.position="absolute";r.left="0px";r.top="0px";typeof r.webkitTapHighlightColor!=undefined&&(r.webkitTapHighlightColor="rgba(0,0,0,0)");var s=document.createElement("meta"),o=document.getElementsByTagName("HEAD")[0];s.setAttribute("name","viewport");s.setAttribute("content","width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no");o.appendChild(s);s=document.createElement("meta");s.setAttribute("name","apple-mobile-web-app-capable");s.setAttribute("content","yes");o.appendChild(s);setTimeout(function(){window.scrollTo(0,1)},0);Crafty.addEvent(this,window,"touchmove",function(e){e.preventDefault()});Crafty.stage.x=0;Crafty.stage.y=0}else{r.position="relative";i=Crafty.DOM.inner(Crafty.stage.elem);Crafty.stage.x=i.x;Crafty.stage.y=i.y}if(Crafty.support.setter){this.__defineSetter__("x",function(e){this.scroll("_x",e)});this.__defineSetter__("y",function(e){this.scroll("_y",e)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y})}else if(Crafty.support.defineProperty){Object.defineProperty(this,"x",{set:function(e){this.scroll("_x",e)},get:function(){return this._x}});Object.defineProperty(this,"y",{set:function(e){this.scroll("_y",e)},get:function(){return this._y}})}else{this.x=this._x;this.y=this._y;Crafty.e("viewport")}},reload:function(){Crafty.DOM.window.init();var e=Crafty.DOM.window.width,t=Crafty.DOM.window.height,n;if(Crafty.stage.fullscreen){this.width=e;this.height=t;Crafty.stage.elem.style.width=e+"px";Crafty.stage.elem.style.height=t+"px";if(Crafty.canvas._canvas){Crafty.canvas._canvas.width=e;Crafty.canvas._canvas.height=t;Crafty.DrawManager.drawAll()}}n=Crafty.DOM.inner(Crafty.stage.elem);Crafty.stage.x=n.x;Crafty.stage.y=n.y},reset:function(){Crafty.viewport.pan("reset");Crafty.viewport.follow();Crafty.viewport.mouselook("stop");Crafty.viewport.scale()}},keys:{BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190,PULT_UP:29460,PULT_DOWN:29461,PULT_LEFT:4,PULT_RIGHT:5},mouseButtons:{LEFT:0,MIDDLE:1,RIGHT:2}});Crafty.c("viewport",{init:function(){this.bind("EnterFrame",function(){Crafty.viewport._x!==Crafty.viewport.x&&Crafty.viewport.scroll("_x",Crafty.viewport.x);Crafty.viewport._y!==Crafty.viewport.y&&Crafty.viewport.scroll("_y",Crafty.viewport.y)})}});Crafty.extend({device:{_deviceOrientationCallback:!1,_deviceMotionCallback:!1,_normalizeDeviceOrientation:function(e){var t;window.DeviceOrientationEvent?t={tiltLR:e.gamma,tiltFB:e.beta,dir:e.alpha,motUD:null}:window.OrientationEvent&&(t={tiltLR:e.x*90,tiltFB:e.y*-90,dir:null,motUD:e.z});Crafty.device._deviceOrientationCallback(t)},_normalizeDeviceMotion:function(e){var t=e.accelerationIncludingGravity,n=t.z>0?1:-1,r={acceleration:t,rawAcceleration:"["+Math.round(t.x)+", "+Math.round(t.y)+", "+Math.round(t.z)+"]",facingUp:n,tiltLR:Math.round(t.x/9.81*-90),tiltFB:Math.round((t.y+9.81)/9.81*90*n)};Crafty.device._deviceMotionCallback(r)},deviceOrientation:function(e){this._deviceOrientationCallback=e;Crafty.support.deviceorientation&&(window.DeviceOrientationEvent?Crafty.addEvent(this,window,"deviceorientation",this._normalizeDeviceOrientation):window.OrientationEvent&&Crafty.addEvent(this,window,"MozOrientation",this._normalizeDeviceOrientation))},deviceMotion:function(e){this._deviceMotionCallback=e;Crafty.support.devicemotion&&window.DeviceMotionEvent&&Crafty.addEvent(this,window,"devicemotion",this._normalizeDeviceMotion)}}});Crafty.c("Sprite",{__image:"",__tile:0,__tileh:0,__padding:null,__trim:null,img:null,ready:!1,init:function(){this.__trim=[0,0,0,0];var e=function(e){var t=e.co,n=e.pos,r=e.ctx;if(e.type==="canvas")r.drawImage(this.img,t.x,t.y,t.w,t.h,n._x,n._y,n._w,n._h);else if(e.type==="DOM"){this._element.style.background="url('"+this.__image+"') no-repeat -"+t.x+"px -"+t.y+"px";this._element.style.backgroundSize="cover"}};this.bind("Draw",e).bind("RemoveComponent",function(t){t==="Sprite"&&this.unbind("Draw",e)})},sprite:function(e,t,n,r){this.__coord=[e*this.__tile+this.__padding[0]+this.__trim[0],t*this.__tileh+this.__padding[1]+this.__trim[1],this.__trim[2]||n*this.__tile||this.__tile,this.__trim[3]||r*this.__tileh||this.__tileh];this.trigger("Change");return this},crop:function(e,t,n,r){var i=this._mbr||this.pos();this.__trim=[];this.__trim[0]=e;this.__trim[1]=t;this.__trim[2]=n;this.__trim[3]=r;this.__coord[0]+=e;this.__coord[1]+=t;this.__coord[2]=n;this.__coord[3]=r;this._w=n;this._h=r;this.trigger("Change",i);return this}});Crafty.c("Canvas",{init:function(){Crafty.canvas.context||Crafty.canvas.init();Crafty.DrawManager.total2D++;this.bind("Change",function(e){this._changed===!1?this._changed=Crafty.DrawManager.add(e||this,this):e&&(this._changed=Crafty.DrawManager.add(e,this))});this.bind("Remove",function(){Crafty.DrawManager.total2D--;Crafty.DrawManager.add(this,this)})},draw:function(e,t,n,r,i){if(!this.ready)return;if(arguments.length===4){i=r;r=n;n=t;t=e;e=Crafty.canvas.context}var s={_x:this._x+(t||0),_y:this._y+(n||0),_w:r||this._w,_h:i||this._h},o=e||Crafty.canvas.context,u=this.__coord||[0,0,0,0],a={x:u[0]+(t||0),y:u[1]+(n||0),w:r||u[2],h:i||u[3]};if(this._mbr){o.save();o.translate(this._origin.x+this._x,this._origin.y+this._y);s._x=-this._origin.x;s._y=-this._origin.y;o.rotate(this._rotation%360*(Math.PI/180))}if(this._flipX||this._flipY){o.save();o.scale(this._flipX?-1:1,this._flipY?-1:1);this._flipX&&(s._x=-(s._x+s._w));this._flipY&&(s._y=-(s._y+s._h))}if(this._alpha<1){var f=o.globalAlpha;o.globalAlpha=this._alpha}this.trigger("Draw",{type:"canvas",pos:s,co:a,ctx:o});(this._mbr||this._flipX||this._flipY)&&o.restore();f&&(o.globalAlpha=f);return this}});Crafty.extend({canvas:{context:null,init:function(){if(!Crafty.support.canvas){Crafty.trigger("NoCanvas");Crafty.stop();return}var e;e=document.createElement("canvas");e.width=Crafty.viewport.width;e.height=Crafty.viewport.height;e.style.position="absolute";e.style.left="0px";e.style.top="0px";Crafty.stage.elem.appendChild(e);Crafty.canvas.context=e.getContext("2d");Crafty.canvas._canvas=e}}});Crafty.extend({over:null,mouseObjs:0,mousePos:{},lastEvent:null,keydown:{},selected:!1,detectBlur:function(e){var t=e.clientX>Crafty.stage.x&&e.clientX<Crafty.stage.x+Crafty.viewport.width&&e.clientY>Crafty.stage.y&&e.clientY<Crafty.stage.y+Crafty.viewport.height;!Crafty.selected&&t&&Crafty.trigger("CraftyFocus");Crafty.selected&&!t&&Crafty.trigger("CraftyBlur");Crafty.selected=t},mouseDispatch:function(e){if(!Crafty.mouseObjs)return;Crafty.lastEvent=e;var t=-1,n,r,i=0,s,o=Crafty.DOM.translate(e.clientX,e.clientY),u,a,f={},l=e.target?e.target:e.srcElement,c=e.type;e.which==null?e.mouseButton=e.button<2?Crafty.mouseButtons.LEFT:e.button==4?Crafty.mouseButtons.MIDDLE:Crafty.mouseButtons.RIGHT:e.mouseButton=e.which<2?Crafty.mouseButtons.LEFT:e.which==2?Crafty.mouseButtons.MIDDLE:Crafty.mouseButtons.RIGHT;e.realX=u=Crafty.mousePos.x=o.x;e.realY=a=Crafty.mousePos.y=o.y;if(l.nodeName!="CANVAS"){while(typeof l.id!="string"&&l.id.indexOf("ent")==-1)l=l.parentNode;ent=Crafty(parseInt(l.id.replace("ent","")));ent.has("Mouse")&&ent.isAt(u,a)&&(n=ent)}if(!n){r=Crafty.map.search({_x:u,_y:a,_w:1,_h:1},!1);for(s=r.length;i<s;++i){if(!r[i].__c.Mouse||!r[i]._visible)continue;var h=r[i],p=!1;if(f[h[0]])continue;f[h[0]]=!0;h.mapArea?h.mapArea.containsPoint(u,a)&&(p=!0):h.isAt(u,a)&&(p=!0);if(p&&(h._z>=t||t===-1)){if(h._z===t&&h[0]<n[0])continue;t=h._z;n=h}}}if(n)if(c==="mousedown")n.trigger("MouseDown",e);else if(c==="mouseup")n.trigger("MouseUp",e);else if(c=="dblclick")n.trigger("DoubleClick",e);else if(c=="click")n.trigger("Click",e);else if(c==="mousemove"){n.trigger("MouseMove",e);if(this.over!==n){if(this.over){this.over.trigger("MouseOut",e);this.over=null}this.over=n;n.trigger("MouseOver",e)}}else n.trigger(c,e);else{if(c==="mousemove"&&this.over){this.over.trigger("MouseOut",e);this.over=null}c==="mousedown"?Crafty.viewport.mouselook("start",e):c==="mousemove"?Crafty.viewport.mouselook("drag",e):c=="mouseup"&&Crafty.viewport.mouselook("stop")}c==="mousemove"&&(this.lastEvent=e)},touchDispatch:function(e){var t,n=Crafty.lastEvent;e.type==="touchstart"?t="mousedown":e.type==="touchmove"?t="mousemove":e.type==="touchend"?t="mouseup":e.type==="touchcancel"?t="mouseup":e.type==="touchleave"&&(t="mouseup");e.touches&&e.touches.length?first=e.touches[0]:e.changedTouches&&e.changedTouches.length&&(first=e.changedTouches[0]);var r=document.createEvent("MouseEvent");r.initMouseEvent(t,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,e.relatedTarget);first.target.dispatchEvent(r);if(n!=null&&n.type=="mousedown"&&t=="mouseup"){t="click";var r=document.createEvent("MouseEvent");r.initMouseEvent(t,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,e.relatedTarget);first.target.dispatchEvent(r)}e.preventDefault?e.preventDefault():e.returnValue=!1},keyboardDispatch:function(e){var t=e,n={},r="char charCode keyCode type shiftKey ctrlKey metaKey timestamp".split(" ");for(var i=r.length;i;){var s=r[--i];n[s]=t[s]}n.which=t.charCode!=null?t.charCode:t.keyCode;n.key=t.keyCode||t.which;n.originalEvent=t;e=n;if(e.type==="keydown"){if(Crafty.keydown[e.key]!==!0){Crafty.keydown[e.key]=!0;Crafty.trigger("KeyDown",e)}}else if(e.type==="keyup"){delete Crafty.keydown[e.key];Crafty.trigger("KeyUp",e)}if(Crafty.selected&&!(e.key==8||e.key>=112&&e.key<=135)){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0;e.preventDefault?e.preventDefault():e.returnValue=!1;return!1}}});Crafty.bind("Load",function(){Crafty.addEvent(this,"keydown",Crafty.keyboardDispatch);Crafty.addEvent(this,"keyup",Crafty.keyboardDispatch);Crafty.addEvent(this,Crafty.stage.elem,"mousedown",Crafty.mouseDispatch);Crafty.addEvent(this,Crafty.stage.elem,"mouseup",Crafty.mouseDispatch);Crafty.addEvent(this,document.body,"mouseup",Crafty.detectBlur);Crafty.addEvent(this,Crafty.stage.elem,"mousemove",Crafty.mouseDispatch);Crafty.addEvent(this,Crafty.stage.elem,"click",Crafty.mouseDispatch);Crafty.addEvent(this,Crafty.stage.elem,"dblclick",Crafty.mouseDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchstart",Crafty.touchDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchmove",Crafty.touchDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchend",Crafty.touchDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchcancel",Crafty.touchDispatch);Crafty.addEvent(this,Crafty.stage.elem,"touchleave",Crafty.touchDispatch)});Crafty.bind("CraftyStop",function(){Crafty.removeEvent(this,"keydown",Crafty.keyboardDispatch);Crafty.removeEvent(this,"keyup",Crafty.keyboardDispatch);if(Crafty.stage){Crafty.removeEvent(this,Crafty.stage.elem,"mousedown",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"click",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"dblclick",Crafty.mouseDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchstart",Crafty.touchDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchmove",Crafty.touchDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchend",Crafty.touchDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchcancel",Crafty.touchDispatch);Crafty.removeEvent(this,Crafty.stage.elem,"touchleave",Crafty.touchDispatch)}Crafty.removeEvent(this,document.body,"mouseup",Crafty.detectBlur)});Crafty.c("Mouse",{init:function(){Crafty.mouseObjs++;this.bind("Remove",function(){Crafty.mouseObjs--})},areaMap:function(e){if(arguments.length>1){var t=Array.prototype.slice.call(arguments,0);e=new Crafty.polygon(t)}e.shift(this._x,this._y);this.mapArea=e;this.attach(this.mapArea);return this}});Crafty.c("Draggable",{_origMouseDOMPos:null,_oldX:null,_oldY:null,_dragging:!1,_dir:null,_ondrag:null,_ondown:null,_onup:null,init:function(){this.requires("Mouse");this._ondrag=function(e){var t=Crafty.DOM.translate(e.clientX,e.clientY);if(t.x==0||t.y==0)return!1;if(this._dir){var n=(t.x-this._origMouseDOMPos.x)*this._dir.x+(t.y-this._origMouseDOMPos.y)*this._dir.y;this.x=this._oldX+n*this._dir.x;this.y=this._oldY+n*this._dir.y}else{this.x=this._oldX+(t.x-this._origMouseDOMPos.x);this.y=this._oldY+(t.y-this._origMouseDOMPos.y)}this.trigger("Dragging",e)};this._ondown=function(e){if(e.mouseButton!==Crafty.mouseButtons.LEFT)return;this._startDrag(e)};this._onup=function(t){if(this._dragging==1){Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",this._ondrag);Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",this._onup);this._dragging=!1;this.trigger("StopDrag",t)}};this.enableDrag()},dragDirection:function(e){if(typeof e=="undefined")this._dir=null;else if(""+parseInt(e)==e)this._dir={x:Math.cos(e/180*Math.PI),y:Math.sin(e/180*Math.PI)};else{var t=Math.sqrt(e.x*e.x+e.y*e.y);this._dir={x:e.x/t,y:e.y/t}}},_startDrag:function(e){this._origMouseDOMPos=Crafty.DOM.translate(e.clientX,e.clientY);this._oldX=this._x;this._oldY=this._y;this._dragging=!0;Crafty.addEvent(this,Crafty.stage.elem,"mousemove",this._ondrag);Crafty.addEvent(this,Crafty.stage.elem,"mouseup",this._onup);this.trigger("StartDrag",e)},stopDrag:function(){Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",this._ondrag);Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",this._onup);this._dragging=!1;this.trigger("StopDrag");return this},startDrag:function(){this._dragging||this._startDrag(Crafty.lastEvent);return this},enableDrag:function(){this.bind("MouseDown",this._ondown);Crafty.addEvent(this,Crafty.stage.elem,"mouseup",this._onup);return this},disableDrag:function(){this.unbind("MouseDown",this._ondown);this.stopDrag();return this}});Crafty.c("Keyboard",{isDown:function(e){typeof e=="string"&&(e=Crafty.keys[e]);return!!Crafty.keydown[e]}});Crafty.c("Multiway",{_speed:3,_keydown:function(e){if(this._keys[e.key]){this._movement.x=Math.round((this._movement.x+this._keys[e.key].x)*1e3)/1e3;this._movement.y=Math.round((this._movement.y+this._keys[e.key].y)*1e3)/1e3;this.trigger("NewDirection",this._movement)}},_keyup:function(e){if(this._keys[e.key]){this._movement.x=Math.round((this._movement.x-this._keys[e.key].x)*1e3)/1e3;this._movement.y=Math.round((this._movement.y-this._keys[e.key].y)*1e3)/1e3;this.trigger("NewDirection",this._movement)}},_enterframe:function(){if(this.disableControls)return;if(this._movement.x!==0){this.x+=this._movement.x;this.trigger("Moved",{x:this.x-this._movement.x,y:this.y})}if(this._movement.y!==0){this.y+=this._movement.y;this.trigger("Moved",{x:this.x,y:this.y-this._movement.y})}},multiway:function(e,t){this._keyDirection={};this._keys={};this._movement={x:0,y:0};this._speed={x:3,y:3};if(t)if(e.x&&e.y){this._speed.x=e.x;this._speed.y=e.y}else{this._speed.x=e;this._speed.y=e}else t=e;this._keyDirection=t;this.speed(this._speed);this.disableControl();this.enableControl();for(var n in t)Crafty.keydown[Crafty.keys[n]]&&this.trigger("KeyDown",{key:Crafty.keys[n]});return this},enableControl:function(){this.bind("KeyDown",this._keydown).bind("KeyUp",this._keyup).bind("EnterFrame",this._enterframe);return this},disableControl:function(){this.unbind("KeyDown",this._keydown).unbind("KeyUp",this._keyup).unbind("EnterFrame",this._enterframe);return this},speed:function(e){for(var t in this._keyDirection){var n=Crafty.keys[t]||t;this._keys[n]={x:Math.round(Math.cos(this._keyDirection[t]*(Math.PI/180))*1e3*e.x)/1e3,y:Math.round(Math.sin(this._keyDirection[t]*(Math.PI/180))*1e3*e.y)/1e3}}return this}});Crafty.c("Fourway",{init:function(){this.requires("Multiway")},fourway:function(e){this.multiway(e,{UP_ARROW:-90,DOWN_ARROW:90,RIGHT_ARROW:0,LEFT_ARROW:180,W:-90,S:90,D:0,A:180,Z:-90,Q:180});return this}});Crafty.c("Twoway",{_speed:3,_up:!1,init:function(){this.requires("Fourway, Keyboard")},twoway:function(e,t){this.multiway(e,{RIGHT_ARROW:0,LEFT_ARROW:180,D:0,A:180,Q:180});e&&(this._speed=e);t=t||this._speed*2;this.bind("EnterFrame",function(){if(this.disableControls)return;if(this._up){this.y-=t;this._falling=!0}}).bind("KeyDown",function(){if(this.isDown("UP_ARROW")||this.isDown("W")||this.isDown("Z"))this._up=!0});return this}});Crafty.c("Animation",{_reel:null,init:function(){this._reel={}},addAnimation:function(e,t){var n,r=0,i=0,s,o,u,a,f={},l,c,h=[];for(n in t){o=t[n];u=t[r]||this;f={};for(a in o){if(typeof o[a]!="number"){f[a]=o[a];continue}f[a]=(o[a]-u[a])/(n-r)}for(i=+r+1,s=1;i<=+n;++i,++s){c={};for(l in f)typeof f[l]=="number"?c[l]=u[l]+f[l]*s:c[l]=f[l];h[i]=c}r=n}this._reel[e]=h;return this},playAnimation:function(e){var t=this._reel[e],n=0,r=t.length,i;this.bind("EnterFrame",function s(){for(i in t[n])this[i]=t[n][i];n++;if(n>r){this.trigger("AnimationEnd");this.unbind("EnterFrame",s)}})}});Crafty.c("SpriteAnimation",{_reels:null,_frame:null,_currentReelId:null,init:function(){this._reels={}},animate:function(e,t,n,r){var i,s,o,u,a,f;if(arguments.length<4&&typeof t=="number"){a=t;this._currentReelId=e;currentReel=this._reels[e];this._frame={currentReel:currentReel,numberOfFramesBetweenSlides:Math.ceil(a/currentReel.length),currentSlideNumber:0,frameNumberBetweenSlides:0,repeat:0};arguments.length===3&&typeof n=="number"&&(n===-1?this._frame.repeatInfinitly=!0:this._frame.repeat=n);f=this._frame.currentReel[0];this.__coord[0]=f[0];this.__coord[1]=f[1];this.bind("EnterFrame",this.updateSprite);return this}if(typeof t=="number"){o=this.__tile+parseInt(this.__padding[0]||0,10);u=this.__tileh+parseInt(this.__padding[1]||0,10);i=[];s=t;if(r>t)for(;s<=r;s++)i.push([s*o,n*u]);else for(;s>=r;s--)i.push([s*o,n*u]);this._reels[e]=i}else if(typeof t=="object"){s=0;i=[];r=t.length-1;o=this.__tile+parseInt(this.__padding[0]||0,10);u=this.__tileh+parseInt(this.__padding[1]||0,10);for(;s<=r;s++){f=t[s];i.push([f[0]*o,f[1]*u])}this._reels[e]=i}return this},updateSprite:function(){var e=this._frame;if(!e)return;if(this._frame.frameNumberBetweenSlides++===e.numberOfFramesBetweenSlides){var t=e.currentReel[e.currentSlideNumber++];this.__coord[0]=t[0];this.__coord[1]=t[1];this._frame.frameNumberBetweenSlides=0}if(e.currentSlideNumber===e.currentReel.length)if(this._frame.repeatInfinitly===!0||this._frame.repeat>0){this._frame.repeat&&this._frame.repeat--;this._frame.frameNumberBetweenSlides=0;this._frame.currentSlideNumber=0}else if(this._frame.frameNumberBetweenSlides===e.numberOfFramesBetweenSlides){this.trigger("AnimationEnd",{reel:e.currentReel});this.stop();return}this.trigger("Change")},stop:function(){this.unbind("EnterFrame",this.updateSprite);this.unbind("AnimationEnd");this._currentReelId=null;this._frame=null;return this},reset:function(){if(!this._frame)return this;var e=this._frame.currentReel[0];this.__coord[0]=e[0];this.__coord[1]=e[1];this.stop();return this},isPlaying:function(e){return e?this._currentReelId===e:!!this._currentReelId}});Crafty.c("Tween",{_step:null,_numProps:0,tween:function(e,t){this.each(function(){if(this._step==null){this._step={};this.bind("EnterFrame",tweenEnterFrame);this.bind("RemoveComponent",function(e){e=="Tween"&&this.unbind("EnterFrame",tweenEnterFrame)})}for(var n in e){this._step[n]={prop:e[n],val:(e[n]-this[n])/t,rem:t};this._numProps++}});return this}});Crafty.c("Color",{_color:"",ready:!0,init:function(){this.bind("Draw",function(e){if(e.type==="DOM"){e.style.background=this._color;e.style.lineHeight=0}else if(e.type==="canvas"){this._color&&(e.ctx.fillStyle=this._color);e.ctx.fillRect(e.pos._x,e.pos._y,e.pos._w,e.pos._h)}})},color:function(e){if(!e)return this._color;this._color=e;this.trigger("Change");return this}});Crafty.c("Tint",{_color:null,_strength:1,init:function(){var e=function(t){var n=t.ctx||Crafty.canvas.context;n.fillStyle=this._color||"rgb(0,0,0)";n.fillRect(t.pos._x,t.pos._y,t.pos._w,t.pos._h)};this.bind("Draw",e).bind("RemoveComponent",function(t){t==="Tint"&&this.unbind("Draw",e)})},tint:function(e,t){this._strength=t;this._color=Crafty.toRGB(e,this._strength);this.trigger("Change");return this}});Crafty.c("Image",{_repeat:"repeat",ready:!1,init:function(){var e=function(e){if(e.type==="canvas"){if(!this.ready||!this._pattern)return;var t=e.ctx;t.fillStyle=this._pattern;t.save();t.translate(e.pos._x,e.pos._y);t.fillRect(0,0,this._w,this._h);t.restore()}else e.type==="DOM"&&this.__image&&(e.style.background="url("+this.__image+") "+this._repeat)};this.bind("Draw",e).bind("RemoveComponent",function(t){t==="Image"&&this.unbind("Draw",e)})},image:function(e,t){this.__image=e;this._repeat=t||"no-repeat";this.img=Crafty.asset(e);if(!this.img){this.img=new Image;Crafty.asset(e,this.img);this.img.src=e;var n=this;this.img.onload=function(){n.has
("Canvas")&&(n._pattern=Crafty.canvas.context.createPattern(n.img,n._repeat));n.ready=!0;if(n._repeat==="no-repeat"){n.w=n.img.width;n.h=n.img.height}n.trigger("Change")};return this}this.ready=!0;this.has("Canvas")&&(this._pattern=Crafty.canvas.context.createPattern(this.img,this._repeat));if(this._repeat==="no-repeat"){this.w=this.img.width;this.h=this.img.height}this.trigger("Change");return this}});Crafty.extend({_scenes:[],_current:null,scene:function(e,t,n){if(arguments.length===1){Crafty.viewport.reset();Crafty("2D").each(function(){this.has("Persist")||this.destroy()});this._current!==null&&"uninitialize"in this._scenes[this._current]&&this._scenes[this._current].uninitialize.call(this);this._scenes[e].initialize.call(this);var r=this._current;this._current=e;Crafty.trigger("SceneChange",{oldScene:r,newScene:e});return}this._scenes[e]={};this._scenes[e].initialize=t;typeof n!="undefined"&&(this._scenes[e].uninitialize=n);return},toRGB:function(e,t){var e=e.charAt(0)==="#"?e.substr(1):e,n=[],r;n[0]=parseInt(e.substr(0,2),16);n[1]=parseInt(e.substr(2,2),16);n[2]=parseInt(e.substr(4,2),16);r=t===undefined?"rgb("+n.join(",")+")":"rgba("+n.join(",")+","+t+")";return r}});var DirtyRectangles=function(){function e(e){return e._x}function t(e){return e._x+e._w}function n(e){return e._y}function r(e){return e._y+e._h}function i(i,s){return e(i)<t(s)&&t(i)>e(s)&&n(i)<r(s)&&r(i)>n(s)}function o(){s.x1y1=!1;s.x1y2=!1;s.x2y1=!1;s.x2y2=!1;s.count=0}function u(i,u){o();if(e(u)>=e(i)&&e(u)<=t(i)){if(n(u)>=n(i)&&n(u)<=r(i)){s.x1y1=!0;s.count++}if(r(u)>=n(i)&&r(u)<=r(i)){s.x1y2=!0;s.count++}}if(t(u)>=e(i)&&t(u)<=t(i)){if(n(u)>=n(i)&&n(u)<=r(i)){s.x2y1=!0;s.count++}if(r(u)>=n(i)&&r(u)<=r(i)){s.x2y2=!0;s.count++}}return s.count}function a(i,o){if(s.x1y1&&s.x2y1){o._h-=r(i)-n(o);o._y=r(i);return}if(s.x1y1&&s.x1y2){o._w-=t(i)-e(o);o._x=t(i);return}if(s.x1y2&&s.x2y2){o._h=n(i)-n(o);return}if(s.x2y1&&s.x2y2){o._w=e(i)-e(o);return}}function f(e,n){var i=Math.max(t(e),t(n)),s=Math.max(r(e),r(n));e._x=Math.min(e._x,n._x);e._y=Math.min(e._y,n._y);e._w=i-e._x;e._h=s-e._y}function l(){this.rectangles=[]}var s={};l.prototype.add_rectangle=function(e){function r(){var e,r;for(e=0;e<n.length;e++){r=n[e];t.rectangles.splice(r,1)}}var t=this,n=[],s,o,l,n;for(s=0;s<this.rectangles.length;s++){o=this.rectangles[s];if(i(e,o)){l=u(o,e);switch(l){case 4:n.length>0&&console.error("Dirty rectangle bug");return;case 3:console.error("Impossible corner count");return;case 2:a(o,e);break;case 1:l=u(e,o);switch(l){case 1:f(o,e);n.unshift(s);r();t.add_rectangle(o);return;case 2:a(e,o);break;case 4:n.unshift(s);break;default:console.error("Dirty rectangle bug")}break;case 0:l=u(e,o);switch(l){case 4:n.unshift(s);break;case 3:console.error("Impossible corner count");return;case 2:a(e,o);break;case 1:console.error("Impossible corner count");return}}}}r();this.rectangles.push(e)};return l}();Crafty.DrawManager=function(){var e=[],t=[];return{total2D:Crafty("2D").length,onScreen:function(e){return Crafty.viewport._x+e._x+e._w>0&&Crafty.viewport._y+e._y+e._h>0&&Crafty.viewport._x+e._x<Crafty.viewport.width&&Crafty.viewport._y+e._y<Crafty.viewport.height},merge:function(e){var t=new DirtyRectangles;for(var n=0,r;r=e[n];n++)t.add_rectangle(r);return t.rectangles},add:function(r,i){if(!i){t.push(r);return}var s,o=r._mbr||r,u=i._mbr||i;if(r===i)s=r.mbr()||r.pos();else{s={_x:~~Math.min(o._x,u._x),_y:~~Math.min(o._y,u._y),_w:Math.max(o._w,u._w)+Math.max(o._x,u._x),_h:Math.max(o._h,u._h)+Math.max(o._y,u._y)};s._w=s._w-s._x;s._h=s._h-s._y}if(s._w===0||s._h===0||!this.onScreen(s))return!1;s._x=~~s._x;s._y=~~s._y;s._w=s._w===~~s._w?s._w:s._w+1|0;s._h=s._h===~~s._h?s._h:s._h+1|0;e.push(s);return!0},debug:function(){console.log(e,t)},drawAll:function(e){var e=e||Crafty.viewport.rect(),t=Crafty.map.search(e),n=0,r=t.length,i=Crafty.canvas.context,s;i.clearRect(e._x,e._y,e._w,e._h);t.sort(function(e,t){return e._globalZ-t._globalZ});for(;n<r;n++){s=t[n];if(s._visible&&s.__c.Canvas){s.draw();s._changed=!1}}},boundingRect:function(e){if(!e||!e.length)return;var t=[],n=1,r=e.length,i,s=e[0],o;s=[s._x,s._y,s._x+s._w,s._y+s._h];while(n<r){i=e[n];o=[i._x,i._y,i._x+i._w,i._y+i._h];o[0]<s[0]&&(s[0]=o[0]);o[1]<s[1]&&(s[1]=o[1]);o[2]>s[2]&&(s[2]=o[2]);o[3]>s[3]&&(s[3]=o[3]);n++}o=s;s={_x:o[0],_y:o[1],_w:o[2]-o[0],_h:o[3]-o[1]};return s},draw:function(){if(!e.length&&!t.length)return;var r=0,i=e.length,s=t.length,o,u,a,f,l,c,h,p=[],d=Crafty.canvas.context;for(;r<s;++r)t[r].draw()._changed=!1;t.length=0;if(!i)return;if(i/this.total2D>.6){this.drawAll();e.length=0;return}e=this.merge(e);for(r=0;r<i;++r){o=e[r];if(!o)continue;u=Crafty.map.search(o,!1);l={};for(a=0,f=u.length;a<f;++a){c=u[a];if(l[c[0]]||!c._visible||!c.__c.Canvas)continue;l[c[0]]=!0;p.push({obj:c,rect:o})}d.clearRect(o._x,o._y,o._w,o._h)}p.sort(function(e,t){return e.obj._globalZ-t.obj._globalZ});if(!p.length)return;for(r=0,i=p.length;r<i;++r){c=p[r];o=c.rect;h=c.obj;var v=h._mbr||h,m=o._x-v._x<=0?0:~~(o._x-v._x),g=o._y-v._y<0?0:~~(o._y-v._y),y=~~Math.min(v._w-m,o._w-(v._x-o._x),o._w,v._w),b=~~Math.min(v._h-g,o._h-(v._y-o._y),o._h,v._h);if(b===0||y===0)continue;d.save();d.beginPath();d.moveTo(o._x,o._y);d.lineTo(o._x+o._w,o._y);d.lineTo(o._x+o._w,o._h+o._y);d.lineTo(o._x,o._h+o._y);d.lineTo(o._x,o._y);d.clip();h.draw();d.closePath();d.restore();h._changed=!1}e.length=0;merged={}}}}();Crafty.extend({isometric:{_tile:{width:0,height:0},_elements:{},_pos:{x:0,y:0},_z:0,size:function(e,t){this._tile.width=e;this._tile.height=t>0?t:e/2;return this},place:function(e,t,n,r){var i=this.pos2px(e,t);i.top-=n*(this._tile.width/2);r.attr({x:i.left+Crafty.viewport._x,y:i.top+Crafty.viewport._y}).z+=n;return this},pos2px:function(e,t){return{left:e*this._tile.width+(t&1)*(this._tile.width/2),top:t*this._tile.height/2}},px2pos:function(e,t){return{x:Math.ceil(-e/this._tile.width-(t&1)*.5),y:-t/this._tile.height*2}},centerAt:function(e,t){if(typeof e=="number"&&typeof t=="number"){var n=this.pos2px(e,t);Crafty.viewport._x=-n.left+Crafty.viewport.width/2-this._tile.width/2;Crafty.viewport._y=-n.top+Crafty.viewport.height/2-this._tile.height/2;return this}return{top:-Crafty.viewport._y+Crafty.viewport.height/2-this._tile.height/2,left:-Crafty.viewport._x+Crafty.viewport.width/2-this._tile.width/2}},area:function(){var e=this.centerAt(),t=this.px2pos(-e.left+Crafty.viewport.width/2,-e.top+Crafty.viewport.height/2),n=this.px2pos(-e.left-Crafty.viewport.width/2,-e.top-Crafty.viewport.height/2);return{x:{start:t.x,end:n.x},y:{start:t.y,end:n.y}}}}});Crafty.c("Particles",{init:function(){this._Particles=Crafty.clone(this._Particles)},particles:function(e){if(!Crafty.support.canvas||Crafty.deactivateParticles)return this;var t,n,r,i,s;t=document.createElement("canvas");t.width=Crafty.viewport.width;t.height=Crafty.viewport.height;t.style.position="absolute";Crafty.stage.elem.appendChild(t);n=t.getContext("2d");this._Particles.init(e);this.bind("Remove",function(){Crafty.stage.elem.removeChild(t)}).bind("RemoveComponent",function(e){e==="particles"&&Crafty.stage.elem.removeChild(t)});r=this.x+Crafty.viewport.x;i=this.y+Crafty.viewport.y;this._Particles.position=this._Particles.vectorHelpers.create(r,i);var o={x:Crafty.viewport.x,y:Crafty.viewport.y};this.bind("EnterFrame",function(){r=this.x+Crafty.viewport.x;i=this.y+Crafty.viewport.y;this._Particles.viewportDelta={x:Crafty.viewport.x-o.x,y:Crafty.viewport.y-o.y};o={x:Crafty.viewport.x,y:Crafty.viewport.y};this._Particles.position=this._Particles.vectorHelpers.create(r,i);if(typeof Crafty.DrawManager.boundingRect=="function"){s=Crafty.DrawManager.boundingRect(this._Particles.register);s&&n.clearRect(s._x,s._y,s._w,s._h)}else n.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height);this._Particles.update();this._Particles.render(n)});return this},_Particles:{presets:{maxParticles:150,size:18,sizeRandom:4,speed:1,speedRandom:1.2,lifeSpan:29,lifeSpanRandom:7,angle:65,angleRandom:34,startColour:[255,131,0,1],startColourRandom:[48,50,45,0],endColour:[245,35,0,0],endColourRandom:[60,60,60,0],sharpness:20,sharpnessRandom:10,spread:10,duration:-1,fastMode:!1,gravity:{x:0,y:.1},jitter:0,particles:[],active:!0,particleCount:0,elapsedFrames:0,emissionRate:0,emitCounter:0,particleIndex:0},init:function(e){this.position=this.vectorHelpers.create(0,0);if(typeof e=="undefined")var e={};for(key in this.presets)typeof e[key]!="undefined"?this[key]=e[key]:this[key]=this.presets[key];this.emissionRate=this.maxParticles/this.lifeSpan;this.positionRandom=this.vectorHelpers.create(this.spread,this.spread)},addParticle:function(){if(this.particleCount==this.maxParticles)return!1;var e=new this.particle(this.vectorHelpers);this.initParticle(e);this.particles[this.particleCount]=e;this.particleCount++;return!0},RANDM1TO1:function(){return Math.random()*2-1},initParticle:function(e){e.position.x=this.position.x+this.positionRandom.x*this.RANDM1TO1();e.position.y=this.position.y+this.positionRandom.y*this.RANDM1TO1();var t=(this.angle+this.angleRandom*this.RANDM1TO1())*(Math.PI/180),n=this.vectorHelpers.create(Math.sin(t),-Math.cos(t)),r=this.speed+this.speedRandom*this.RANDM1TO1();e.direction=this.vectorHelpers.multiply(n,r);e.size=this.size+this.sizeRandom*this.RANDM1TO1();e.size=e.size<0?0:~~e.size;e.timeToLive=this.lifeSpan+this.lifeSpanRandom*this.RANDM1TO1();e.sharpness=this.sharpness+this.sharpnessRandom*this.RANDM1TO1();e.sharpness=e.sharpness>100?100:e.sharpness<0?0:e.sharpness;e.sizeSmall=~~(e.size/200*e.sharpness);var i=[this.startColour[0]+this.startColourRandom[0]*this.RANDM1TO1(),this.startColour[1]+this.startColourRandom[1]*this.RANDM1TO1(),this.startColour[2]+this.startColourRandom[2]*this.RANDM1TO1(),this.startColour[3]+this.startColourRandom[3]*this.RANDM1TO1()],s=[this.endColour[0]+this.endColourRandom[0]*this.RANDM1TO1(),this.endColour[1]+this.endColourRandom[1]*this.RANDM1TO1(),this.endColour[2]+this.endColourRandom[2]*this.RANDM1TO1(),this.endColour[3]+this.endColourRandom[3]*this.RANDM1TO1()];e.colour=i;e.deltaColour[0]=(s[0]-i[0])/e.timeToLive;e.deltaColour[1]=(s[1]-i[1])/e.timeToLive;e.deltaColour[2]=(s[2]-i[2])/e.timeToLive;e.deltaColour[3]=(s[3]-i[3])/e.timeToLive},update:function(){if(this.active&&this.emissionRate>0){var e=1/this.emissionRate;this.emitCounter++;while(this.particleCount<this.maxParticles&&this.emitCounter>e){this.addParticle();this.emitCounter-=e}this.elapsedFrames++;this.duration!=-1&&this.duration<this.elapsedFrames&&this.stop()}this.particleIndex=0;this.register=[];var t;while(this.particleIndex<this.particleCount){var n=this.particles[this.particleIndex];if(n.timeToLive>0){n.direction=this.vectorHelpers.add(n.direction,this.gravity);n.position=this.vectorHelpers.add(n.position,n.direction);n.position=this.vectorHelpers.add(n.position,this.viewportDelta);if(this.jitter){n.position.x+=this.jitter*this.RANDM1TO1();n.position.y+=this.jitter*this.RANDM1TO1()}n.timeToLive--;var r=n.colour[0]+=n.deltaColour[0],i=n.colour[1]+=n.deltaColour[1],s=n.colour[2]+=n.deltaColour[2],o=n.colour[3]+=n.deltaColour[3];t=[];t.push("rgba("+(r>255?255:r<0?0:~~r));t.push(i>255?255:i<0?0:~~i);t.push(s>255?255:s<0?0:~~s);t.push((o>1?1:o<0?0:o.toFixed(2))+")");n.drawColour=t.join(",");if(!this.fastMode){t[3]="0)";n.drawColourEnd=t.join(",")}this.particleIndex++}else{this.particleIndex!=this.particleCount-1&&(this.particles[this.particleIndex]=this.particles[this.particleCount-1]);this.particleCount--}var u={};u._x=~~n.position.x;u._y=~~n.position.y;u._w=n.size;u._h=n.size;this.register.push(u)}},stop:function(){this.active=!1;this.elapsedFrames=0;this.emitCounter=0},render:function(e){for(var t=0,n=this.particleCount;t<n;t++){var r=this.particles[t],i=r.size,s=i>>1;if(r.position.x+i<0||r.position.y+i<0||r.position.x-i>Crafty.viewport.width||r.position.y-i>Crafty.viewport.height)continue;var o=~~r.position.x,u=~~r.position.y;if(this.fastMode)e.fillStyle=r.drawColour;else{var a=e.createRadialGradient(o+s,u+s,r.sizeSmall,o+s,u+s,s);a.addColorStop(0,r.drawColour);a.addColorStop(.9,r.drawColourEnd);e.fillStyle=a}e.fillRect(o,u,i,i)}},particle:function(e){this.position=e.create(0,0);this.direction=e.create(0,0);this.size=0;this.sizeSmall=0;this.timeToLive=0;this.colour=[];this.drawColour="";this.deltaColour=[];this.sharpness=0},vectorHelpers:{create:function(e,t){return{x:e,y:t}},multiply:function(e,t){e.x*=t;e.y*=t;return e},add:function(e,t){e.x+=t.x;e.y+=t.y;return e}}}});Crafty.extend({audio:{sounds:{},supported:{},codecs:{ogg:'audio/ogg; codecs="vorbis"',wav:'audio/wav; codecs="1"',webma:'audio/webm; codecs="vorbis"',mp3:'audio/mpeg; codecs="mp3"',m4a:'audio/mp4; codecs="mp4a.40.2"'},volume:1,muted:!1,paused:!1,canPlay:function(){var e=this.audioElement(),t;for(var n in this.codecs){t=e.canPlayType(this.codecs[n]);t!==""&&t!=="no"?this.supported[n]=!0:this.supported[n]=!1}},audioElement:function(){return typeof Audio!="undefined"?new Audio(""):document.createElement("audio")},add:function(e,t){Crafty.support.audio=!!this.audioElement().canPlayType;if(!Crafty.support.audio)return;this.canPlay();var n,r,i;if(arguments.length===1&&typeof e=="object")for(var s in e)for(var o in e[s]){n=this.audioElement();n.id=s;n.preload="auto";n.volume=Crafty.audio.volume;i=e[s][o];r=i.substr(i.lastIndexOf(".")+1).toLowerCase();if(this.supported[r]){n.src=i;Crafty.asset(i,n);this.sounds[s]={obj:n,played:0,volume:Crafty.audio.volume}}}if(typeof e=="string"){n=this.audioElement();n.id=e;n.preload="auto";n.volume=Crafty.audio.volume;if(typeof t=="string"){r=t.substr(t.lastIndexOf(".")+1).toLowerCase();if(this.supported[r]){n.src=t;Crafty.asset(t,n);this.sounds[e]={obj:n,played:0,volume:Crafty.audio.volume}}}if(typeof t=="object")for(o in t){n=this.audioElement();n.id=e;n.preload="auto";n.volume=Crafty.audio.volume;i=t[o];r=i.substr(i.lastIndexOf(".")+1).toLowerCase();if(this.supported[r]){n.src=i;Crafty.asset(i,n);this.sounds[e]={obj:n,played:0,volume:Crafty.audio.volume}}}}},play:function(e,t,n){if(t==0||!Crafty.support.audio||!this.sounds[e])return;var r=this.sounds[e];r.volume=r.obj.volume=n||Crafty.audio.volume;r.obj.currentTime&&(r.obj.currentTime=0);this.muted&&(r.obj.volume=0);r.obj.play();r.played++;r.obj.addEventListener("ended",function(){if(r.played<t||t==-1){this.currentTime&&(this.currentTime=0);this.play();r.played++}},!0)},stop:function(e){if(!Crafty.support.audio)return;var t;if(!e)for(var n in this.sounds){t=this.sounds[n];t.obj.paused||t.obj.pause()}if(!this.sounds[e])return;t=this.sounds[e];t.obj.paused||t.obj.pause()},_mute:function(e){if(!Crafty.support.audio)return;var t;for(var n in this.sounds){t=this.sounds[n];t.obj.volume=e?0:t.volume}this.muted=e},toggleMute:function(){this.muted?this._mute(!1):this._mute(!0)},mute:function(){this._mute(!0)},unmute:function(){this._mute(!1)},pause:function(e){if(!Crafty.support.audio||!e||!this.sounds[e])return;var t=this.sounds[e];t.obj.paused||t.obj.pause()},unpause:function(e){if(!Crafty.support.audio||!e||!this.sounds[e])return;var t=this.sounds[e];t.obj.paused&&t.obj.play()},togglePause:function(e){if(!Crafty.support.audio||!e||!this.sounds[e])return;var t=this.sounds[e];t.obj.paused?t.obj.play():t.obj.pause()}}});Crafty.c("Text",{_text:"",_textFont:{type:"",weight:"",size:"",family:""},ready:!0,init:function(){this.requires("2D");this.bind("Draw",function(e){var t=this._textFont.type+" "+this._textFont.weight+" "+this._textFont.size+" "+this._textFont.family;if(e.type==="DOM"){var n=this._element,r=n.style;r.color=this._textColor;r.font=t;n.innerHTML=this._text}else if(e.type==="canvas"){var i=e.ctx,s=null;i.save();i.fillStyle=this._textColor||"rgb(0,0,0)";i.font=t;i.translate(this.x,this.y+this.h);i.fillText(this._text,0,0);s=i.measureText(this._text);this._w=s.width;i.restore()}})},text:function(e){if(typeof e=="undefined"||e===null)return this._text;typeof e=="function"?this._text=e.call(this):this._text=e;this.trigger("Change");return this},textColor:function(e,t){this._strength=t;this._textColor=Crafty.toRGB(e,this._strength);this.trigger("Change");return this},textFont:function(e,t){if(arguments.length===1){if(typeof e=="string")return this._textFont[e];if(typeof e=="object")for(propertyKey in e)this._textFont[propertyKey]=e[propertyKey]}else this._textFont[e]=t;this.trigger("Change");return this}});Crafty.extend({assets:{},asset:function(e,t){if(arguments.length===1)return Crafty.assets[e];if(!Crafty.assets[e]){Crafty.assets[e]=t;this.trigger("NewAsset",{key:e,value:t})}},image_whitelist:["jpg","jpeg","gif","png","svg"],load:function(e,t,n,r){function c(){var e=this.src;this.removeEventListener&&this.removeEventListener("canplaythrough",c,!1);++f;n&&n({loaded:f,total:a,percent:f/a*100,src:e});f===a&&t&&t()}function h(){var e=this.src;r&&r({loaded:f,total:a,percent:f/a*100,src:e});f++;f===a&&t&&t()}var i=0,s=e.length,o,u,a=s,f=0,l="";for(;i<s;++i){o=e[i];l=o.substr(o.lastIndexOf(".")+1,3).toLowerCase();u=Crafty.asset(o)||null;if(Crafty.support.audio&&Crafty.audio.supported[l]){if(!u){var p=o.substr(o.lastIndexOf("/")+1).toLowerCase();u=Crafty.audio.audioElement();u.id=p;u.src=o;u.preload="auto";u.volume=Crafty.audio.volume;Crafty.asset(o,u);Crafty.audio.sounds[p]={obj:u,played:0}}u.addEventListener&&u.addEventListener("canplaythrough",c,!1)}else{if(!(Crafty.image_whitelist.indexOf(l)>=0)){a--;continue}if(!u){u=new Image;Crafty.asset(o,u)}u.onload=c;u.src=o}u.onerror=h}},modules:function(e,t,n){if(arguments.length===2&&typeof e=="object"){n=t;t=e;e="http://cdn.craftycomponents.com"}var r=function(){function g(e,t,n){for(n=0,j=e.length;n<j;++n)if(!t(e[n]))return c;return 1}function y(e,t){g(e,function(e){return!t(e)})}function b(e,t,n){function d(e){return e.call?e():s[e]}function v(){if(!--p){s[c]=1;l&&l();for(var e in u)g(e.split("|"),d)&&!y(u[e],d)&&(u[e]=[])}}e=e[h]?e:[e];var i=t&&t.call,l=i?t:n,c=i?e.join(""):t,p=e.length;setTimeout(function(){y(e,function(e){if(f[e]){c&&(o[c]=1);return f[e]==2&&v()}f[e]=1;c&&(o[c]=1);w(!r.test(e)&&a?a+e+".js":e,v)})},0);return b}function w(e,r){var i=t.createElement("script"),s=c;i.onload=i.onerror=i[m]=function(){if(i[d]&&!/^c|loade/.test(i[d])||s)return;i.onload=i[m]=null;s=1;f[e]=2;r()};i.async=1;i.src=e;n.insertBefore(i,n.firstChild)}var e=this,t=document,n=t.getElementsByTagName("head")[0],r=/^https?:\/\//,i=e.$script,s={},o={},u={},a,f={},l="string",c=!1,h="push",p="DOMContentLoaded",d="readyState",v="addEventListener",m="onreadystatechange";if(!t[d]&&t[v]){t[v](p,function E(){t.removeEventListener(p,E,c);t[d]="complete"},c);t[d]="loading"}b.get=w;b.order=function(e,t,n){(function r(i){i=e.shift();e.length?b(i,r):b(i,t,n)})()};b.path=function(e){a=e};b.ready=function(e,t,n){e=e[h]?e:[e];var r=[];!y(e,function(e){s[e]||r[h](e)})&&g(e,function(e){return s[e]})?t():!function(e){u[e]=u[e]||[];u[e][h](t);n&&n(r)}(e.join("|"));return b};b.noConflict=function(){e.$script=i;return this};return b}(),i=[],s=/^(https?|file):\/\//;for(var o in t)s.test(o)?i.push(o):i.push(e+"/"+o.toLowerCase()+"-"+t[o].toLowerCase()+".js");r(i,function(){n&&n()})}});Crafty.math={abs:function(e){return e<0?-e:e},amountOf:function(e,t,n){return t<n?(e-t)/(n-t):(e-n)/(t-n)},clamp:function(e,t,n){return e>n?n:e<t?t:e},degToRad:function(e){return e*Math.PI/180},distance:function(e,t,n,r){var i=Crafty.math.squaredDistance(e,t,n,r);return Math.sqrt(parseFloat(i))},lerp:function(e,t,n){return e+(t-e)*n},negate:function(e){return Math.random()<e?-1:1},radToDeg:function(e){return e*180/Math.PI},randomElementOfArray:function(e){return e[Math.floor(e.length*Math.random())]},randomInt:function(e,t){return e+Math.floor((1+t-e)*Math.random())},randomNumber:function(e,t){return e+(t-e)*Math.random()},squaredDistance:function(e,t,n,r){return(e-n)*(e-n)+(t-r)*(t-r)},withinRange:function(e,t,n){return e>=t&&e<=n}};Crafty.math.Vector2D=function(){function e(t,n){if(t instanceof e){this.x=t.x;this.y=t.y}else if(arguments.length===2){this.x=t;this.y=n}else if(arguments.length>0)throw"Unexpected number of arguments for Vector2D()"}e.prototype.x=0;e.prototype.y=0;e.prototype.add=function(e){this.x+=e.x;this.y+=e.y;return this};e.prototype.angleBetween=function(e){return Math.atan2(this.x*e.y-this.y*e.x,this.x*e.x+this.y*e.y)};e.prototype.angleTo=function(e){return Math.atan2(e.y-this.y,e.x-this.x)};e.prototype.clone=function(){return new e(this)};e.prototype.distance=function(e){return Math.sqrt((e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y))};e.prototype.distanceSq=function(e){return(e.x-this.x)*(e.x-this.x)+(e.y-this.y)*(e.y-this.y)};e.prototype.divide=function(e){this.x/=e.x;this.y/=e.y;return this};e.prototype.dotProduct=function(e){return this.x*e.x+this.y*e.y};e.prototype.equals=function(t){return t instanceof e&&this.x==t.x&&this.y==t.y};e.prototype.getNormal=function(t){return t===undefined?new e(-this.y,this.x):(new e(t.y-this.y,this.x-t.x)).normalize()};e.prototype.isZero=function(){return this.x===0&&this.y===0};e.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};e.prototype.magnitudeSq=function(){return this.x*this.x+this.y*this.y};e.prototype.multiply=function(e){this.x*=e.x;this.y*=e.y;return this};e.prototype.negate=function(){this.x=-this.x;this.y=-this.y;return this};e.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y);if(e===0){this.x=1;this.y=0}else{this.x/=e;this.y/=e}return this};e.prototype.scale=function(e,t){t===undefined&&(t=e);this.x*=e;this.y*=t;return this};e.prototype.scaleToMagnitude=function(e){var t=e/this.magnitude();this.x*=t;this.y*=t;return this};e.prototype.setValues=function(t,n){if(t instanceof e){this.x=t.x;this.y=t.y}else{this.x=t;this.y=n}return this};e.prototype.subtract=function(e){this.x-=e.x;this.y-=e.y;return this};e.prototype.toString=function(){return"Vector2D("+this.x+", "+this.y+")"};e.prototype.translate=function(e,t){t===undefined&&(t=e);this.x+=e;this.y+=t;return this};e.tripleProduct=function(e,t,n){var r=e.dotProduct(n),i=t.dotProduct(n);return new Crafty.math.Vector2D(t.x*r-e.x*i,t.y*r-e.y*i)};return e}();Crafty.math.Matrix2D=function(){Matrix2D=function(e,t,n,r,i,s){if(e instanceof Matrix2D){this.a=e.a;this.b=e.b;this.c=e.c;this.d=e.d;this.e=e.e;this.f=e.f}else if(arguments.length===6){this.a=e;this.b=t;this.c=n;this.d=r;this.e=i;this.f=s}else if(arguments.length>0)throw"Unexpected number of arguments for Matrix2D()"};Matrix2D.prototype.a=1;Matrix2D.prototype.b=0;Matrix2D.prototype.c=0;Matrix2D.prototype.d=1;Matrix2D.prototype.e=0;Matrix2D.prototype.f=0;Matrix2D.prototype.apply=function(e){var t=e.x;e.x=t*this.a+e.y*this.c+this.e;e.y=t*this.b+e.y*this.d+this.f;return e};Matrix2D.prototype.clone=function(){return new Matrix2D(this)};Matrix2D.prototype.combine=function(e){var t=this.a;this.a=t*e.a+this.b*e.c;this.b=t*e.b+this.b*e.d;t=this.c;this.c=t*e.a+this.d*e.c;this.d=t*e.b+this.d*e.d;t=this.e;this.e=t*e.a+this.f*e.c+e.e;this.f=t*e.b+this.f*e.d+e.f;return this};Matrix2D.prototype.equals=function(e){return e instanceof Matrix2D&&this.a==e.a&&this.b==e.b&&this.c==e.c&&this.d==e.d&&this.e==e.e&&this.f==e.f};Matrix2D.prototype.determinant=function(){return this.a*this.d-this.b*this.c};Matrix2D.prototype.invert=function(){var e=this.determinant();if(e!==0){var t={a:this.a,b:this.b,c:this.c,d:this.d,e:this.e,f:this.f};this.a=t.d/e;this.b=-t.b/e;this.c=-t.c/e;this.d=t.a/e;this.e=(t.c*t.f-t.e*t.d)/e;this.f=(t.e*t.b-t.a*t.f)/e}return this};Matrix2D.prototype.isIdentity=function(){return this.a===1&&this.b===0&&this.c===0&&this.d===1&&this.e===0&&this.f===0};Matrix2D.prototype.isInvertible=function(){return this.determinant()!==0};Matrix2D.prototype.preRotate=function(e){var t=Math.cos(e),n=Math.sin(e),r=this.a;this.a=t*r-n*this.b;this.b=n*r+t*this.b;r=this.c;this.c=t*r-n*this.d;this.d=n*r+t*this.d;return this};Matrix2D.prototype.preScale=function(e,t){t===undefined&&(t=e);this.a*=e;this.b*=t;this.c*=e;this.d*=t;return this};Matrix2D.prototype.preTranslate=function(e,t){if(typeof e=="number"){this.e+=e;this.f+=t}else{this.e+=e.x;this.f+=e.y}return this};Matrix2D.prototype.rotate=function(e){var t=Math.cos(e),n=Math.sin(e),r=this.a;this.a=t*r-n*this.b;this.b=n*r+t*this.b;r=this.c;this.c=t*r-n*this.d;this.d=n*r+t*this.d;r=this.e;this.e=t*r-n*this.f;this.f=n*r+t*this.f;return this};Matrix2D.prototype.scale=function(e,t){t===undefined&&(t=e);this.a*=e;this.b*=t;this.c*=e;this.d*=t;this.e*=e;this.f*=t;return this};Matrix2D.prototype.setValues=function(e,t,n,r,i,s){if(e instanceof Matrix2D){this.a=e.a;this.b=e.b;this.c=e.c;this.d=e.d;this.e=e.e;this.f=e.f}else{this.a=e;this.b=t;this.c=n;this.d=r;this.e=i;this.f=s}return this};Matrix2D.prototype.toString=function(){return"Matrix2D(["+this.a+", "+this.c+", "+this.e+"] ["+this.b+", "+this.d+", "+this.f+"] [0, 0, 1])"};Matrix2D.prototype.translate=function(e,t){if(typeof e=="number"){this.e+=this.a*e+this.c*t;this.f+=this.b*e+this.d*t}else{this.e+=this.a*e.x+this.c*e.y;this.f+=this.b*e.x+this.d*e.y}return this};return Matrix2D}();Crafty.c("Delay",{init:function(){this._delays=[];this.bind("EnterFrame",function(){var e=(new Date).getTime();for(var t in this._delays){var n=this._delays[t];if(!n.triggered&&n.start+n.delay+n.pause<e){n.triggered=!0;n.func.call(this)}}});this.bind("Pause",function(){var e=(new Date).getTime();for(var t in this._delays)this._delays[t].pauseBuffer=e});this.bind("Unpause",function(){var e=(new Date).getTime();for(var t in this._delays){var n=this._delays[t];n.pause+=e-n.pauseBuffer}})},delay:function(e,t){return this._delays.push({start:(new Date).getTime(),func:e,delay:t,triggered:!1,pauseBuffer:0,pause:0})}})});