function resetSprite(){$sprite.removeAttr("src");file=selected=inneroffset=null;labels={};$inner.html("");$over.css("border-color","red");$grid.mousemove(overHandler);$label.val("")}function spritify(e){file=e;var t=150,n;console.log("FILE",file);$sprite.attr("src",file).load(function(){n=this.width;if(ASSETS[e].spritify){var r=ASSETS[e].spritify;labels=r.labels;grid(r.size,r.paddingx,r.paddingy);$tilesize.val(r.size);$paddingx.val(r.paddingx);$paddingy.val(r.paddingy)}$spritify.dialog({modal:!0,width:n+t,height:"auto",resizable:!1,buttons:{Save:function(){var t='Crafty.sprite("'+$tilesize.val()+'",'+e+",{",n,r=ASSETS[e],i={},s;for(n in labels){t+="'"+labels[n]+"': ["+n.split("x").join(",")+"],";i[labels[n]]=n.split("x");COMPS[labels[n]]={}}t=t.substr(0,t.length-1);t+="}";+$paddingx.val()>0&&(t+=","+$paddingx.val());+$paddingy.val()>0&&(t+=","+$paddingy.val());t+=");";Crafty.sprite(+$tilesize.val(),e,i,+$paddingx.val(),+$paddingy.val());if(r.block){s=r.block;s.open=t}else{s=new Block(t);CODE.append(s)}r.spritify={labels:labels,size:+$tilesize.val(),paddingx:+$paddingx.val(),paddingy:+$paddingy.val()};Editor.update();resetSprite();$(this).dialog("close")},Cancel:function(){resetSprite();$(this).dialog("close")}},dragStop:function(){inneroffset=$grid.offset()},beforeClose:function(){resetSprite()}});$grid.css({width:$(this).width(),height:$(this).height()});inneroffset=$grid.offset()}).error(function(){errorz("Image not found!","We can't find the image <code>"+file+"</code>")})}function intOnly(e){return e.keyCode>=48&&e.keyCode<=57||e.keyCode==8||e.keyCode==46}function clickHandler(e){if(selected){selected=null;$over.css("border-color","red");$grid.mousemove(overHandler);$label.val("");return}var t=+$tilesize.val(),n=+$paddingx.val(),r=+$paddingy.val(),i=t+n,s=t+r,o=e.clientX-inneroffset.left,u=e.clientY-inneroffset.top,a=+$width.val(),f=+$height.val(),l=Math.floor(o/i),c=Math.floor(u/s),h=labels[l+"x"+c+"x"+a+"x"+f]||"";selected=[l,c,a,f];$over.css("border-color","green");$(this).unbind("mousemove");$label.focus().val(h)}function grid(e,t,n){if(e<=1)return;var r=$sprite.width(),i=$sprite.height(),s=1,o=Math.ceil(r/(e+t)),u=1,a=Math.ceil(i/(e+n)),f="";for(;s<=o;s++)f+="<div style='top:0; left:"+(s*(e+t)-t)+"px; border-right-width:"+(t+1)+"px; height:"+i+"px;'></div>";for(;u<=a;u++)f+="<div style='top:"+(u*(e+n)-n)+"px; left:0; border-bottom-width:"+(n+1)+"px; width:"+r+"px;'></div>";$inner.html(f)}function gridHandler(e){grid(+$tilesize.val(),+$paddingx.val(),+$paddingy.val())}function overHandler(e){if(+$tilesize.val()<=1)return;var t=+$tilesize.val(),n=+$paddingx.val(),r=+$paddingy.val(),i=t+n,s=t+r,o=e.clientX-inneroffset.left,u=e.clientY-inneroffset.top,a=+$width.val(),f=+$height.val(),l=Math.floor(o/i)*i,c=Math.floor(u/s)*s;$over.css({left:l,top:c,width:a*(t+n)-n-1,height:f*(t+r)-r-1})}var inneroffset,blurred=!1,selected=null,labels={},file;$(function(){$grid.mousemove(overHandler).click(clickHandler);$tilesize.keydown(intOnly).keyup(gridHandler);$paddingx.keydown(intOnly).keyup(gridHandler);$paddingy.keydown(intOnly).keyup(gridHandler);$width.keydown(intOnly).keyup(gridHandler);$height.keydown(intOnly).keyup(gridHandler);$label.keypress(function(){if(!selected){$(this).blur();return!1}}).keyup(function(){if(!selected)return!1;labels[selected[0]+"x"+selected[1]+"x"+selected[2]+"x"+selected[3]]=$(this).val()})});