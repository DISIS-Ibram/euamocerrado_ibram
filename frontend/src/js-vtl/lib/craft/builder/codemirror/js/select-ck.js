/* Functionality for finding, storing, and restoring selections
 *
 * This does not provide a generic API, just the minimal functionality
 * required by the CodeMirror system.
 */// Namespace object.
var select={};(function(){function e(e,t){while(e&&e.parentNode!=t)e=e.parentNode;return e}function t(t,n){while(!t.previousSibling&&t.parentNode!=n)t=t.parentNode;return e(t.previousSibling,n)}function i(e){var t=e.nextSibling;if(t){while(t.firstChild)t=t.firstChild;return t.nodeType==3||isBR(t)?t:i(t)}var n=e.parentNode;while(n&&!n.nextSibling)n=n.parentNode;return n&&i(n)}select.ie_selection=document.selection&&document.selection.createRangeCollection;var n="    ";select.scrollToNode=function(e,t){if(!e)return;var n=e,r=document.body,i=document.documentElement,s=!n.nextSibling||!n.nextSibling.nextSibling||!n.nextSibling.nextSibling.nextSibling,o=0;while(n&&!n.offsetTop){o++;n=n.previousSibling}o==0&&(s=!1);if(webkit&&n&&n.offsetTop==5&&n.offsetLeft==5)return;var u=o*(n?n.offsetHeight:0),a=0,f=e?e.offsetWidth:0,l=n;while(l&&l.offsetParent){u+=l.offsetTop;isBR(l)||(a+=l.offsetLeft);l=l.offsetParent}var c=r.scrollLeft||i.scrollLeft||0,h=r.scrollTop||i.scrollTop||0,p=!1,d=window.innerWidth||i.clientWidth||0;if(t||f<d){if(t){var v=select.offsetInNode(e),m=nodeText(e).length;m&&(a+=f*(v/m))}var g=a-c;if(g<0||g>d){c=a;p=!0}}var y=u-h;if(y<0||s||y>(window.innerHeight||i.clientHeight||0)-50){h=s?1e6:u;p=!0}p&&window.scrollTo(c,h)};select.scrollToCursor=function(e){select.scrollToNode(select.selectionTopNode(e,!0)||e.firstChild,!0)};var r=null;select.snapshotChanged=function(){r&&(r.changed=!0)};select.snapshotReplaceNode=function(e,t,n,s){function o(o){if(e==o.node){r.changed=!0;if(n&&o.offset>n)o.offset-=n;else{o.node=t;o.offset+=s||0}}else select.ie_selection&&o.offset==0&&o.node==i(e)&&(r.changed=!0)}if(!r)return;o(r.start);o(r.end)};select.snapshotMove=function(e,t,n,i,s){function o(o){if(e==o.node&&(!s||o.offset==0)){r.changed=!0;o.node=t;i?o.offset=Math.max(0,o.offset+n):o.offset=n}}if(!r)return;o(r.start);o(r.end)};if(select.ie_selection){function s(){var e=document.selection;return e&&(e.createRange||e.createTextRange)()}function o(e){function n(e){var t=null;while(!t&&e){t=e.nextSibling;e=e.parentNode}return r(t)}function r(e){while(e&&e.firstChild)e=e.firstChild;return{node:e,offset:0}}var t=s();t.collapse(e);var i=t.parentElement();if(!isAncestor(document.body,i))return null;if(!i.firstChild)return r(i);var o=t.duplicate();o.moveToElementText(i);o.collapse(!0);for(var u=i.firstChild;u;u=u.nextSibling){if(u.nodeType==3){var a=u.nodeValue.length;o.move("character",a)}else{o.moveToElementText(u);o.collapse(!1)}var f=t.compareEndPoints("StartToStart",o);if(f==0)return n(u);if(f==1)continue;if(u.nodeType!=3)return r(u);o.setEndPoint("StartToEnd",t);return{node:u,offset:a-o.text.length}}return n(i)}select.markSelection=function(){r=null;var e=document.selection;if(!e)return;var t=o(!0),n=o(!1);if(!t||!n)return;r={start:t,end:n,changed:!1}};select.selectMarked=function(){function e(e){var t=document.body.createTextRange(),n=e.node;if(!n){t.moveToElementText(document.body);t.collapse(!1)}else if(n.nodeType==3){t.moveToElementText(n.parentNode);var r=e.offset;while(n.previousSibling){n=n.previousSibling;r+=(n.innerText||"").length}t.move("character",r)}else{t.moveToElementText(n);t.collapse(!0)}return t}if(!r||!r.changed)return;var t=e(r.start),n=e(r.end);t.setEndPoint("StartToEnd",n);t.select()};select.offsetInNode=function(e){var t=s();if(!t)return 0;var n=t.duplicate();try{n.moveToElementText(e)}catch(r){return 0}t.setEndPoint("StartToStart",n);return t.text.length};select.selectionTopNode=function(t,n){function u(e,t){if(t.nodeType==3){var n=0,r=t.previousSibling;while(r&&r.nodeType==3){n+=r.nodeValue.length;r=r.previousSibling}if(r){try{e.moveToElementText(r)}catch(i){return!1}e.collapse(!1)}else e.moveToElementText(t.parentNode);n&&e.move("character",n)}else try{e.moveToElementText(t)}catch(i){return!1}return!0}var r=s();if(!r)return!1;var i=r.duplicate();r.collapse(n);var o=r.parentElement();if(o&&isAncestor(t,o)){i.moveToElementText(o);if(r.compareEndPoints("StartToStart",i)==1)return e(o,t)}var n=0,a=t.childNodes.length-1;while(n<a){var f=Math.ceil((a+n)/2),l=t.childNodes[f];if(!l)return!1;if(!u(i,l))return!1;r.compareEndPoints("StartToStart",i)==1?n=f:a=f-1}if(n==0){var c=s(),h=c.duplicate();try{h.moveToElementText(t)}catch(p){return null}if(c.compareEndPoints("StartToStart",h)==0)return null}return t.childNodes[n]||null};select.focusAfterNode=function(e,t){var n=document.body.createTextRange();n.moveToElementText(e||t);n.collapse(!e);n.select()};select.somethingSelected=function(){var e=s();return e&&e.text!=""};function u(e){var t=s();if(t){t.pasteHTML(e);t.collapse(!1);t.select()}}select.insertNewlineAtCursor=function(){u("<br>")};select.insertTabAtCursor=function(){u(n)};select.cursorPos=function(e,t){var n=s();if(!n)return null;var r=select.selectionTopNode(e,t);while(r&&!isBR(r))r=r.previousSibling;var i=n.duplicate();n.collapse(t);if(r){i.moveToElementText(r);i.collapse(!1)}else{try{i.moveToElementText(e)}catch(o){return null}i.collapse(!0)}n.setEndPoint("StartToStart",i);return{node:r,offset:n.text.length}};select.setCursorPos=function(e,t,n){function r(t){var n=document.body.createTextRange();if(!t.node){n.moveToElementText(e);n.collapse(!0)}else{n.moveToElementText(t.node);n.collapse(!1)}n.move("character",t.offset);return n}var i=r(t);n&&n!=t&&i.setEndPoint("EndToEnd",r(n));i.select()};select.getBookmark=function(e){var t=select.cursorPos(e,!0),n=select.cursorPos(e,!1);if(t&&n)return{from:t,to:n}};select.setBookmark=function(e,t){if(!t)return;select.setCursorPos(e,t.from,t.to)}}else{function a(e,t){while(e.nodeType!=3&&!isBR(e)){var n=e.childNodes[t]||e.nextSibling;t=0;while(!n&&e.parentNode){e=e.parentNode;n=e.nextSibling}e=n;if(!n)break}return{node:e,offset:t}}select.markSelection=function(){var e=window.getSelection();if(!e||e.rangeCount==0)return r=null;var t=e.getRangeAt(0);r={start:a(t.startContainer,t.startOffset),end:a(t.endContainer,t.endOffset),changed:!1}};select.selectMarked=function(){function t(){if(e.start.node==e.end.node&&e.start.offset==e.end.offset){var t=window.getSelection();if(!t||t.rangeCount==0)return!0;var n=t.getRangeAt(0),r=a(n.startContainer,n.startOffset);return e.start.node!=r.node||e.start.offset!=r.offset}}function i(e,t){e.node?e.offset==0?n["set"+t+"Before"](e.node):n["set"+t](e.node,e.offset):n.setStartAfter(document.body.lastChild||document.body)}var e=r;if(!e||!(e.changed||webkit&&t()))return;var n=document.createRange();i(e.end,"End");i(e.start,"Start");f(n)};function f(e){var t=window.getSelection();if(!t)return;t.removeAllRanges();t.addRange(e)}function l(){var e=window.getSelection();return!e||e.rangeCount==0?!1:e.getRangeAt(0)}select.selectionTopNode=function(n,r){var i=l();if(!i)return!1;var s=r?i.startContainer:i.endContainer,o=r?i.startOffset:i.endOffset;window.opera&&!r&&i.endContainer==n&&i.endOffset==i.startOffset+1&&n.childNodes[i.startOffset]&&isBR(n.childNodes[i.startOffset])&&o--;return s.nodeType==3?o>0?e(s,n):t(s,n):s.nodeName.toUpperCase()=="HTML"?o==1?null:n.lastChild:s==n?o==0?null:s.childNodes[o-1]:o==s.childNodes.length?e(s,n):o==0?t(s,n):e(s.childNodes[o-1],n)};select.focusAfterNode=function(e,t){var n=document.createRange();n.setStartBefore(t.firstChild||t);e&&!e.firstChild?n.setEndAfter(e):e?n.setEnd(e,e.childNodes.length):n.setEndBefore(t.firstChild||t);n.collapse(!1);f(n)};select.somethingSelected=function(){var e=l();return e&&!e.collapsed};select.offsetInNode=function(e){var t=l();if(!t)return 0;t=t.cloneRange();t.setStartBefore(e);return t.toString().length};select.insertNodeAtCursor=function(e){var t=l();if(!t)return;t.deleteContents();t.insertNode(e);webkitLastLineHack(document.body);if(window.opera&&isBR(e)&&isSpan(e.parentNode)){var n=e.nextSibling,r=e.parentNode,i=r.parentNode;i.insertBefore(e,r.nextSibling);var s="";for(;n&&n.nodeType==3;n=n.nextSibling){s+=n.nodeValue;removeElement(n)}i.insertBefore(makePartSpan(s,document),e.nextSibling)}t=document.createRange();t.selectNode(e);t.collapse(!1);f(t)};select.insertNewlineAtCursor=function(){select.insertNodeAtCursor(document.createElement("BR"))};select.insertTabAtCursor=function(){select.insertNodeAtCursor(document.createTextNode(n))};select.cursorPos=function(e,t){var n=l();if(!n)return;var r=select.selectionTopNode(e,t);while(r&&!isBR(r))r=r.previousSibling;n=n.cloneRange();n.collapse(t);r?n.setStartAfter(r):n.setStartBefore(e);var i=n.toString();return{node:r,offset:i.length}};select.setCursorPos=function(e,t,n){function i(t,n,i){function o(e){e.nodeType==3?s.push(e):forEach(e.childNodes,o)}if(n==0&&t&&!t.nextSibling){r["set"+i+"After"](t);return!0}t?t=t.nextSibling:t=e.firstChild;if(!t)return;if(n==0){r["set"+i+"Before"](t);return!0}var s=[];for(;;){while(t&&!s.length){o(t);t=t.nextSibling}var u=s.shift();if(!u)return!1;var a=u.nodeValue.length;if(a>=n){r["set"+i](u,n);return!0}n-=a}}var r=document.createRange();n=n||t;i(n.node,n.offset,"End")&&i(t.node,t.offset,"Start")&&f(r)}}})();