/* The Editor object manages the content of the editable frame. It
 * catches events, colours nodes, and indents lines. This file also
 * holds some functions for transforming arbitrary DOM structures into
 * plain sequences of <span> and <br> elements
 */function makeWhiteSpace(e){var t=[],n=!0;for(;e>0;e--){t.push(n||e==1?nbsp:" ");n^=!0}return t.join("")}function fixSpaces(e){e.charAt(0)==" "&&(e=nbsp+e.slice(1));return e.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(e){return makeWhiteSpace(e.length)})}function cleanText(e){return e.replace(/\u00a0/g," ").replace(/\u200b/g,"")}function makePartSpan(e){var t=e;e.nodeType==3?t=e.nodeValue:e=document.createTextNode(t);var n=document.createElement("span");n.isPart=!0;n.appendChild(e);n.currentText=t;return n}function alwaysZero(){return 0}function asEditorLines(e){var t=makeWhiteSpace(indentUnit);return map(e.replace(/\t/g,t).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}var internetExplorer=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent),webkit=/AppleWebKit/.test(navigator.userAgent),safari=/Apple Computer, Inc/.test(navigator.vendor),gecko=navigator.userAgent.match(/gecko\/(\d{8})/i);gecko&&(gecko=Number(gecko[1]));var mac=/Mac/.test(navigator.platform),brokenOpera=window.opera&&/Version\/10.[56]/.test(navigator.userAgent),slowWebkit=/AppleWebKit\/533/.test(navigator.userAgent),webkitLastLineHack=webkit?function(e){var t=e.lastChild;if(!t||!t.hackBR){var n=document.createElement("br");n.hackBR=!0;e.appendChild(n)}}:function(){},Editor=function(){function t(t,n){function s(t,o){if(t.nodeType==3){var u=t.nodeValue=fixSpaces(t.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "));u.length&&(i=!1);r.push(t)}else if(isBR(t)&&t.childNodes.length==0){i=!0;r.push(t)}else{for(var a=t.firstChild;a;a=a.nextSibling)s(a);if(!i&&e.hasOwnProperty(t.nodeName.toUpperCase())){i=!0;(!n||!o)&&r.push(document.createElement("br"))}}}var r=[],i=!0;s(t,!0);return r}function n(e){function r(e){var t=e.parentNode,n=e.nextSibling;return function(e){t.insertBefore(e,n)}}function o(e){var t="\n";if(e.nodeType==3){select.snapshotChanged();e=makePartSpan(e);t=e.currentText;s=!1}else{s&&window.opera&&i(makePartSpan(""));s=!0}e.dirty=!0;n.push(e);i(e);return t}function u(e,n){var r=t(e,n);for(var i=0;i<r.length;i++)r[i]=o(r[i]);return r.join("")}function a(e){if(e.isPart&&e.childNodes.length==1&&e.firstChild.nodeType==3){var t=e.firstChild.nodeValue;e.dirty=e.dirty||t!=e.currentText;e.currentText=t;return!/[\n\t\r]/.test(e.currentText)}return!1}function f(){if(!e)throw StopIteration;var t=e;e=t.nextSibling;if(a(t)){n.push(t);s=!1;return t.currentText}if(isBR(t)){s&&window.opera&&t.parentNode.insertBefore(makePartSpan(""),t);n.push(t);s=!0;return"\n"}var o=!t.nextSibling;i=r(t);removeElement(t);return u(t,o)}var n=[],i=null,s=!0;return{next:f,nodes:n}}function r(e){return isBR(e)?1:e.currentText.length}function i(e){while(e&&!isBR(e))e=e.previousSibling;return e}function s(e,t){e?isBR(e)&&(e=e.nextSibling):e=t.firstChild;while(e&&!isBR(e))e=e.nextSibling;return e}function o(){return(new Date).getTime()}function u(e,t,n,r){function i(t){var n=cleanText(e.history.textAfter(t));return r?n.toLowerCase():n}this.editor=e;this.history=e.history;this.history.commit();this.valid=!!t;this.atOccurrence=!1;r==undefined&&(r=typeof t=="string"&&t==t.toLowerCase());var s={node:null,offset:0},o=this;if(n&&typeof n=="object"&&typeof n.character=="number"){e.checkLine(n.line);var u={node:n.line,offset:n.character};this.pos={from:u,to:u}}else n?this.pos={from:select.cursorPos(e.container,!0)||s,to:select.cursorPos(e.container,!1)||s}:this.pos={from:s,to:s};if(typeof t!="string"){this.matches=function(e,n,r){if(e){var s=i(n).slice(0,r),u=s.match(t),a=0;while(u){var f=s.indexOf(u[0]);a+=f;s=s.slice(f+1);var l=s.match(t);if(!l)break;u=l}}else var s=i(n).slice(r),u=s.match(t),a=u&&r+s.indexOf(u[0]);if(u){o.currentMatch=u;return{from:{node:n,offset:a},to:{node:n,offset:a+u[0].length}}}};return}r&&(t=t.toLowerCase());var a=t.split("\n");this.matches=a.length==1?function(e,n,r){var s=i(n),o=t.length,u;if(e?r>=o&&(u=s.lastIndexOf(t,r-o))!=-1:(u=s.indexOf(t,r))!=-1)return{from:{node:n,offset:u},to:{node:n,offset:u+o}}}:function(e,t,n){var r=e?a.length-1:0,s=a[r],o=i(t),u=e?o.indexOf(s)+s.length:o.lastIndexOf(s);if(e?u>=n||u!=s.length:u<=n||u!=o.length-s.length)return;var f=t;for(;;){if(e&&!f)return;f=e?this.history.nodeBefore(f):this.history.nodeAfter(f);if(!e&&!f)return;o=i(f);s=a[e?--r:++r];if(r>0&&r<a.length-1){if(o!=s)return;continue}var l=e?o.lastIndexOf(s):o.indexOf(s)+s.length;if(e?l!=o.length-s.length:l!=s.length)return;return{from:{node:e?f:t,offset:e?l:u},to:{node:e?t:f,offset:e?u:l}}}}}function a(e){this.options=e;window.indentUnit=e.indentUnit;var t=this.container=document.body;this.history=new UndoHistory(t,e.undoDepth,e.undoDelay,this);var n=this;if(!a.Parser)throw"No parser loaded.";e.parserConfig&&a.Parser.configure&&a.Parser.configure(e.parserConfig);!e.readOnly&&!internetExplorer&&select.setCursorPos(t,{node:null,offset:0});this.dirty=[];this.importCode(e.content||"");this.history.onChange=e.onChange;if(!e.readOnly){if(e.continuousScanning!==!1){this.scanner=this.documentScanner(e.passTime);this.delayScanning()}function r(){document.body.contentEditable!=undefined&&internetExplorer?document.body.contentEditable="true":document.designMode="on";internetExplorer&&e.height!="dynamic"&&(document.body.style.minHeight=window.frameElement.clientHeight-2*document.body.offsetTop-5+"px");document.documentElement.style.borderWidth="0";e.textWrapping||(t.style.whiteSpace="nowrap")}try{r()}catch(i){var s=addEventHandler(document,"focus",function(){s();r()},!0)}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));function o(){n.cursorActivity(!1)}addEventHandler(internetExplorer?document.body:window,"mouseup",o);addEventHandler(document.body,"cut",o);gecko&&addEventHandler(window,"pagehide",function(){n.unloaded=!0});addEventHandler(document.body,"paste",function(e){o();var t=null;try{var r=e.clipboardData||window.clipboardData;r&&(t=r.getData("Text"))}catch(i){}if(t!==null){e.stop();n.replaceSelection(t);select.scrollToCursor(n.container)}});this.options.autoMatchParens&&addEventHandler(document.body,"click",method(this,"scheduleParenHighlight"))}else e.textWrapping||(t.style.whiteSpace="nowrap")}function f(e){return e>=16&&e<=18||e>=33&&e<=40}var e={P:!0,DIV:!0,LI:!0};u.prototype={findNext:function(){return this.find(!1)},findPrevious:function(){return this.find(!0)},find:function(e){function s(){var e={node:r,offset:i};t.pos={from:e,to:e};t.atOccurrence=!1;return!1}if(!this.valid)return!1;var t=this,n=e?this.pos.from:this.pos.to,r=n.node,i=n.offset;if(r&&!r.parentNode){r=null;i=0}for(;;){if(this.pos=this.matches(e,r,i)){this.atOccurrence=!0;return!0}if(e){if(!r)return s();r=this.history.nodeBefore(r);i=this.history.textAfter(r).length}else{var o=this.history.nodeAfter(r);if(!o){i=this.history.textAfter(r).length;return s()}r=o;i=0}}},select:function(){if(this.atOccurrence){select.setCursorPos(this.editor.container,this.pos.from,this.pos.to);select.scrollToCursor(this.editor.container)}},replace:function(e){if(this.atOccurrence){var t=this.currentMatch;t&&(e=e.replace(/\\(\d)/,function(e,n){return t[n]}));var n=this.editor.replaceRange(this.pos.from,this.pos.to,e);this.pos.to=n;this.atOccurrence=!1}},position:function(){if(this.atOccurrence)return{line:this.pos.from.node,character:this.pos.from.offset}}};a.prototype={importCode:function(e){var t=asEditorLines(e),n=1e3;if(!this.options.incrementalLoading||t.length<n){this.history.push(null,null,t);this.history.reset()}else{var r=0,i=this;function s(){var e=t.slice(r,r+n);e.push("");i.history.push(i.history.nodeBefore(null),null,e);i.history.reset();r+=n;r<t.length&&parent.setTimeout(s,1e3)}s()}},getCode:function(){if(!this.container.firstChild)return"";var e=[];select.markSelection();forEach(n(this.container.firstChild),method(e,"push"));select.selectMarked();webkit&&this.container.lastChild.hackBR&&e.pop();webkitLastLineHack(this.container);return cleanText(e.join(""))},checkLine:function(e){if(e===!1||e!=null&&e.parentNode!=this.container&&!e.hackBR)throw parent.CodeMirror.InvalidLineHandle},cursorPosition:function(e){e==null&&(e=!0);var t=select.cursorPos(this.container,e);return t?{line:t.node,character:t.offset}:{line:null,character:0}},firstLine:function(){return null},lastLine:function(){var e=this.container.lastChild;e&&(e=i(e));e&&e.hackBR&&(e=i(e.previousSibling));return e},nextLine:function(e){this.checkLine(e);var t=s(e,this.container);return!t||t.hackBR?!1:t},prevLine:function(e){this.checkLine(e);return e==null?!1:i(e.previousSibling)},visibleLineCount:function(){var e=this.container.firstChild;while(e&&isBR(e))e=e.nextSibling;if(!e)return!1;var t=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return Math.floor(t/e.offsetHeight)},selectLines:function(e,t,n,r){this.checkLine(e);var i={node:e,offset:t},s=null;if(r!==undefined){this.checkLine(n);s={node:n,offset:r}}select.setCursorPos(this.container,i,s);select.scrollToCursor(this.container)},lineContent:function(e){var t=[];for(e=e?e.nextSibling:this.container.firstChild;e&&!isBR(e);e=e.nextSibling)t.push(nodeText(e));return cleanText(t.join(""))},setLineContent:function(e,t){this.history.commit();this.replaceRange({node:e,offset:0},{node:e,offset:this.history.textAfter(e).length},t);this.addDirtyNode(e);this.scheduleHighlight()},removeLine:function(e){var t=e?e.nextSibling:this.container.firstChild;while(t){var n=t.nextSibling;removeElement(t);if(isBR(t))break;t=n}this.addDirtyNode(e);this.scheduleHighlight()},insertIntoLine:function(e,t,n){var r=null;if(t=="end")r=s(e,this.container);else for(var i=e?e.nextSibling:this.container.firstChild;i;i=i.nextSibling){if(t==0){r=i;break}var o=nodeText(i);if(o.length>t){r=i.nextSibling;n=o.slice(0,t)+n+o.slice(t);removeElement(i);break}t-=o.length}var u=asEditorLines(n);for(var a=0;a<u.length;a++){a>0&&this.container.insertBefore(document.createElement("BR"),r);this.container.insertBefore(makePartSpan(u[a]),r)}this.addDirtyNode(e);this.scheduleHighlight()},selectedText:function(){var e=this.history;e.commit();var t=select.cursorPos(this.container,!0),n=select.cursorPos(this.container,!1);if(!t||!n)return"";if(t.node==n.node)return e.textAfter(t.node).slice(t.offset,n.offset);var r=[e.textAfter(t.node).slice(t.offset)];for(var i=e.nodeAfter(t.node);i!=n.node;i=e.nodeAfter(i))r.push(e.textAfter(i));r.push(e.textAfter(n.node).slice(0,n.offset));return cleanText(r.join("\n"))},replaceSelection:function(e){this.history.commit();var t=select.cursorPos(this.container,!0),n=select.cursorPos(this.container,!1);if(!t||!n)return;n=this.replaceRange(t,n,e);select.setCursorPos(this.container,n);webkitLastLineHack(this.container)},cursorCoords:function(e,t){function o(e,n){var r=-(document.body.scrollTop||document.documentElement.scrollTop||0),i=-(document.body.scrollLeft||document.documentElement.scrollLeft||0)+n;forEach([e,t?null:window.frameElement],function(e){while(e){i+=e.offsetLeft;r+=e.offsetTop;e=e.offsetParent}});return{x:i,y:r,yBot:r+e.offsetHeight}}function u(e,t){var n=document.createElement("SPAN");n.appendChild(document.createTextNode(e));try{return t(n)}finally{n.parentNode&&n.parentNode.removeChild(n)}}var n=select.cursorPos(this.container,e);if(!n)return null;var r=n.offset,i=n.node,s=this;while(r){i=i?i.nextSibling:this.container.firstChild;var a=nodeText(i);if(r<a.length)return u(a.substr(0,r),function(e){e.style.position="absolute";e.style.visibility="hidden";e.className=i.className;s.container.appendChild(e);return o(i,e.offsetWidth)});r-=a.length}return i&&isSpan(i)?o(i,i.offsetWidth):i&&i.nextSibling&&isSpan(i.nextSibling)?o(i.nextSibling,0):u("​",function(e){i?i.parentNode.insertBefore(e,i.nextSibling):s.container.insertBefore(e,s.container.firstChild);return o(e,0)})},reroutePasteEvent:function(){if(this.capturingPaste||window.opera||gecko&&gecko>=20101026)return;this.capturingPaste=!0;var e=window.frameElement.CodeMirror.textareaHack,t=this.cursorCoords(!0,!0);e.style.top=t.y+"px";if(internetExplorer){var n=select.getBookmark(this.container);n&&(this.selectionSnapshot=n)}parent.focus();e.value="";e.focus();var r=this;parent.setTimeout(function(){r.capturingPaste=!1;window.focus();r.selectionSnapshot&&window.select.setBookmark(r.container,r.selectionSnapshot);var t=e.value;if(t){r.replaceSelection(t);select.scrollToCursor(r.container)}},10)},replaceRange:function(e,t,n){var r=asEditorLines(n);r[0]=this.history.textAfter(e.node).slice(0,e.offset)+r[0];var i=r[r.length-1];r[r.length-1]=i+this.history.textAfter(t.node).slice(t.offset);var s=this.history.nodeAfter(t.node);this.history.push(e.node,s,r);return{node:this.history.nodeBefore(s),offset:i.length}},getSearchCursor:function(e,t,n){return new u(this,e,t,n)},reindent:function(){this.container.firstChild&&this.indentRegion(null,this.container.lastChild)},reindentSelection:function(e){if(!select.somethingSelected())this.indentAtCursor(e);else{var t=select.selectionTopNode(this.container,!0),n=select.selectionTopNode(this.container,!1);if(t===!1||n===!1)return;this.indentRegion(t,n,e)}},grabKeys:function(e,t){this.frozen=e;this.keyFilter=t},ungrabKeys:function(){this.frozen="leave"},setParser:function(e,t){a.Parser=window[e];t=t||this.options.parserConfig;t&&a.Parser.configure&&a.Parser.configure(t);if(this.container.firstChild){forEach(this.container.childNodes,function(e){e.nodeType!=3&&(e.dirty=!0)});this.addDirtyNode(this.firstChild);this.scheduleHighlight()}},keyDown:function(e){if(this.frozen=="leave"){this.frozen=null;this.keyFilter=null}if(this.frozen&&(!this.keyFilter||this.keyFilter(e.keyCode,e))){e.stop();this.frozen(e);return}var t=e.keyCode;this.delayScanning();this.options.autoMatchParens&&this.scheduleParenHighlight();if(t==13){if(e.ctrlKey&&!e.altKey)this.reparseBuffer();else{select.insertNewlineAtCursor();var n=this.options.enterMode;n!="flat"&&this.indentAtCursor(n=="keep"?"keep":undefined);select.scrollToCursor(this.container)}e.stop()}else if(t==9&&this.options.tabMode!="default"&&!e.ctrlKey){this.handleTab(!e.shiftKey);e.stop()}else if(t==32&&e.shiftKey&&this.options.tabMode=="default"){this.handleTab(!0);e.stop()}else if(t==36&&!e.shiftKey&&!e.ctrlKey)this.home()&&e.stop();else if(t==35&&!e.shiftKey&&!e.ctrlKey)this.end()&&e.stop();else if(t==33&&!e.shiftKey&&!e.ctrlKey&&!gecko)this.pageUp()&&e.stop();else if(t==34&&!e.shiftKey&&!e.ctrlKey&&!gecko)this.pageDown()&&e.stop();else if((t==219||t==221)&&e.ctrlKey&&!e.altKey){this.highlightParens(e.shiftKey,!0);e.stop()}else if(e.metaKey&&!e.shiftKey&&(t==37||t==39)){var r=select.selectionTopNode(this.container);if(r===!1||!this.container.firstChild)return;if(t==37)select.focusAfterNode(i(r),this.container);else{var o=s(r,this.container);select.focusAfterNode(o?o.previousSibling:this.container.lastChild,this.container)}e.stop()}else if((e.ctrlKey||e.metaKey)&&!e.altKey)if(e.shiftKey&&t==90||t==89){select.scrollToNode(this.history.redo());e.stop()}else if(t==90||safari&&t==8){select.scrollToNode(this.history.undo());e.stop()}else if(t==83&&this.options.saveFunction){this.options.saveFunction();e.stop()}else t==86&&!mac&&this.reroutePasteEvent()},keyPress:function(e){var t=this.options.electricChars&&a.Parser.electricChars,n=this;if(this.frozen&&(!this.keyFilter||this.keyFilter(e.keyCode||e.code,e))||e.code==13||e.code==9&&this.options.tabMode!="default"||e.code==32&&e.shiftKey&&this.options.tabMode=="default")e.stop();else if(mac&&(e.ctrlKey||e.metaKey)&&e.character=="v")this.reroutePasteEvent();else if(t&&t.indexOf(e.character)!=-1)parent.setTimeout(function(){n.indentAtCursor(null)},0);else if(brokenOpera){if(e.code==8){var r=select.selectionTopNode(this.container),n=this,i=r?r.nextSibling:this.container.firstChild;r!==!1&&i&&isBR(i)&&parent.setTimeout(function(){select.selectionTopNode(n.container)==i&&select.focusAfterNode(i.previousSibling,n.container)},20)}else if(e.code==46){var r=select.selectionTopNode(this.container),n=this;r&&isBR(r)&&parent.setTimeout(function(){select.selectionTopNode(n.container)!=r&&select.focusAfterNode(r,n.container)},20)}}else if(slowWebkit){var r=select.selectionTopNode(this.container),i=r?r.nextSibling:this.container.firstChild;if(r&&i&&isBR(i)&&!isBR(r)){var s=document.createTextNode("​");this.container.insertBefore(s,i);parent.setTimeout(function(){s.nodeValue=="​"?removeElement(s):s.nodeValue=s.nodeValue.replace("​","")},20)}}webkit&&!this.options.textWrapping&&setTimeout(function(){var e=select.selectionTopNode(n.container,!0);e&&e.nodeType==3&&e.previousSibling&&isBR(e.previousSibling)&&e.nextSibling&&isBR(e.nextSibling)&&e.parentNode.replaceChild(document.createElement("BR"),e.previousSibling)},50)},keyUp:function(e){this.cursorActivity(f(e.keyCode))},indentLineAfter:function(e,t){function n(e){var t=e?e.nextSibling:r.container.firstChild;return!t||!hasClass(t,"whitespace")?null:t}var r=this,s=n(e),o=0,u=s?s.currentText.length:0,f=s?s.nextSibling:e?e.nextSibling:this.container.firstChild;if(t=="keep"){if(e){var l=n(i(e.previousSibling));l&&(o=l.currentText.length)}}else{var c=e&&f&&f.currentText?f.currentText:"";t!=null&&this.options.tabMode=="shift"?o=t?u+indentUnit:Math.max(0,u-indentUnit):e?o=e.indentation(c,u,t,f):a.Parser.firstIndentation&&(o=a.Parser.firstIndentation(c,u,t,f))}var h=o-u;if(h<0)if(o==0){f&&select.snapshotMove(s.firstChild,f.firstChild||f,0);removeElement(s);s=null}else{select.snapshotMove(s.firstChild,s.firstChild,h,!0);s.currentText=makeWhiteSpace(o);s.firstChild.nodeValue=s.currentText}else if(h>0)if(s){s.currentText=makeWhiteSpace(o);s.firstChild.nodeValue=s.currentText;select.snapshotMove(s.firstChild,s.firstChild,h,!0)}else{s=makePartSpan(makeWhiteSpace(o));s.className="whitespace";e?insertAfter(s,e):this.container.insertBefore(s,this.container.firstChild);select.snapshotMove(f&&(f.firstChild||f),s.firstChild,o,!1,!0)}else s&&select.snapshotMove(s.firstChild,s.firstChild,o,!1);h!=0&&this.addDirtyNode(e)},highlightAtCursor:function(){var e=select.selectionTopNode(this.container,!0),t=select.selectionTopNode(this.container,!1);if(e===!1||t===!1)return!1;select.markSelection();if(this.highlight(e,s(t,this.container),!0,20)===!1)return!1;select.selectMarked();return!0},handleTab:function(e){this.options.tabMode=="spaces"?select.insertTabAtCursor():this.reindentSelection(e)},home:function(){var e=select.selectionTopNode(this.container,!0),t=e;if(e===!1||!(!e||e.isPart||isBR(e))||!this.container.firstChild)return!1;while(e&&!isBR(e))e=e.previousSibling;var n=e?e.nextSibling:this.container.firstChild;n&&n!=t&&n.isPart&&hasClass(n,"whitespace")?select.focusAfterNode(n,this.container):select.focusAfterNode(e,this.container);select.scrollToCursor(this.container);return!0},end:function(){var e=select.selectionTopNode(this.container,!0);if(e===!1)return!1;e=s(e,this.container);if(!e)return!1;select.focusAfterNode(e.previousSibling,this.container);select.scrollToCursor(this.container);return!0},pageUp:function(){var e=this.cursorPosition().line,t=this.visibleLineCount();if(e===!1||t===!1)return!1;t-=2;for(var n=0;n<t;n++){e=this.prevLine(e);if(e===!1)break}if(n==0)return!1;select.setCursorPos(this.container,{node:e,offset:0});select.scrollToCursor(this.container);return!0},pageDown:function(){var e=this.cursorPosition().line,t=this.visibleLineCount();if(e===!1||t===!1)return!1;t-=2;for(var n=0;n<t;n++){var r=this.nextLine(e);if(r===!1)break;e=r}if(n==0)return!1;select.setCursorPos(this.container,{node:e,offset:0});select.scrollToCursor(this.container);return!0},scheduleParenHighlight:function(){this.parenEvent&&parent.clearTimeout(this.parenEvent);var e=this;this.parenEvent=parent.setTimeout(function(){e.highlightParens()},300)},highlightParens:function(e,t){function i(e,t){if(!e)return;if(!r){e.style.fontWeight="bold";e.style.color=t?"#8F8":"#F88"}else r.call?r(e,t):e.className+=" "+r[t?0:1]}function o(e){if(!e)return;if(r&&!r.call)removeClass(removeClass(e,r[0]),r[1]);else if(n.options.unmarkParen)n.options.unmarkParen(e);else{e.style.fontWeight="";e.style.color=""}}function u(e){if(e.currentText){var t=e.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/);return t&&t[1]}}function a(e){return/[\(\[\{]/.test(e)}function d(){var e=[],t,n=!0;for(var r=l;r;r=h?r.nextSibling:r.previousSibling)if(r.className==c&&isSpan(r)&&(t=u(r))){a(t)==h?e.push(t):e.length?e.pop()!=matching[t]&&(n=!1):n=!1;if(!e.length)break}else if(r.dirty||!isSpan(r)&&!isBR(r))return{node:r,status:"dirty"};return{node:r,status:r&&n}}var n=this,r=this.options.markParen;typeof r=="string"&&(r=[r,r]);if(!t&&n.highlighted){o(n.highlighted[0]);o(n.highlighted[1])}if(!window||!window.parent||!window.select)return;this.parenEvent&&parent.clearTimeout(this.parenEvent);this.parenEvent=null;var f,l=select.selectionTopNode(this.container,!0);if(!l||!this.highlightAtCursor())return;l=select.selectionTopNode(this.container,!0);if(!l||!((f=u(l))||(l=l.nextSibling)&&(f=u(l))))return;var c=l.className,h=a(f),p=matching[f];for(;;){var v=d();if(v.status=="dirty"){this.highlight(v.node,s(v.node));v.node.dirty=!1;continue}i(l,v.status);i(v.node,v.status);t?parent.setTimeout(function(){o(l);o(v.node)},500):n.highlighted=[l,v.node];e&&v.node&&select.focusAfterNode(v.node.previousSibling,this.container);break}},indentAtCursor:function(e){if(!this.container.firstChild)return;if(!this.highlightAtCursor())return;var t=select.selectionTopNode(this.container,!1);if(t===!1)return;select.markSelection();this.indentLineAfter(i(t),e);select.selectMarked()},indentRegion:function(e,t,n){var r=e=i(e),o=e&&i(e.previousSibling);isBR(t)||(t=s(t,this.container));this.addDirtyNode(e);do{var u=s(r,this.container);r&&this.highlight(o,u,!0);this.indentLineAfter(r,n);o=r;r=u}while(r!=t);select.setCursorPos(this.container,{node:e,offset:0},{node:t,offset:0})},cursorActivity:function(e){if(this.unloaded){window.document.designMode="off";window.document.designMode="on";this.unloaded=!1}if(internetExplorer){this.container.createTextRange().execCommand("unlink");clearTimeout(this.saveSelectionSnapshot);var t=this;this.saveSelectionSnapshot=setTimeout(function(){var e=select.getBookmark(t.container);e&&(t.selectionSnapshot=e)},200)}var n=this.options.onCursorActivity;if(!e||n){var r=select.selectionTopNode(this.container,!1);if(r===!1||!this.container.firstChild)return;r=r||this.container.firstChild;n&&n(r);if(!e){this.scheduleHighlight();this.addDirtyNode(r)}}},reparseBuffer:function(){forEach(this.container.childNodes,function(e){e.dirty=!0});this.container.firstChild&&this.addDirtyNode(this.container.firstChild)},addDirtyNode:function(e){e=e||this.container.firstChild;if(!e)return;for(var t=0;t<this.dirty.length;t++)if(this.dirty[t]==e)return;e.nodeType!=3&&(e.dirty=!0);this.dirty.push(e)},allClean:function(){return!this.dirty.length},scheduleHighlight:function(){var e=this;parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=parent.setTimeout(function(){e.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){while(this.dirty.length>0){var e=this.dirty.pop();try{while(e&&e.parentNode!=this.container)e=e.parentNode;if(e&&(e.dirty||e.nodeType==3))return e}catch(t){}}return null},highlightDirty:function(e){if(!window||!window.parent||!window.select)return!1;this.options.readOnly||select.markSelection();var t,n=e?null:o()+this.options.passTime;while((o()<n||e)&&(t=this.getDirtyNode())){var r=this.highlight(t,n);r&&r.node&&r.dirty&&this.addDirtyNode(r.node.nextSibling)}this.options.readOnly||select.selectMarked();t&&this.scheduleHighlight();return this.dirty.length==0},documentScanner:function(e){var t=this,n=null;return function(){if(!window||!window.parent||!window.select)return;n&&n.parentNode!=t.container&&(n=null);select.markSelection();var r=t.highlight(n,o()+e,!0);select.selectMarked();var i=r?r.node&&r.node.nextSibling:null;n=n==i?null:i;t.delayScanning()}},delayScanning:function(){if(this.scanner){parent.clearTimeout(this.documentScan);this.documentScan=parent.setTimeout(this.scanner,this.options.continuousScanning)}},highlight:function(e,t,r,i){function c(e,t){return!t.reduced&&t.currentText==e.value&&t.className==e.style}function h(e,t){e.currentText=e.currentText.substring(t);e.reduced=!0}function p(e){var t=makePartSpan(e.value);t.className=e.style;return t}function d(e){if(e){var t=e.oldNextSibling;(w||t===undefined||e.nextSibling!=t)&&u.history.touch(e);e.oldNextSibling=e.nextSibling}else{var t=u.container.oldFirstChild;(w||t===undefined||u.container.firstChild!=t)&&u.history.touch(null);u.container.oldFirstChild=u.container.firstChild}}function y(e){return(e.previousSibling==null||isBR(e.previousSibling))&&(e.nextSibling==null||isBR(e.nextSibling))}var s=this.container,u=this,f=this.options.activeTokens,l=typeof t=="number"?t:null;if(!s.firstChild)return!1;while(e&&(!e.parserFromHere||e.dirty)){if(i!=null&&isBR(e)&&--i<0)return!1;e=e.previousSibling}if(e&&!e.nextSibling)return!1;var v=n(e?e.nextSibling:s.firstChild),m=stringStream(v),g=e?e.parserFromHere(m):a.Parser.make(m),b={current:null,get:function(){this.current||(this.current=v.nodes.shift());return this.current},next:function(){this.current=null},remove:function(){s.removeChild(this.get());this.current=null},getNonEmpty:function(){var e=this.get();while(e&&isSpan(e)&&e.currentText=="")if(window.opera&&y(e)){this.next();e=this.get()}else{var t=e;this.remove();e=this.get();select.snapshotMove(t.firstChild,e&&(e.firstChild||e),0)}return e}},w=!1,E=!0,S=0;forEach(g,function(n){var i=b.getNonEmpty();if(n.value=="\n"){if(!isBR(i))throw"Parser out of sync. Expected BR.";if(i.dirty||!i.indentation)w=!0;d(e);e=i;i.parserFromHere=g.copy();i.indentation=n.indentation||alwaysZero;i.dirty=!1;if(l==null&&i==t)throw StopIteration;if(l!=null&&o()>=l||!w&&!E&&S>1&&!r)throw StopIteration;E=w;w=!1;S=0;b.next()}else{if(!isSpan(i))throw"Parser out of sync. Expected SPAN.";i.dirty&&(w=!0);S++;if(c(n,i)){f&&i.dirty&&f(i,n,u);i.dirty=!1;b.next()}else{w=!0;var a=p(n);s.insertBefore(a,i);f&&f(a,n,u);var v=n.value.length,m=0;while(v>0){i=b.get();var y=i.currentText.length;select.snapshotReplaceNode(i.firstChild,a.firstChild,v,m);if(y>v){h(i,v);v=0}else{v-=y;m+=y;b.remove()}}}}});d(e);webkitLastLineHack(this.container);return{node:b.getNonEmpty(),dirty:w}}};return a}();addEventHandler(window,"load",function(){var e=window.frameElement.CodeMirror,t=e.editor=new Editor(e.options);parent.setTimeout(method(e,"init"),0)});