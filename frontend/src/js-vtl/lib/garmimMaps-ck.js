// ---- extend Number object with methods for converting degrees/radians
/** Converts numeric degrees to radians */typeof Number.prototype.toRad=="undefined"&&(Number.prototype.toRad=function(){return this*Math.PI/180});typeof Number.prototype.toDeg=="undefined"&&(Number.prototype.toDeg=function(){return this*180/Math.PI});typeof Number.prototype.toPrecisionFixed=="undefined"&&(Number.prototype.toPrecisionFixed=function(e){if(isNaN(this))return"NaN";var t=this<0?-this:this,n=this<0?"-":"";if(t==0){i="0.";while(e--)i+="0";return i}var r=Math.ceil(Math.log(t)*Math.LOG10E),i=String(Math.round(t*Math.pow(10,e-r)));if(r>0){l=r-i.length;while(l-->0)i+="0";r<i.length&&(i=i.slice(0,r)+"."+i.slice(r))}else{while(r++<0)i="0"+i;i="0."+i}return n+i});typeof String.prototype.trim=="undefined"&&(String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")});if(Garmin==undefined)var Garmin={};Garmin.Map==undefined&&(Garmin.Map={});Garmin.Map.Utils={MEASURE_STATUTE:"statute",RADIUS_KILOMETERS:6371,RADIUS_MILES:3959,FEET_PER_METER:3.28083989501312,MARKER:"marker-",POLYLINE:"polyline-",LAP_MARKER_URL:"/image/map/lap-marker-",SHADOW_URL:"/api/activity-search/style/explore/images/pin-shadow.png",METRIC:"metric",GEO_OFFSET:7e-5,GEO_BUFFER:7e-5,BUSY_DIV_ID:"loading-mask",MAP_CUSTOM_CONTROLS:"custom-map-controls",MAP_CNTL_ZOOM_IN:"map_control_zoom_in",MAP_CNTL_ZOOM_OUT:"map_control_zoom_out",MAP_STYLE_ROAD:"road",MAP_STYLE_SATELLITE:"satellite",MAP_STYLE_HYBRID:"hybrid",MAP_STYLE_AUTO:"auto",MAP_STYLE_TERRAIN:"terrain",MAP_STYLE_BICYCLE:"bicycle",MAP_STYLE_OSM:"osm",PROVIDER_TYPE_BING:"bing",PROVIDER_TYPE_GOOGLE:"google",PROVIDER_TYPE_OSM:"osm",PROVIDER_TYPE_MOCK:"mock",MAXIMUM_ELEVATION_SAMPLES:512,MAXIMUM_ELEVATION_PATH_POINTS:375,LINE_COLOR:[255,0,0],LINE_OPACITY:.8,LINE_WIDTH:4,EVENT_MARKER_CHANGED:"changed",EVENT_MOUSE_CLICK:"click",EVENT_MOUSE_DBLCLICK:"doubleclick",EVENT_MOUSE_DOWN:"mousedown",EVENT_MOUSE_OUT:"mouseout",EVENT_MOUSE_OVER:"mouseover",EVENT_MOUSE_UP:"mouseup",EVENT_MOUSE_RIGHT_CLICK:"rightclick",EVENT_MAP_VIEW_CHANGE_START:"viewchangestart",EVENT_MAP_VIEW_CHANGE_END:"viewchangeend",EVENT_MAP_ZOOM_CHANGED:"zoomchanged",EVENT_MAP_IDLE:"idle",EVENT_DRAG_START:"dragstart",EVENT_DRAG_END:"dragend",EVENT_DRAGGING:"dragging",EVENT_TARGET_MAP:"map",EVENT_TARGET_MARKER:"marker",EVENT_TARGET_POLYLINE:"polyline",EVENT_TOGGLE_HEATMAP_ITEMS:"toggleHeatmapItems",LAYER_POLYLINES:"polylineLayer",LAYER_TERMINUS:"terminusLayer",LAYER_MARKERS:"markerLayer",LAYER_DISTANCE_CLOSE:"distanceLayerClose",LAYER_DISTANCE_MEDIUM:"distanceLayerMedium",LAYER_DISTANCE_FAR:"distanceLayerFar",LAYER_DISTANCE_MAX:"distanceLayerMax",heatmapPreferences:null,heatmapFolderDataList:null,heatmapRenderedTileDataList:new Object,activityType:"",findMinMaxPoints:function(e){if(typeof e!="undefined"&&e!=null&&e.length>0){var t=0,n=0,r=null,i=null,s=null,o=null,u=null;for(var a=0;a<e.length;a++){u=e[a];t+=u.lat;n+=u.lon;if(s==null||u.lat>s)s=u.lat;if(r==null||u.lat<r)r=u.lat;if(o==null||u.lon>o)o=u.lon;if(i==null||u.lon<i)i=u.lon}var f={minimum:new Garmin.Map.Point(r,i),maximum:new Garmin.Map.Point(s,o),center:new Garmin.Map.Point(t/e.length,n/e.length)}}return f},calculateDistanceOfPoints:function(e,t){var n=0;if(typeof e!="undefined"){var r,i,s=e.length-1;for(var o=0;o<s;o++){r=e[o];i=e[o+1];n+=this.calculateDistanceBetweenPoints(r,i,t)}}return n},calculateDistanceBetweenPoints:function(e,t,n){if(typeof e=="undefined")throw"point 1 is required";if(typeof t=="undefined")throw"point 2 is required";var r=Garmin.Map.Utils.RADIUS_MILES;n&&(r=Garmin.Map.Utils.RADIUS_KILOMETERS);var i=(t.lat-e.lat).toRad(),s=(t.lon-e.lon).toRad(),o=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.lat.toRad())*Math.cos(t.lat.toRad())*Math.sin(s/2)*Math.sin(s/2),u=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return r*u},calculateBearingOfPoints:function(e,t){if(typeof e=="undefined")throw"start is required";if(typeof t=="undefined")throw"end is required";var n=e.lat.toRad(),r=t.lat.toRad(),i=(t.lon-e.lon).toRad(),s=Math.sin(i)*Math.cos(r),o=Math.cos(n)*Math.sin(r)-Math.sin(n)*Math.cos(r)*Math.cos(i);return Math.atan2(s,o).toDeg()},calculateDestinationPoint:function(e,t,n,r){if(typeof e=="undefined")throw"point 1 is required";if(typeof t=="undefined")throw"Distance is required";if(typeof n=="undefined")throw"Bearing is required";var i=Garmin.Map.Utils.RADIUS_MILES;r&&(i=Garmin.Map.Utils.RADIUS_KILOMETERS);var s=n.toRad(),o=e.lat.toRad(),u=e.lon.toRad(),a=t/i,f=Math.asin(Math.sin(o)*Math.cos(a)+Math.cos(o)*Math.sin(a)*Math.cos(s)),l=u+Math.atan2(Math.sin(s)*Math.sin(a)*Math.cos(o),Math.cos(a)-Math.sin(o)*Math.sin(f));l=(l+3*Math.PI)%(2*Math.PI)-Math.PI;return new Garmin.Map.Point(f.toDeg(),l.toDeg())},isExactlyBetweenPoints:function(e,t,n){typeof buffer=="undefined"&&(buffer=0);var r=!1,i=!1;e.lat<n.lat?r=e.lat<=t.lat&&t.lat<=n.lat:r=e.lat>=t.lat&&t.lat>=n.lat;e.lon<n.lon?i=e.lon<=t.lon&&t.lon<=n.lon:i=e.lon>=t.lon&&t.lon>=n.lon;return r&&i},isRoughlyBetweenPoints:function(e,t,n,r){typeof r=="undefined"&&(r=0);var i=!1,s=!1;e.lat<n.lat?i=e.lat<=t.lat&&t.lat<=n.lat:i=e.lat>=t.lat&&t.lat>=n.lat;e.lon<n.lon?s=e.lon<=t.lon&&t.lon<=n.lon:s=e.lon>=t.lon&&t.lon>=n.lon;var o=r,u=r*2;if(!i||!s){var a=0,f=0;if(!s){a=Math.abs(e.lon-t.lon);f=Math.abs(n.lon-t.lon);s=a<u&&f<u}else if(!i){a=Math.abs(e.lat-t.lat);f=Math.abs(n.lat-t.lat);i=a<o&&f<o}}return i&&s},decodeLine:function(e){var t=0,n=[],r=0,i=0;if(e&&e!=undefined){var s=e.length;while(t<s){var o,u=0,a=0;do{o=e.charCodeAt(t++)-63;a|=(o&31)<<u;u+=5}while(o>=32);var f=a&1?~(a>>1):a>>1;r+=f;u=0;a=0;do{o=e.charCodeAt(t++)-63;a|=(o&31)<<u;u+=5}while(o>=32);var l=a&1?~(a>>1):a>>1;i+=l;n.push([r*1e-5,i*1e-5])}}return n},calculateTime:function(e,t){return e==0||t==0?0:e/t},calculateSpeed:function(e,t){return e==0||t==0?0:e/t},formatTime:function(e){e=Math.round(e);var t=new Array,n=Math.floor(e/3600);if(n>0){t.push(n);t.push(":")}var r=Math.floor((e-n*3600)/60);r<10&&e>=3600&&t.push(0);t.push(r);t.push(":");var i=Math.floor(e-n*3600-r*60);i<10&&t.push(0);i.length>2&&(i=i.substring(2));t.push(i);return t.join("")},formatFloat:function(e,t){var n="";if(typeof e!="undefined"){n=e.toFixed(2);var r=n.substr(n.length-1);if(r=="0"){n=n.substr(0,n.length-1);r=n.substr(n.length-1)}}return typeof t=="undefined"||t!="decimal_comma"?this.addNumberSeparators(n,",","."):this.addNumberSeparators(n,".",",")},formatSpeed:function(e,t){var n="";typeof e!="undefined"&&(n=e.toFixed(1));return typeof t=="undefined"||t!="decimal_comma"?this.addNumberSeparators(n,",","."):this.addNumberSeparators(n,".",",")},addNumberSeparators:function(e,t,n){var r;e+="";r=e.split(".");var i=r[0],s=r.length>1?n+r[1]:"",o=/(\d+)(\d{3})/;while(o.test(i))i=i.replace(o,"$1"+t+"$2");return i+s},getCityFolderMatchesForBoundingBoxAndActivityType:function(e,t,n,r,i,s,o){if(Garmin.Map.Utils.heatmapFolderDataList==null){Garmin.Map.Utils.heatmapPreferences==null&&Garmin.Map.Utils.getHeatMapPreferences();Garmin.Map.Utils.heatmapFolderDataList=Garmin.Map.Utils.getAllHeatMapFolderData(Garmin.Map.Utils.heatmapPreferences.heatmapActiveVersion)}var u="",a=new Array;if(Garmin.Map.Utils.heatmapFolderDataList!=null&&Garmin.Map.Utils.heatmapFolderDataList.length>0)for(var f=0;f<Garmin.Map.Utils.heatmapFolderDataList.length;f++){var l=Garmin.Map.Utils.heatmapFolderDataList[f],c=new Garmin.Map.Point(l.boundBoxNWLatitude,l.boundBoxNWLongitude,0),h=new Garmin.Map.Point(l.boundBoxSELatitude,l.boundBoxSELongitude,0);if(a.size()<3&&l.activityType==n&&Garmin.Map.Utils.doBoundingBoxesIntersect(e,t,c,h))if(r){if(Garmin.Map.Utils.doTileCoordindatesHaveRenderedTilesForFolderName(i,s,o,l.folderName,l.folderId)){u=l.folderName;a.push(u)}}else{u=l.folderName;a.push(u)}}return a},getCityFolderMatchesForLocationAndActivityType:function(e,t,n,r,i){var s=Garmin.Map.Utils.minPointToLatLng(e,t,n),o=Garmin.Map.Utils.maxPointToLatLng(e,t,n),u=new Garmin.Map.Point(s.lat(),s.lng(),0),a=new Garmin.Map.Point(o.lat(),o.lng(),0);return Garmin.Map.Utils.getCityFolderMatchesForBoundingBoxAndActivityType(u,a,r,i,e,t,n)},getGlobalFolderMatchesForLocationAndActivityType:function(e,t,n,r,i){if(Garmin.Map.Utils.heatmapFolderDataList==null){Garmin.Map.Utils.heatmapPreferences==null&&Garmin.Map.Utils.getHeatMapPreferences();Garmin.Map.Utils.heatmapFolderDataList=Garmin.Map.Utils.getAllHeatMapFolderData(Garmin.Map.Utils.heatmapPreferences.heatmapActiveVersion)}var s="",o=new Array;if(Garmin.Map.Utils.heatmapFolderDataList!=null&&Garmin.Map.Utils.heatmapFolderDataList.length>0)for(var u=0;u<Garmin.Map.Utils.heatmapFolderDataList.length;u++){var a=Garmin.Map.Utils.heatmapFolderDataList[u];if(o.size()<3&&a.activityType==r&&a.boundBoxNWLatitude==0)if(i){if(Garmin.Map.Utils.doTileCoordindatesHaveRenderedTilesForFolderName(e,t,n,a.folderName,a.folderId)){s=a.folderName;o.push(s)}}else{s=a.folderName;o.push(s)}}return o},doTileCoordindatesHaveRenderedTilesForFolderName:function(e,t,n,r,i){var s=!1;Garmin.Map.Utils.heatmapRenderedTileDataList[i]==null&&(Garmin.Map.Utils.heatmapRenderedTileDataList[i]=Garmin.Map.Utils.getHeatMapRenderedTileDataForFolder(r));if(Garmin.Map.Utils.heatmapRenderedTileDataList[i]!=null&&Garmin.Map.Utils.heatmapRenderedTileDataList[i].length>0)for(var o=0;o<Garmin.Map.Utils.heatmapRenderedTileDataList[i].length;o++){var u=Garmin.Map.Utils.heatmapRenderedTileDataList[i][o];if(u.tileZoomLevel==n&&u.tileXCoordinate==e&&u.tileYCoordinate==t){s=!0;return s}}return s},populateTileUrls:function(e,t,n,r,i){if(e!=null&&e.size()>0){if(e[2]!=null){var s=t+Garmin.Map.Utils.heatmapPreferences.heatmapActiveVersion+"/"+e[2]+"/"+n+"/tile_"+r.x+"_"+r.y+".png";i.push(s)}if(e[1]!=null){var o=t+Garmin.Map.Utils.heatmapPreferences.heatmapActiveVersion+"/"+e[1]+"/"+n+"/tile_"+r.x+"_"+r.y+".png";i.push(o)}if(e[0]!=null){var u=t+Garmin.Map.Utils.heatmapPreferences.heatmapActiveVersion+"/"+e[0]+"/"+n+"/tile_"+r.x+"_"+r.y+".png";i.push(u)}}},getHeatMapPreferences:function(){jQuery.ajax({type:"GET",contentType:"application/json",async:!1,url:"/proxy/image-service/heatmapservice/heatmap/pref",cache:!0,success:function(e,t){Garmin.Map.Utils.heatmapPreferences=e},error:function(e,t,n){e.status!=401&&Garmin.Map.Utils.log("Error finding heatmap preference data. Status=",e.status,", status text=",e.statusText)}});return Garmin.Map.Utils.heatmapPreferences},getAllHeatMapFolderData:function(e){var t=null;jQuery.ajax({type:"GET",contentType:"application/json",async:!1,url:"/proxy/image-service/heatmapservice/heatmap/folders/"+e+"?"+e,cache:!0,success:function(e,n){t=e},error:function(t,n,r){Garmin.Map.Utils.log("Error finding heatmap folder data for version=",e,". Status=",t.status,", status text=",t.statusText)}});return t},getHeatMapRenderedTileDataForFolder:function(e){var t=null;jQuery.ajax({type:"GET",contentType:"application/json",async:!1,url:"/proxy/image-service/heatmapservice/heatmap/tiles/"+e+"?"+Garmin.Map.Utils.heatmapPreferences.heatmapActiveVersion,cache:!0,success:function(e,n){t=e},error:function(t,n,r){Garmin.Map.Utils.log("Error finding heatmap rendered tile data for foldername=",e,". Status=",t.status,", status text=",t.statusText)}});return t},log:function(){if(typeof console!="undefined"&&typeof console.log!="undefined")if(jQuery.browser.msie){var e="";for(var t=0;t<arguments.length;t++)e+=arguments[t]+", ";e=e.substring(0,e.length-2);console.log(e)}else console.log(arguments)},getHeatMapUrls:function(e,t,n){var r=Garmin.Map.Utils.getNormalizedCoord(e,t,n);if(!r)return null;var i=new Array,s=Garmin.Map.Utils.heatmapPreferences.s3Url+Garmin.Map.Utils.heatmapPreferences.heatmapBaseBucketName+"/";if(n>=Garmin.Map.Utils.heatmapPreferences.heatmapCityZoomLevelStart){var o=Garmin.Map.Utils.getCityFolderMatchesForLocationAndActivityType(e,t,n,Garmin.Map.Utils.activityType,Garmin.Map.Utils.heatmapPreferences.performRenderedTileCheck);Garmin.Map.Utils.populateTileUrls(o,s,n,r,i)}else if(n>=Garmin.Map.Utils.heatmapPreferences.heatmapGlobalZoomLevelStart){var u=Garmin.Map.Utils.getGlobalFolderMatchesForLocationAndActivityType(e,t,n,Garmin.Map.Utils.activityType,Garmin.Map.Utils.heatmapPreferences.performRenderedTileCheck);Garmin.Map.Utils.populateTileUrls(u,s,n,r,i)}return i},getNormalizedCoord:function(e,t,n){var r=1<<n;if(t<0||t>=r)return null;if(e<0||e>=r)e=(e%r+r)%r;return{x:e,y:t}},doBoundingBoxesIntersect:function(e,t,n,r){var i=Math.abs(e.lon+t.lon-n.lon-r.lon),s=Math.abs(e.lat+t.lat-n.lat-r.lat),o=t.lon-e.lon+r.lon-n.lon,u=e.lat-t.lat+n.lat-r.lat;return i<=o&&s<=u?!0:!1},minPointToLatLng:function(e,t,n){var r=e*256,i=t*256;return Garmin.Map.Utils.fromPointToLatLng(r,i,n)},maxPointToLatLng:function(e,t,n){var r=(e+1)*256-1,i=(t+1)*256-1;return Garmin.Map.Utils.fromPointToLatLng(r,i,n)},fromPointToLatLng:function(e,t,n){var r=Garmin.Map.Utils.mapSize(n),i=Garmin.Map.Utils.clip(e,0,r-1)/r-.5,s=.5-Garmin.Map.Utils.clip(t,0,r-1)/r,o=(90-360*Math.atan(Math.exp(-s*2*Math.PI))/Math.PI).toFixed(3),u=(360*i).toFixed(3);return new google.maps.LatLng(o,u)},mapSize:function(e){var t=256<<e>>>0;return t},clip:function(e,t,n){return Math.min(Math.max(e,t),n)}};